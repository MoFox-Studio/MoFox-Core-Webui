import{a as es,r,D as j,m as ls,c as l,g as i,l as ns,e as s,t as o,n as w,F as O,h as X,s as os,M as is,at as Gs,au as xs,av as Us,o as t,aw as Ts,ax as Ss,_ as as,S as ts,N as Ds,L as ks,ay as Is,az as Bs,a7 as Z,aA as Vs,aB as Ms,aC as Rs,aD as Ls,aE as Ws,aF as Es,O as ss,U as Ns,Q as Ps,aG as Fs,aH as zs,f as K,T as ys,w as hs,a6 as As,R as ds}from"./index-I9RjNgOI.js";import{s as Y,a as q,b as B}from"./dialog-uFGN60Yn.js";import{r as Os}from"./dashboard-wj8JnAE3.js";import"./ConfirmDialog-Dj_lrOS5.js";import"./iconify-qO0l4mWU.js";const Xs={class:"ui-update-tab"},Hs={key:0,class:"m3-card disabled-card"},Qs={class:"disabled-content"},js={class:"disabled-text"},qs={key:1,class:"m3-card version-card"},Js={key:0,class:"version-info"},Ks={class:"info-row"},Ys={class:"info-value version"},Zs={key:0,class:"info-row"},se={class:"info-value"},ee={key:1,class:"info-row"},ae={class:"info-value branch"},te={key:2,class:"info-row"},le={class:"info-value commit"},ne={key:1,class:"version-info"},oe={key:2,class:"m3-card update-check-card"},ie={class:"card-header"},de=["disabled"],ue={key:0,class:"update-result"},re={key:0,class:"has-update"},ce={class:"update-badge"},ve={key:0,class:"changelog"},me={class:"update-actions"},pe=["disabled"],_e={key:1,class:"up-to-date"},fe={key:1,class:"error-message"},be={key:3,class:"m3-card backup-card"},ge={class:"card-header"},ye=["disabled"],he={key:0,class:"backup-list"},ke={class:"backup-info"},$e={class:"backup-header"},we={class:"backup-commit"},Ce={key:0,class:"backup-version"},Ge={key:1,class:"current-badge"},xe={class:"backup-message"},Ue={class:"backup-meta"},Te={class:"backup-actions"},Se=["onClick","disabled"],De=["onClick","disabled"],Ie={key:1,class:"no-backups"},Be={class:"detail-dialog"},Ve={class:"detail-header"},Me={key:0,class:"detail-content"},Re={class:"detail-section"},Le={class:"detail-row"},We={class:"detail-value"},Ee={key:0,class:"detail-row"},Ne={class:"detail-value version-tag"},Pe={class:"detail-row"},Fe={class:"detail-value"},ze={key:1,class:"detail-row"},Ae={class:"detail-value"},Oe={key:0,class:"detail-section"},Xe={class:"commit-message"},He={key:1,class:"detail-section"},Qe={class:"commit-body"},je={key:2,class:"detail-section"},qe={class:"files-list"},Je={class:"file-path"},Ke={key:0,class:"files-more"},Ye={key:1,class:"detail-content loading"},Ze=es({__name:"UIUpdateTab",emits:["update-complete"],setup(L,{expose:H,emit:v}){const y=v,c=r(null),h=r([]),f=r(!1),S=r(!1),x=r(!1),C=r(!1),p=r(""),U=r(!1),_=r(!1),b=r(null),G=j(()=>c.value?{version:c.value.current_version||"未安装",build_time:null,branch:c.value.current_branch,commit:c.value.current_commit}:null),W=j(()=>c.value?c.value.update_enabled===!1:!1),P=j(()=>c.value?c.value.message?c.value.message:c.value.update_enabled===!1?`当前分支为 "${c.value.current_branch||"未知"}"，更新功能已禁用。仅 webui-dist 分支支持自动更新。`:"":"");function F(d){if(!d)return"-";try{return new Date(d).toLocaleString("zh-CN")}catch{return d}}async function R(){f.value=!0,p.value="";try{const d=await Gs();d.success&&d.data?(c.value=d.data,d.data.success||(p.value=d.data.error||"获取状态失败")):p.value=d.error||"获取状态失败"}catch(d){p.value=d.message||"获取状态失败"}finally{f.value=!1}}async function z(){await R()}async function m(){var n,T;if(await Y({title:"确认更新",message:"更新 UI 将刷新页面，是否继续？",confirmText:"更新"})){S.value=!0,p.value="";try{const D=await xs();D.success&&((n=D.data)!=null&&n.success)?(q(`更新成功！已更新到 ${D.data.version||"最新版本"}`),y("update-complete",!0)):B(((T=D.data)==null?void 0:T.error)||D.error||"更新失败")}catch(D){B(D.message||"更新失败")}finally{S.value=!1}}}async function a(){var d;C.value=!0;try{const n=await Us();n.success&&((d=n.data)!=null&&d.data)&&(h.value=n.data.data)}catch(n){console.error("加载备份列表失败:",n)}finally{C.value=!1}}async function k(d){var D,g;const n=d.substring(0,7);if(await Y({title:"确认回滚",message:`确定要回滚到版本 "${n}" 吗？此操作将重置到该版本。`,confirmText:"回滚"})){x.value=!0;try{const M=await Ts(d);M.success&&((D=M.data)!=null&&D.success)?(q(M.data.message||"回滚成功"),y("update-complete",!0)):B(((g=M.data)==null?void 0:g.error)||M.error||"回滚失败")}catch(M){B(M.message||"回滚失败")}finally{x.value=!1}}}async function V(d){U.value=!0,_.value=!0,b.value=null;try{const n=await Ss(d);n.success&&n.data?b.value=n.data:(B(n.error||"获取详情失败"),U.value=!1)}catch(n){B(n.message||"获取详情失败"),U.value=!1}finally{_.value=!1}}function E(d){return{新增:"status-add",修改:"status-modify",删除:"status-delete",重命名:"status-rename"}[d]||""}return ls(()=>{R(),a()}),H({refresh:()=>{R(),a()}}),(d,n)=>{var T,D;return t(),l("div",Xs,[W.value?(t(),l("div",Hs,[s("div",Qs,[n[3]||(n[3]=s("span",{class:"material-symbols-rounded icon-warning"},"info",-1)),s("div",js,[n[2]||(n[2]=s("h4",null,"更新功能已禁用",-1)),s("p",null,o(P.value),1)])])])):i("",!0),W.value?i("",!0):(t(),l("div",qs,[n[9]||(n[9]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"web"),s("h3",null,"当前版本")],-1)),G.value?(t(),l("div",Js,[s("div",Ks,[n[4]||(n[4]=s("span",{class:"info-label"},"版本号:",-1)),s("span",Ys,"v"+o(G.value.version),1)]),G.value.build_time?(t(),l("div",Zs,[n[5]||(n[5]=s("span",{class:"info-label"},"构建时间:",-1)),s("span",se,o(F(G.value.build_time)),1)])):i("",!0),G.value.branch?(t(),l("div",ee,[n[6]||(n[6]=s("span",{class:"info-label"},"分支:",-1)),s("span",ae,o(G.value.branch),1)])):i("",!0),G.value.commit?(t(),l("div",te,[n[7]||(n[7]=s("span",{class:"info-label"},"Commit:",-1)),s("code",le,o(G.value.commit.substring(0,8)),1)])):i("",!0)])):(t(),l("div",ne,[...n[8]||(n[8]=[s("p",{class:"no-version"},"未检测到版本信息",-1)])]))])),W.value?i("",!0):(t(),l("div",oe,[s("div",ie,[n[10]||(n[10]=s("span",{class:"material-symbols-rounded"},"sync",-1)),n[11]||(n[11]=s("h3",null,"检查更新",-1)),s("button",{class:"m3-button tonal",onClick:z,disabled:f.value||W.value},[s("span",{class:w(["material-symbols-rounded",{spinning:f.value}])},o(f.value?"progress_activity":"refresh"),3),s("span",null,o(f.value?"检查中...":"检查更新"),1)],8,de)]),c.value&&!W.value?(t(),l("div",ue,[c.value.has_update?(t(),l("div",re,[s("div",ce,[n[12]||(n[12]=s("span",{class:"material-symbols-rounded"},"auto_awesome",-1)),s("span",null,"发现新版本 v"+o(c.value.latest_version),1)]),(T=c.value.changelog)!=null&&T.length?(t(),l("div",ve,[n[13]||(n[13]=s("h4",null,"更新内容:",-1)),s("ul",null,[(t(!0),l(O,null,X(c.value.changelog.slice(0,10),(g,M)=>(t(),l("li",{key:M},o(g),1))),128))])])):i("",!0),s("div",me,[s("button",{class:"m3-button filled",onClick:m,disabled:S.value},[s("span",{class:w(["material-symbols-rounded",{spinning:S.value}])},o(S.value?"progress_activity":"download"),3),s("span",null,o(S.value?"更新中...":"立即更新"),1)],8,pe)])])):(t(),l("div",_e,[...n[14]||(n[14]=[s("span",{class:"material-symbols-rounded icon-success"},"check_circle",-1),s("span",null,"已是最新版本",-1)])]))])):i("",!0),p.value?(t(),l("div",fe,[n[15]||(n[15]=s("span",{class:"material-symbols-rounded"},"error",-1)),s("span",null,o(p.value),1)])):i("",!0)])),W.value?i("",!0):(t(),l("div",be,[s("div",ge,[n[16]||(n[16]=s("span",{class:"material-symbols-rounded"},"history",-1)),n[17]||(n[17]=s("h3",null,"历史版本",-1)),s("button",{class:"m3-icon-button",onClick:a,disabled:C.value},[s("span",{class:w(["material-symbols-rounded",{spinning:C.value}])},"refresh",2)],8,ye)]),h.value.length?(t(),l("div",he,[(t(!0),l(O,null,X(h.value,g=>(t(),l("div",{key:g.commit,class:w(["backup-item",{"is-current":g.is_current}])},[s("div",ke,[s("div",$e,[s("code",we,o(g.commit_short),1),g.version?(t(),l("span",Ce,"v"+o(g.version),1)):i("",!0),g.is_current?(t(),l("span",Ge,"当前")):i("",!0)]),s("span",xe,o(g.message),1),s("span",Ue,o(F(g.timestamp)),1)]),s("div",Te,[s("button",{class:"m3-button text",onClick:M=>V(g.commit),disabled:_.value},[...n[18]||(n[18]=[s("span",{class:"material-symbols-rounded"},"info",-1),s("span",null,"详情",-1)])],8,Se),s("button",{class:"m3-button text",onClick:M=>k(g.commit),disabled:x.value||g.is_current},[...n[19]||(n[19]=[s("span",{class:"material-symbols-rounded"},"restore",-1),s("span",null,"回滚",-1)])],8,De)])],2))),128))])):(t(),l("div",Ie,[...n[20]||(n[20]=[s("span",{class:"material-symbols-rounded"},"history_toggle_off",-1),s("span",null,"暂无历史版本",-1)])]))])),(t(),ns(is,{to:"body"},[U.value?(t(),l("div",{key:0,class:"detail-dialog-overlay",onClick:n[1]||(n[1]=os(g=>U.value=!1,["self"]))},[s("div",Be,[s("div",Ve,[n[22]||(n[22]=s("h3",null,"版本详情",-1)),s("button",{class:"m3-icon-button",onClick:n[0]||(n[0]=g=>U.value=!1)},[...n[21]||(n[21]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),b.value?(t(),l("div",Me,[s("div",Re,[s("div",Le,[n[23]||(n[23]=s("span",{class:"detail-label"},"Commit:",-1)),s("code",We,o(b.value.commit_short),1)]),b.value.version?(t(),l("div",Ee,[n[24]||(n[24]=s("span",{class:"detail-label"},"版本:",-1)),s("span",Ne,"v"+o(b.value.version),1)])):i("",!0),s("div",Pe,[n[25]||(n[25]=s("span",{class:"detail-label"},"时间:",-1)),s("span",Fe,o(F(b.value.timestamp)),1)]),b.value.author?(t(),l("div",ze,[n[26]||(n[26]=s("span",{class:"detail-label"},"作者:",-1)),s("span",Ae,o(b.value.author),1)])):i("",!0)]),b.value.message?(t(),l("div",Oe,[n[27]||(n[27]=s("h4",null,"提交消息",-1)),s("p",Xe,o(b.value.message),1)])):i("",!0),b.value.body?(t(),l("div",He,[n[28]||(n[28]=s("h4",null,"更新内容",-1)),s("pre",Qe,o(b.value.body),1)])):i("",!0),(D=b.value.files_changed)!=null&&D.length?(t(),l("div",je,[s("h4",null,"修改文件 ("+o(b.value.files_changed.length)+")",1),s("div",qe,[(t(!0),l(O,null,X(b.value.files_changed.slice(0,20),(g,M)=>(t(),l("div",{key:M,class:"file-item"},[s("span",{class:w(["file-status",E(g.status)])},o(g.status),3),s("span",Je,o(g.path),1)]))),128)),b.value.files_changed.length>20?(t(),l("div",Ke," ... 及其他 "+o(b.value.files_changed.length-20)+" 个文件 ",1)):i("",!0)])])):i("",!0)])):_.value?(t(),l("div",Ye,[...n[29]||(n[29]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):i("",!0)])])):i("",!0)]))])}}}),sa=as(Ze,[["__scopeId","data-v-da3800a9"]]);function $s(){return ts.get("git_env/status")}function ea(){return ts.post("git_env/install")}function aa(L){return ts.post("git_env/set-path",{path:L})}function ta(){return ts.post("git_env/auto-detect")}function la(){return ts.get("git_env/install-guide")}const na={class:"main-update-tab"},oa={class:"m3-card branch-card"},ia={key:0,class:"loading-placeholder"},da={key:1,class:"card-disabled-hint"},ua={key:2,class:"branch-selector"},ra={class:"selected-value"},ca={key:0,class:"m3-select-dropdown m3-card"},va=["onClick"],ma={key:0,class:"material-symbols-rounded check-icon"},pa={key:0,class:"switching-indicator"},_a=["disabled","title"],fa={class:"m3-card update-card"},ba={class:"card-header"},ga=["disabled"],ya={key:0,class:"loading-placeholder"},ha={key:1,class:"alert alert-warning"},ka={key:2,class:"alert alert-warning"},$a={key:3,class:"update-result"},wa={key:0,class:"has-update"},Ca={class:"update-header"},Ga={class:"update-title"},xa={class:"version-compare"},Ua={class:"version-box version-current"},Ta={class:"version-box version-latest"},Sa={key:0,class:"changelog"},Da={class:"update-actions"},Ia={key:0,class:"material-symbols-rounded check-icon"},Ba=["disabled"],Va={key:1,class:"up-to-date"},Ma={class:"up-to-date-info"},Ra={key:0},La={key:4,class:"error-message"},Wa={class:"m3-card backup-card"},Ea={class:"card-header"},Na=["disabled"],Pa={key:0,class:"loading-placeholder"},Fa={key:1,class:"card-disabled-hint"},za={key:2,class:"backup-list"},Aa={class:"backup-info"},Oa={class:"backup-header"},Xa={class:"backup-commit"},Ha={key:0,class:"current-badge"},Qa={class:"backup-message"},ja={class:"backup-meta"},qa={class:"backup-actions"},Ja=["onClick","disabled"],Ka=["onClick","disabled"],Ya={key:3,class:"no-backups"},Za={class:"detail-dialog"},st={class:"detail-header"},et={key:0,class:"detail-content"},at={class:"detail-section"},tt={class:"detail-row"},lt={class:"detail-value"},nt={class:"detail-row"},ot={class:"detail-value"},it={key:0,class:"detail-row"},dt={class:"detail-value"},ut={key:0,class:"detail-section"},rt={class:"commit-message"},ct={key:1,class:"detail-section"},vt={class:"commit-body"},mt={key:2,class:"detail-section"},pt={class:"files-list"},_t={class:"file-path"},ft={key:0,class:"files-more"},bt={key:1,class:"detail-content loading"},gt=es({__name:"MainUpdateTab",emits:["update-complete"],setup(L,{expose:H,emit:v}){const y=v,c=r(null),h=r(null),f=r(null),S=r([]),x=r(""),C=r(!1),p=r(!0),U=r(!1),_=r(!1),b=r(!1),G=r(!1),W=r(!1),P=r(!1),F=r(!1),R=r(""),z=r(!1),m=r(!1),a=r(null),k=r(null);async function V(){try{const[u,e]=await Promise.all([$s(),Is()]);u.success&&u.data&&(c.value=u.data),e.success&&e.data&&(h.value=e.data,e.data.current_branch&&(x.value=e.data.current_branch))}catch(u){console.error("加载状态失败:",u)}}function E(){b.value||(C.value=!C.value)}async function d(){var u;if(!G.value){G.value=!0;try{const e=await Bs();e.success&&e.data?(h.value=e.data,e.data.current_branch&&(x.value=e.data.current_branch),Z("分支列表已刷新","success")):Z(((u=e.data)==null?void 0:u.error)||e.error||"刷新分支列表失败","error")}catch(e){Z(e.message||"刷新分支列表失败（网络可能不可用）","error")}finally{G.value=!1}}}async function n(u){var Q,N;if(C.value=!1,!(u===x.value||!await Y({title:"切换分支",message:`确定要切换到分支 "${u}" 吗？`,confirmText:"切换"}))){b.value=!0;try{const I=await Ls(u);I.success&&((Q=I.data)!=null&&Q.success)?(x.value=u,q(I.data.message||"分支切换成功"),y("update-complete",!0)):B(((N=I.data)==null?void 0:N.error)||I.error||"切换分支失败")}catch(I){B(I.message||"切换分支失败")}finally{b.value=!1}}}async function T(){U.value=!0,R.value="",f.value=null;try{const u=await Vs();u.success&&u.data?(f.value=u.data,u.data.success||(R.value=u.data.error||"检查更新失败")):R.value=u.error||"检查更新失败"}catch(u){R.value=u.message||"检查更新失败"}finally{U.value=!1}}async function D(){var Q,N;const u=z.value?"强制更新将覆盖所有本地修改，更新后需要重启才能生效，是否继续？":"更新主程序后需要重启才能生效，是否继续？";if(await Y({title:"确认更新",message:u,confirmText:"更新"})){_.value=!0,R.value="";try{const I=await Ms(z.value,!0);I.success&&((Q=I.data)!=null&&Q.success)?(q(I.data.message||"更新成功"),f.value=null,await V(),y("update-complete",!0),g()):B(((N=I.data)==null?void 0:N.error)||I.error||"更新失败")}catch(I){B(I.message||"更新失败")}finally{_.value=!1}}}async function g(){var u;P.value=!0;try{const e=await Rs();e.success&&((u=e.data)!=null&&u.data)&&(S.value=e.data.data)}catch(e){console.error("加载历史版本列表失败:",e)}finally{P.value=!1}}async function M(u){var N,I;const e=u.substring(0,7);if(await Y({title:"确认回滚",message:`确定要回滚到版本 "${e}" 吗？此操作将重置到该版本，回滚后需要重启程序。`,confirmText:"回滚"})){W.value=!0;try{const A=await Ws(u);A.success&&((N=A.data)!=null&&N.success)?(q(A.data.message||"回滚成功"),y("update-complete",!0),g()):B(((I=A.data)==null?void 0:I.error)||A.error||"回滚失败")}catch(A){B(A.message||"回滚失败")}finally{W.value=!1}}}async function ws(u){m.value=!0,F.value=!0,a.value=null;try{const e=await Es(u);e.success&&e.data?a.value=e.data:(B(e.error||"获取详情失败"),m.value=!1)}catch(e){B(e.message||"获取详情失败"),m.value=!1}finally{F.value=!1}}function us(u){if(!u)return"-";try{return new Date(u).toLocaleString("zh-CN")}catch{return u}}function Cs(u){return{新增:"status-add",修改:"status-modify",删除:"status-delete",重命名:"status-rename"}[u]||""}function rs(u){k.value&&!k.value.contains(u.target)&&(C.value=!1)}return ls(async()=>{var u,e;document.addEventListener("click",rs);try{await V(),g(),(u=c.value)!=null&&u.git_available&&((e=h.value)!=null&&e.is_git_repo)&&T()}finally{p.value=!1}}),Ds(()=>{document.removeEventListener("click",rs)}),H({refresh:()=>{V(),g(),f.value=null}}),(u,e)=>{var Q,N,I,A,cs,vs,ms,ps,_s,fs,bs,gs;return t(),l("div",na,[s("div",oa,[e[7]||(e[7]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"fork_right"),s("h3",null,"分支管理")],-1)),p.value?(t(),l("div",ia,[...e[3]||(e[3]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):!((Q=c.value)!=null&&Q.git_available)||(((I=(N=h.value)==null?void 0:N.available_branches)==null?void 0:I.length)??0)===0?(t(),l("div",da,[e[4]||(e[4]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,o((A=c.value)!=null&&A.git_available?"无可用分支":"Git 环境不可用"),1)])):(t(),l("div",ua,[e[6]||(e[6]=s("label",{class:"m3-label"},"当前分支:",-1)),s("div",{class:"select-wrapper",ref_key:"branchSelectWrapper",ref:k},[s("div",{class:w(["m3-select-trigger",{disabled:b.value,active:C.value}]),onClick:E},[s("span",ra,o(x.value),1),s("span",{class:w(["material-symbols-rounded select-arrow",{rotated:C.value}])}," arrow_drop_down ",2)],2),C.value?(t(),l("div",ca,[(t(!0),l(O,null,X(((cs=h.value)==null?void 0:cs.available_branches)??[],$=>(t(),l("div",{key:$,class:w(["m3-select-option",{selected:$===x.value}]),onClick:J=>n($)},[s("span",null,o($),1),$===x.value?(t(),l("span",ma,"check")):i("",!0)],10,va))),128))])):i("",!0)],512),b.value?(t(),l("span",pa,[...e[5]||(e[5]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),ks(" 切换中... ",-1)])])):(t(),l("button",{key:1,class:"m3-icon-button",onClick:d,disabled:G.value,title:G.value?"刷新中...":"刷新远程分支列表"},[s("span",{class:w(["material-symbols-rounded",{spinning:G.value}])},"sync",2)],8,_a))]))]),s("div",fa,[s("div",ba,[e[8]||(e[8]=s("span",{class:"material-symbols-rounded"},"sync",-1)),e[9]||(e[9]=s("h3",null,"更新检测",-1)),s("button",{class:"m3-button tonal",onClick:T,disabled:p.value||U.value||!((vs=c.value)!=null&&vs.git_available)},[s("span",{class:w(["material-symbols-rounded",{spinning:U.value}])},o(U.value?"progress_activity":"refresh"),3),s("span",null,o(U.value?"检查中...":"检查更新"),1)],8,ga)]),p.value||U.value?(t(),l("div",ya,[e[10]||(e[10]=s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1)),s("span",null,o(p.value?"加载中...":"检查更新中..."),1)])):c.value&&!c.value.git_available?(t(),l("div",ha,[...e[11]||(e[11]=[s("span",{class:"material-symbols-rounded"},"warning",-1),s("span",null,'Git 不可用，请先在"Git 设置"中配置 Git 环境',-1)])])):h.value&&!h.value.is_git_repo?(t(),l("div",ka,[...e[12]||(e[12]=[s("span",{class:"material-symbols-rounded"},"warning",-1),s("span",null,"主程序目录不是 Git 仓库，无法使用自动更新功能",-1)])])):f.value?(t(),l("div",$a,[f.value.has_update?(t(),l("div",wa,[s("div",Ca,[e[14]||(e[14]=s("div",{class:"update-icon"},[s("span",{class:"material-symbols-rounded"},"auto_awesome")],-1)),s("div",Ga,[e[13]||(e[13]=s("h4",null,"发现新版本",-1)),s("p",null,"有 "+o(f.value.commits_behind)+" 个新提交等待更新",1)])]),s("div",xa,[s("div",Ua,[e[15]||(e[15]=s("span",{class:"version-tag"},"当前",-1)),s("code",null,o(f.value.current_commit||"未知"),1)]),e[17]||(e[17]=s("span",{class:"material-symbols-rounded arrow-icon"},"arrow_forward",-1)),s("div",Ta,[e[16]||(e[16]=s("span",{class:"version-tag"},"最新",-1)),s("code",null,o(f.value.remote_commit||"未知"),1)])]),(ms=f.value.update_logs)!=null&&ms.length?(t(),l("div",Sa,[e[18]||(e[18]=s("h4",null,"更新内容:",-1)),s("ul",null,[(t(!0),l(O,null,X(f.value.update_logs.slice(0,5),($,J)=>(t(),l("li",{key:J},o($),1))),128))])])):i("",!0),s("div",Da,[s("label",{class:w(["force-update-checkbox",{disabled:_.value}]),onClick:e[0]||(e[0]=$=>!_.value&&(z.value=!z.value))},[s("div",{class:w(["custom-checkbox",{checked:z.value}])},[z.value?(t(),l("span",Ia,"check")):i("",!0)],2),e[19]||(e[19]=s("span",{class:"checkbox-label"},"强制更新（覆盖本地修改）",-1))],2),s("button",{class:"m3-button filled",onClick:D,disabled:_.value},[s("span",{class:w(["material-symbols-rounded",{spinning:_.value}])},o(_.value?"progress_activity":"download"),3),s("span",null,o(_.value?"更新中...":"立即更新"),1)],8,Ba)])])):(t(),l("div",Va,[e[21]||(e[21]=s("span",{class:"material-symbols-rounded icon-success"},"check_circle",-1)),s("div",Ma,[e[20]||(e[20]=s("span",null,"已是最新版本",-1)),f.value.current_commit?(t(),l("code",Ra,o(f.value.current_commit),1)):i("",!0)])]))])):i("",!0),R.value?(t(),l("div",La,[e[22]||(e[22]=s("span",{class:"material-symbols-rounded"},"error",-1)),s("span",null,o(R.value),1)])):i("",!0)]),s("div",Wa,[s("div",Ea,[e[23]||(e[23]=s("span",{class:"material-symbols-rounded"},"history",-1)),e[24]||(e[24]=s("h3",null,"历史版本",-1)),s("button",{class:"m3-icon-button",onClick:g,disabled:p.value||P.value||!((ps=c.value)!=null&&ps.git_available)},[s("span",{class:w(["material-symbols-rounded",{spinning:P.value}])},"refresh",2)],8,Na)]),p.value||P.value?(t(),l("div",Pa,[...e[25]||(e[25]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):!((_s=c.value)!=null&&_s.git_available)||!((fs=h.value)!=null&&fs.is_git_repo)?(t(),l("div",Fa,[e[26]||(e[26]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,o((bs=c.value)!=null&&bs.git_available?"当前目录非 Git 仓库":"Git 环境不可用"),1)])):S.value.length?(t(),l("div",za,[(t(!0),l(O,null,X(S.value,$=>(t(),l("div",{key:$.commit,class:w(["backup-item",{"is-current":$.is_current}])},[s("div",Aa,[s("div",Oa,[s("code",Xa,o($.commit_short),1),$.is_current?(t(),l("span",Ha,"当前")):i("",!0)]),s("span",Qa,o($.message),1),s("span",ja,o(us($.timestamp)),1)]),s("div",qa,[s("button",{class:"m3-button text",onClick:J=>ws($.commit),disabled:F.value},[...e[27]||(e[27]=[s("span",{class:"material-symbols-rounded"},"info",-1),s("span",null,"详情",-1)])],8,Ja),s("button",{class:"m3-button text",onClick:J=>M($.commit),disabled:W.value||$.is_current},[...e[28]||(e[28]=[s("span",{class:"material-symbols-rounded"},"restore",-1),s("span",null,"回滚",-1)])],8,Ka)])],2))),128))])):(t(),l("div",Ya,[...e[29]||(e[29]=[s("span",{class:"material-symbols-rounded"},"history_toggle_off",-1),s("span",null,"暂无历史版本",-1)])]))]),(t(),ns(is,{to:"body"},[m.value?(t(),l("div",{key:0,class:"detail-dialog-overlay",onClick:e[2]||(e[2]=os($=>m.value=!1,["self"]))},[s("div",Za,[s("div",st,[e[31]||(e[31]=s("h3",null,"版本详情",-1)),s("button",{class:"m3-icon-button",onClick:e[1]||(e[1]=$=>m.value=!1)},[...e[30]||(e[30]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),a.value?(t(),l("div",et,[s("div",at,[s("div",tt,[e[32]||(e[32]=s("span",{class:"detail-label"},"Commit:",-1)),s("code",lt,o(a.value.commit_short),1)]),s("div",nt,[e[33]||(e[33]=s("span",{class:"detail-label"},"时间:",-1)),s("span",ot,o(us(a.value.timestamp)),1)]),a.value.author?(t(),l("div",it,[e[34]||(e[34]=s("span",{class:"detail-label"},"作者:",-1)),s("span",dt,o(a.value.author),1)])):i("",!0)]),a.value.message?(t(),l("div",ut,[e[35]||(e[35]=s("h4",null,"提交消息",-1)),s("p",rt,o(a.value.message),1)])):i("",!0),a.value.body?(t(),l("div",ct,[e[36]||(e[36]=s("h4",null,"更新内容",-1)),s("pre",vt,o(a.value.body),1)])):i("",!0),(gs=a.value.files_changed)!=null&&gs.length?(t(),l("div",mt,[s("h4",null,"修改文件 ("+o(a.value.files_changed.length)+")",1),s("div",pt,[(t(!0),l(O,null,X(a.value.files_changed.slice(0,20),($,J)=>(t(),l("div",{key:J,class:"file-item"},[s("span",{class:w(["file-status",Cs($.status)])},o($.status),3),s("span",_t,o($.path),1)]))),128)),a.value.files_changed.length>20?(t(),l("div",ft," ... 及其他 "+o(a.value.files_changed.length-20)+" 个文件 ",1)):i("",!0)])])):i("",!0)])):F.value?(t(),l("div",bt,[...e[37]||(e[37]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):i("",!0)])])):i("",!0)]))])}}}),yt=as(gt,[["__scopeId","data-v-8849b0d3"]]),ht={class:"git-settings-tab"},kt={class:"m3-card status-card"},$t={class:"card-header"},wt=["disabled"],Ct={key:0,class:"status-grid"},Gt={class:"status-item"},xt={class:"material-symbols-rounded"},Ut={key:0,class:"status-item"},Tt={class:"status-value"},St={class:"status-item"},Dt={class:"status-value"},It={class:"status-item"},Bt={class:"status-value"},Vt={key:0,class:"m3-card path-card"},Mt={class:"path-content"},Rt={class:"path-display"},Lt={class:"path-value"},Wt={class:"path-actions"},Et=["disabled"],Nt=["disabled"],Pt={key:0,class:"portable-tip"},Ft={class:"m3-card update-config-card"},zt={class:"config-content"},At={class:"config-item"},Ot={class:"m3-switch"},Xt={key:0,class:"config-tip"},Ht={key:2,class:"m3-card guide-card"},Qt={key:0,class:"guide-content"},jt={key:0,class:"guide-commands"},qt={class:"command-name"},Jt={class:"command-value"},Kt=["href"],Yt={class:"modal-content m3-card"},Zt={class:"modal-header"},sl={class:"modal-body"},el={class:"input-wrapper"},al={class:"modal-footer"},tl=["disabled"],ll=es({__name:"GitSettingsTab",setup(L,{expose:H}){const v=r(null),y=r(null),c=r(!1),h=r(!1),f=r(!1),S=r(!1),x=r(!1),C=r(""),p=r(!0);function U(m){return{custom:"自定义",portable:"便携版",system:"系统",unknown:"未知"}[m]||m}function _(){var a;switch((a=v.value)==null?void 0:a.system_os){case"Windows":return"下载便携版";case"Linux":return"安装 Git";case"Darwin":return"安装 Git";default:return"安装 Git"}}function b(){var a;switch((a=v.value)==null?void 0:a.system_os){case"Windows":return'未检测到 Git，可以点击上方"下载便携版"按钮安装';case"Linux":return'未检测到 Git，点击"安装 Git"将使用系统包管理器安装';case"Darwin":return'未检测到 Git，点击"安装 Git"将使用 Homebrew 或 Xcode 安装';default:return"未检测到 Git，请手动安装"}}async function G(){var m;c.value=!0;try{const a=await $s();a.success&&((m=a.data)!=null&&m.data)&&(v.value=a.data.data,!a.data.data.git_available&&a.data.data.system_os!=="Windows"&&W())}catch(a){console.error("加载 Git 状态失败:",a)}finally{c.value=!1}}async function W(){var m;try{const a=await la();a.success&&((m=a.data)!=null&&m.data)&&(y.value=a.data.data)}catch(a){console.error("加载安装指南失败:",a)}}async function P(){var m,a,k,V,E;S.value=!0;try{const d=await ta();d.success&&((a=(m=d.data)==null?void 0:m.data)!=null&&a.success)?(q(d.data.data.message||"已检测到 Git"),await G()):B(((V=(k=d.data)==null?void 0:k.data)==null?void 0:V.error)||((E=d.data)==null?void 0:E.error)||d.error||"未检测到 Git")}catch(d){B(d.message||"检测失败")}finally{S.value=!1}}async function F(){var m,a,k,V,E,d,n;if((m=v.value)!=null&&m.git_available){const T=(a=v.value)==null?void 0:a.system_os;let D=`检测到您的电脑已经安装了 Git。

`;if(T==="Windows"?D+="便携版 Git 适用于没有安装 Git 的用户，如果您已经有 Git，通常不需要再下载。":T==="Linux"?D+="系统将尝试使用包管理器重新安装 Git，这可能会覆盖现有版本。":T==="Darwin"&&(D+="系统将尝试使用 Homebrew 或 Xcode 安装 Git，这可能会覆盖现有版本。"),D+=`

确定要继续吗？`,!await Y({title:"确认安装",message:D,type:"warning",confirmText:"继续安装",cancelText:"取消"}))return}h.value=!0;try{const T=await ea();T.success&&((V=(k=T.data)==null?void 0:k.data)!=null&&V.success)?(q(T.data.data.message||"Git 安装成功"),await P()):B(((d=(E=T.data)==null?void 0:E.data)==null?void 0:d.error)||((n=T.data)==null?void 0:n.error)||T.error||"安装失败")}catch(T){B(T.message||"安装失败")}finally{h.value=!1}}function R(){const m=p.value;localStorage.setItem("autoUpdateEnabled",m.toString()),m?(Fs(),Z("已启用自动更新检查")):(zs(),Z("已关闭自动更新检查"))}async function z(){var m,a,k,V,E;if(C.value){f.value=!0;try{const d=await aa(C.value);d.success&&((a=(m=d.data)==null?void 0:m.data)!=null&&a.success)?(q(d.data.data.message||"路径设置成功"),x.value=!1,C.value="",await G()):B(((V=(k=d.data)==null?void 0:k.data)==null?void 0:V.error)||((E=d.data)==null?void 0:E.error)||d.error||"设置失败")}catch(d){B(d.message||"设置失败")}finally{f.value=!1}}}return ls(()=>{G();const m=localStorage.getItem("autoUpdateEnabled");m!==null&&(p.value=m==="true")}),H({refresh:G}),(m,a)=>(t(),l("div",ht,[s("div",kt,[s("div",$t,[a[6]||(a[6]=s("span",{class:"material-symbols-rounded"},"terminal",-1)),a[7]||(a[7]=s("h3",null,"Git 环境状态",-1)),s("button",{class:"m3-icon-button",onClick:G,disabled:c.value},[s("span",{class:w(["material-symbols-rounded",{spinning:c.value}])},"refresh",2)],8,wt)]),v.value?(t(),l("div",Ct,[s("div",Gt,[a[8]||(a[8]=s("span",{class:"status-label"},"状态",-1)),s("span",{class:w(["status-value",v.value.git_available?"success":"error"])},[s("span",xt,o(v.value.git_available?"check_circle":"cancel"),1),ks(" "+o(v.value.git_available?"可用":"不可用"),1)],2)]),v.value.git_version?(t(),l("div",Ut,[a[9]||(a[9]=s("span",{class:"status-label"},"版本",-1)),s("span",Tt,o(v.value.git_version),1)])):i("",!0),s("div",St,[a[10]||(a[10]=s("span",{class:"status-label"},"来源",-1)),s("span",Dt,[s("span",{class:w(["m3-badge",`source-${v.value.git_source}`])},o(U(v.value.git_source)),3)])]),s("div",It,[a[11]||(a[11]=s("span",{class:"status-label"},"操作系统",-1)),s("span",Bt,o(v.value.system_os),1)])])):i("",!0)]),v.value?(t(),l("div",Vt,[a[15]||(a[15]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"folder"),s("h3",null,"Git 路径")],-1)),s("div",Mt,[s("div",Rt,[a[12]||(a[12]=s("span",{class:"path-label"},"当前路径:",-1)),s("code",Lt,o(v.value.git_path||"未检测到"),1)]),s("div",Wt,[s("button",{class:"m3-button tonal",onClick:P,disabled:S.value},[s("span",{class:w(["material-symbols-rounded",{spinning:S.value}])},o(S.value?"progress_activity":"search"),3),s("span",null,o(S.value?"检测中...":"自动寻找"),1)],8,Et),s("button",{class:"m3-button tonal",onClick:a[0]||(a[0]=k=>x.value=!0)},[...a[13]||(a[13]=[s("span",{class:"material-symbols-rounded"},"edit",-1),s("span",null,"设置路径",-1)])]),s("button",{class:w(["m3-button",v.value.git_available?"tonal":"filled"]),onClick:F,disabled:h.value},[s("span",{class:w(["material-symbols-rounded",{spinning:h.value}])},o(h.value?"progress_activity":"download"),3),s("span",null,o(h.value?"安装中...":_()),1)],10,Nt)]),v.value.git_available?i("",!0):(t(),l("div",Pt,[a[14]||(a[14]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,o(b()),1)]))])])):i("",!0),s("div",Ft,[a[19]||(a[19]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"update"),s("h3",null,"自动更新检查")],-1)),s("div",zt,[s("div",At,[a[17]||(a[17]=s("div",{class:"config-info"},[s("span",{class:"config-label"},"启用自动更新检查"),s("span",{class:"config-desc"},"定期检查是否有新版本可用（每5分钟）")],-1)),s("label",Ot,[ss(s("input",{type:"checkbox","onUpdate:modelValue":a[1]||(a[1]=k=>p.value=k),onChange:R},null,544),[[Ns,p.value]]),a[16]||(a[16]=s("span",{class:"slider"},null,-1))])]),p.value?i("",!0):(t(),l("div",Xt,[...a[18]||(a[18]=[s("span",{class:"material-symbols-rounded"},"info",-1),s("span",null,"关闭后将不会自动检查更新，您可以在更新页面手动检查",-1)])]))])]),i("",!0),v.value&&!v.value.git_available&&v.value.system_os!=="Windows"?(t(),l("div",Ht,[a[23]||(a[23]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"help"),s("h3",null,"安装指南")],-1)),y.value?(t(),l("div",Qt,[s("p",null,o(y.value.description),1),y.value.manual_commands?(t(),l("div",jt,[(t(!0),l(O,null,X(y.value.manual_commands,(k,V)=>(t(),l("div",{key:V,class:"command-item"},[s("span",qt,o(V)+":",1),s("code",Jt,o(k),1)]))),128))])):i("",!0),y.value.manual_url?(t(),l("a",{key:1,href:y.value.manual_url,target:"_blank",class:"m3-button tonal"},[...a[22]||(a[22]=[s("span",{class:"material-symbols-rounded"},"open_in_new",-1),s("span",null,"官方下载",-1)])],8,Kt)):i("",!0)])):i("",!0)])):i("",!0),(t(),ns(is,{to:"body"},[x.value?(t(),l("div",{key:0,class:"modal-overlay",onClick:a[5]||(a[5]=os(k=>x.value=!1,["self"]))},[s("div",Yt,[s("div",Zt,[a[25]||(a[25]=s("h3",null,"设置 Git 路径",-1)),s("button",{class:"m3-icon-button",onClick:a[2]||(a[2]=k=>x.value=!1)},[...a[24]||(a[24]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),s("div",sl,[a[26]||(a[26]=s("p",null,"请输入 Git 可执行文件的完整路径",-1)),s("div",el,[ss(s("input",{type:"text","onUpdate:modelValue":a[3]||(a[3]=k=>C.value=k),placeholder:"例如: C:\\Program Files\\Git\\bin\\git.exe",class:"m3-input"},null,512),[[Ps,C.value]])])]),s("div",al,[s("button",{class:"m3-button text",onClick:a[4]||(a[4]=k=>x.value=!1)},"取消"),s("button",{class:"m3-button filled",onClick:z,disabled:!C.value||f.value},o(f.value?"设置中...":"确定"),9,tl)])])])):i("",!0)]))]))}}),nl=as(ll,[["__scopeId","data-v-3f723e00"]]),ol={key:0,class:"dialog-content m3-card"},il={class:"dialog-header"},dl={class:"material-symbols-rounded"},ul={class:"dialog-body"},rl={class:"dialog-message"},cl={key:0,class:"changelog-section"},vl={class:"changelog-list"},ml={class:"tip-section"},pl=es({__name:"RestartDialog",props:{modelValue:{type:Boolean},updateType:{default:"main"},changelog:{default:()=>[]}},emits:["update:modelValue","restart","later"],setup(L,{emit:H}){const v=L,y=H,c=j(()=>({main:"type-main",ui:"type-ui",both:"type-both"})[v.updateType]),h=j(()=>({main:"smart_toy",ui:"web",both:"system_update"})[v.updateType]),f=j(()=>({main:"主程序更新完成",ui:"UI 更新完成",both:"全部更新完成"})[v.updateType]),S=j(()=>({main:"主程序已更新成功，需要重启才能生效。",ui:"WebUI 已更新成功，需要刷新页面才能生效。",both:"主程序和 WebUI 都已更新成功，需要重启才能生效。"})[v.updateType]),x=j(()=>v.updateType==="ui"?"刷新页面后将加载新版本的 WebUI":"重启后新功能将生效，当前的连接会暂时中断");function C(){y("restart"),y("update:modelValue",!1)}function p(){y("later"),y("update:modelValue",!1)}return(U,_)=>(t(),ns(is,{to:"body"},[K(ys,{name:"fade"},{default:hs(()=>[L.modelValue?(t(),l("div",{key:0,class:"dialog-overlay",onClick:os(p,["self"])},[K(ys,{name:"scale"},{default:hs(()=>[L.modelValue?(t(),l("div",ol,[s("div",il,[s("div",{class:w(["dialog-icon",c.value])},[s("span",dl,o(h.value),1)],2),s("h2",null,o(f.value),1)]),s("div",ul,[s("p",rl,o(S.value),1),L.changelog&&L.changelog.length>0?(t(),l("div",cl,[_[0]||(_[0]=s("h4",null,"更新内容:",-1)),s("ul",vl,[(t(!0),l(O,null,X(L.changelog.slice(0,5),(b,G)=>(t(),l("li",{key:G},o(b),1))),128))])])):i("",!0),s("div",ml,[_[1]||(_[1]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,o(x.value),1)])]),s("div",{class:"dialog-footer"},[s("button",{class:"m3-button text",onClick:p}," 稍后重启 "),s("button",{class:"m3-button filled",onClick:C},[..._[2]||(_[2]=[s("span",{class:"material-symbols-rounded"},"restart_alt",-1),s("span",null,"立即重启",-1)])])])])):i("",!0)]),_:1})])):i("",!0)]),_:1})]))}}),_l=as(pl,[["__scopeId","data-v-8bea0f4d"]]),fl={class:"update-view"},bl={class:"tabs-nav"},gl=["onClick"],yl={class:"material-symbols-rounded"},hl={class:"tab-label"},kl={class:"tab-content"},$l=es({__name:"GitUpdateView",setup(L){const H=[{id:"ui",label:"UI 更新",icon:"web"},{id:"main",label:"主程序",icon:"terminal"},{id:"git",label:"Git 设置",icon:"settings"}],v=r("ui"),y=r(!1),c=r("main"),h=r([]);function f(p){p&&(c.value="ui",h.value=[],y.value=!0)}function S(p){p&&(c.value="main",h.value=[],y.value=!0)}async function x(){y.value=!1;try{await Os()}catch(p){console.error("重启失败:",p)}}function C(){y.value=!1}return ls(()=>{}),(p,U)=>(t(),l("div",fl,[U[1]||(U[1]=As('<div class="page-header" data-v-8d4eeec6><div class="header-content" data-v-8d4eeec6><div class="header-icon" data-v-8d4eeec6><span class="material-symbols-rounded" data-v-8d4eeec6>system_update</span></div><div class="header-text" data-v-8d4eeec6><h1 data-v-8d4eeec6>更新管理</h1><p data-v-8d4eeec6>管理 MoFox-Bot 和 WebUI 的更新</p></div></div></div>',1)),s("div",bl,[(t(),l(O,null,X(H,_=>s("button",{key:_.id,class:w(["tab-item",{active:v.value===_.id}]),onClick:b=>v.value=_.id},[s("span",yl,o(_.icon),1),s("span",hl,o(_.label),1)],10,gl)),64))]),s("div",kl,[ss(K(sa,{ref:"uiUpdateTabRef",onUpdateComplete:f},null,512),[[ds,v.value==="ui"]]),ss(K(yt,{ref:"mainUpdateTabRef",onUpdateComplete:S},null,512),[[ds,v.value==="main"]]),ss(K(nl,{ref:"gitSettingsTabRef"},null,512),[[ds,v.value==="git"]])]),K(_l,{modelValue:y.value,"onUpdate:modelValue":U[0]||(U[0]=_=>y.value=_),"update-type":c.value,changelog:h.value,onRestart:x,onLater:C},null,8,["modelValue","update-type","changelog"])]))}}),Tl=as($l,[["__scopeId","data-v-8d4eeec6"]]);export{Tl as default};
