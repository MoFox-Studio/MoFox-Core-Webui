import{S as U,a as ue,r as u,D,G as K,m as de,N as me,c as n,e as o,O as R,Q as j,F as E,h as P,g as f,t as d,n as $,P as F,s as Q,J as x,o as l,_ as _e}from"./index-CLTUvmfq.js";async function ve(m=100){try{const r=await U.get(`live_chat/streams?limit=${m}`);return r.success&&r.data?r.data:[]}catch(r){return console.error("èŽ·å–èŠå¤©æµå¤±è´¥:",r),[]}}async function pe(m,r=100,a){try{let v=`live_chat/messages/${m}?limit=${r}`;const _=await U.get(v);return _.success&&_.data?_.data:[]}catch(v){return console.error("èŽ·å–åŽ†å²æ¶ˆæ¯å¤±è´¥:",v),[]}}async function fe(m){try{const r=await U.post("live_chat/send",{stream_id:m.stream_id,content:m.content,message_type:m.message_type||"text"});if(r.success&&r.data){const a=r.data;return a.success?{success:!0,messageId:a.message_id||void 0}:{success:!1,error:a.message||"å‘é€å¤±è´¥"}}return{success:!1,error:r.error||"è¯·æ±‚å¤±è´¥"}}catch(r){return console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",r),{success:!1,error:String(r)}}}async function ge(){const m=window.location.protocol==="https:"?"wss:":"ws:",r=localStorage.getItem("mofox_token")||"";return`${m}//${window.location.host}/webui/api/live_chat/ws?api_key=${encodeURIComponent(r)}`}function ye(m){return m.replace(/api_key=[^&]+/,"api_key=***")}const he={class:"live-chat-view"},be={class:"stream-panel"},ke={class:"search-box"},we={class:"platform-filter"},Se=["onClick"],Ce={class:"stream-list"},$e=["onClick"],xe={class:"stream-icon"},Te={class:"material-symbols-rounded"},Me={class:"stream-info"},We={class:"stream-header-row"},Ne={class:"stream-name"},Le={key:0,class:"last-active"},De={class:"stream-meta"},Ee={class:"platform-badge"},Pe={key:0,class:"unread-badge"},Ue={key:0,class:"empty-state"},Ie={class:"chat-panel"},Oe={class:"chat-header"},He={key:0,class:"header-content"},Ve={class:"stream-icon large"},ze={class:"material-symbols-rounded"},Be={class:"stream-info"},Ae={class:"stream-id"},Je={key:1,class:"header-placeholder"},Ke={class:"header-actions"},Re={class:"material-symbols-rounded"},je={key:0,class:"welcome-state"},Fe={key:1,class:"loading-state"},Qe={key:2,class:"messages-list"},Ye=["onClick"],Ge={class:"reply-text"},Xe={class:"message-header"},Ze={class:"user-name"},qe={key:0,class:"sender-badge bot"},es={key:1,class:"sender-badge webui"},ss={class:"message-time"},ts={class:"message-content"},os=["src","onClick"],as={key:1,class:"text-content"},ns={key:0,class:"empty-messages"},ls={key:0,class:"input-area"},rs={class:"input-toolbar"},is={class:"input-wrapper"},cs=["onKeydown"],us=["disabled"],Y=10,ds=ue({__name:"LiveChatView",setup(m){const r=u([]),a=u(null),v=u(""),_=u(""),I=u(!1),y=u(new Map),T=u(!1),h=u({}),p=u(""),w=u(!1),G=u(!1),X=u(!1),b=u(!1);let i=null,M=null,k=0,S=null;const C=u(null),O=u(null),Z=u(new Map),q=D(()=>{const s=new Set([""]);return r.value.forEach(e=>{e.platform&&s.add(e.platform)}),Array.from(s)}),H=D(()=>r.value.filter(s=>{if(_.value&&s.platform!==_.value)return!1;if(v.value){const e=v.value.toLowerCase(),t=(s.group_name||s.user_nickname||"").toLowerCase(),c=s.stream_id.toLowerCase();if(!t.includes(e)&&!c.includes(e))return!1}return!0})),W=D(()=>a.value?y.value.get(a.value.stream_id)||[]:[]);async function V(){I.value=!0;try{r.value=await ve(100)}catch(s){console.error("èŽ·å–èŠå¤©æµå¤±è´¥:",s)}finally{I.value=!1}}function ee(s){a.value=s,h.value[s.stream_id]=0,N(),te(s.stream_id)}async function N(){if(a.value){T.value=!0;try{const s=a.value.stream_id,e=await pe(s,200);console.log(`åŠ è½½èŠå¤©æµ ${s} çš„åŽ†å²æ¶ˆæ¯ï¼Œå…± ${e.length} æ¡`),y.value.set(s,e),await x(),A()}catch(s){console.error("èŽ·å–åŽ†å²æ¶ˆæ¯å¤±è´¥:",s)}finally{T.value=!1}}}async function z(){if(!(!p.value.trim()||!a.value||w.value)){w.value=!0;try{const s=await fe({stream_id:a.value.stream_id,content:p.value.trim(),message_type:"text"});s.success?(p.value="",x(J)):console.error("å‘é€å¤±è´¥:",s.error)}catch(s){console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",s)}finally{w.value=!1}}}async function B(){if((i==null?void 0:i.readyState)!==WebSocket.OPEN)try{const s=await ge();console.log("è¿žæŽ¥ WebSocket:",ye(s)),i=new WebSocket(s),i.onopen=()=>{var t;console.log("WebSocket å·²è¿žæŽ¥"),b.value=!0,k=0;const e=S||((t=a.value)==null?void 0:t.stream_id);e&&(i.send(JSON.stringify({type:"subscribe",stream_id:e})),S=null)},i.onmessage=e=>{try{const t=JSON.parse(e.data);se(t)}catch(t){e.data!=="pong"&&console.error("è§£æž WebSocket æ¶ˆæ¯å¤±è´¥:",t)}},i.onclose=()=>{console.log("WebSocket å·²æ–­å¼€"),b.value=!1,oe()},i.onerror=e=>{console.error("WebSocket é”™è¯¯:",e)}}catch(s){console.error("è¿žæŽ¥ WebSocket å¤±è´¥:",s)}}function se(s){var e;if(s.type==="message"){const t=s.data,c=t.stream_id;if(!c)return;y.value.has(c)||y.value.set(c,[]);const g=y.value.get(c);g.some(L=>L.message_id===t.message_id)||(g.push(t),((e=a.value)==null?void 0:e.stream_id)===c?x(()=>A()):h.value[c]=(h.value[c]||0)+1)}else s.type==="subscribed"?console.log("å·²è®¢é˜…èŠå¤©æµ:",s.stream_id):s.type==="pong"&&console.debug("æ”¶åˆ°å¿ƒè·³å“åº”")}function te(s){(i==null?void 0:i.readyState)===WebSocket.OPEN?(i.send(JSON.stringify({type:"subscribe",stream_id:s})),S=null):(S=s,console.log("å¾…è®¢é˜…èŠå¤©æµ:",s))}function oe(){if(k>=Y){console.error("WebSocket é‡è¿žæ¬¡æ•°è¶…è¿‡é™åˆ¶");return}const s=Math.min(1e3*Math.pow(2,k),3e4);k++,console.log(`å°†åœ¨ ${s}ms åŽé‡è¿ž (å°è¯• ${k}/${Y})`),M=window.setTimeout(()=>{B()},s)}function ae(){setInterval(()=>{(i==null?void 0:i.readyState)===WebSocket.OPEN&&i.send("ping")},3e4)}function A(){C.value&&(C.value.scrollTop=C.value.scrollHeight)}function ne(s){console.log("æ»šåŠ¨åˆ°æ¶ˆæ¯:",s)}function le(s){var c,g;const e=Z.value.get(s);if(e)return`${e.user_nickname}: ${(c=e.content)==null?void 0:c.slice(0,30)}...`;const t=W.value.find(L=>L.message_id===s);return t?`${t.user_nickname}: ${(g=t.content)==null?void 0:g.slice(0,30)}...`:"æŸ¥çœ‹åŽŸæ¶ˆæ¯"}function re(s){console.log("é¢„è§ˆå›¾ç‰‡:",s)}function ie(s){if(!s)return"";const e=new Date(s*1e3),t=new Date;return e.toDateString()===t.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN",{month:"short",day:"numeric"})}function ce(s){return s?new Date(s*1e3).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"}):""}function J(){const s=O.value;if(!s)return;s.style.height="auto";const e=s.scrollHeight;s.style.height=e+"px",e>150?s.style.overflowY="auto":s.style.overflowY="hidden"}return K(p,()=>{x(J)}),de(()=>{V(),B(),ae()}),me(()=>{i&&(i.close(),i=null),M&&clearTimeout(M)}),K(a,s=>{s&&N()}),(s,e)=>(l(),n("div",he,[o("aside",be,[o("div",{class:"panel-header"},[e[6]||(e[6]=o("div",{class:"header-content"},[o("span",{class:"material-symbols-rounded"},"forum"),o("h2",null,"èŠå¤©æµ")],-1)),o("button",{class:"m3-button icon-only",onClick:V,title:"åˆ·æ–°åˆ—è¡¨"},[...e[5]||(e[5]=[o("span",{class:"material-symbols-rounded"},"refresh",-1)])])]),o("div",ke,[e[7]||(e[7]=o("span",{class:"material-symbols-rounded"},"search",-1)),R(o("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>v.value=t),type:"text",placeholder:"æœç´¢èŠå¤©æµ..."},null,512),[[j,v.value]])]),o("div",we,[(l(!0),n(E,null,P(q.value,t=>(l(),n("button",{key:t,class:$(["filter-chip",{active:_.value===t}]),onClick:c=>_.value=_.value===t?"":t},d(t||"å…¨éƒ¨"),11,Se))),128))]),o("div",Ce,[(l(!0),n(E,null,P(H.value,t=>{var c;return l(),n("div",{key:t.stream_id,class:$(["stream-item",{active:((c=a.value)==null?void 0:c.stream_id)===t.stream_id}]),onClick:g=>ee(t)},[o("div",xe,[o("span",Te,d(t.group_id?"group":"person"),1)]),o("div",Me,[o("div",We,[o("div",Ne,d(t.group_id||t.user_id||"æœªçŸ¥"),1),t.last_message_time?(l(),n("span",Le,d(ie(t.last_message_time)),1)):f("",!0)]),o("div",De,[o("span",Ee,d(t.platform),1)])]),h.value[t.stream_id]?(l(),n("div",Pe,d(h.value[t.stream_id]),1)):f("",!0)],10,$e)}),128)),H.value.length===0?(l(),n("div",Ue,[...e[8]||(e[8]=[o("span",{class:"material-symbols-rounded"},"inbox",-1),o("p",null,"æš‚æ— èŠå¤©æµ",-1)])])):f("",!0)])]),o("main",Ie,[o("header",Oe,[a.value?(l(),n("div",He,[o("div",Ve,[o("span",ze,d(a.value.group_id?"group":"person"),1)]),o("div",Be,[o("h2",null,d(a.value.group_id||a.value.user_id||"æœªçŸ¥"),1),o("p",Ae,d(a.value.stream_id),1)])])):(l(),n("div",Je,[...e[9]||(e[9]=[o("span",{class:"material-symbols-rounded"},"chat",-1),o("span",null,"å³æ—¶é€šè®¯",-1)])])),o("div",Ke,[o("div",{class:$(["connection-status",{connected:b.value}])},[o("span",Re,d(b.value?"wifi":"wifi_off"),1),o("span",null,d(b.value?"å·²è¿žæŽ¥":"æœªè¿žæŽ¥"),1)],2),o("button",{class:"m3-button icon-only",onClick:N,title:"åŠ è½½åŽ†å²æ¶ˆæ¯"},[...e[10]||(e[10]=[o("span",{class:"material-symbols-rounded"},"history",-1)])])])]),o("div",{class:"messages-container",ref_key:"messagesContainer",ref:C},[a.value?T.value?(l(),n("div",Fe,[...e[12]||(e[12]=[o("div",{class:"spinner"},null,-1),o("p",null,"åŠ è½½æ¶ˆæ¯ä¸­...",-1)])])):(l(),n("div",Qe,[(l(!0),n(E,null,P(W.value,t=>(l(),n("div",{key:t.message_id,class:$(["message",{"is-incoming":!t.is_sent,"is-outgoing":t.is_sent,"is-bot":t.is_bot,"is-webui":t.is_webui}])},[t.reply_message_id?(l(),n("div",{key:0,class:"reply-preview",onClick:c=>ne(t.reply_message_id)},[e[13]||(e[13]=o("span",{class:"material-symbols-rounded"},"reply",-1)),o("span",Ge,d(le(t.reply_message_id)),1)],8,Ye)):f("",!0),o("div",Xe,[o("span",Ze,d(t.sender_name||"æœªçŸ¥ç”¨æˆ·"),1),t.is_bot?(l(),n("span",qe,"ðŸ¤– Bot")):f("",!0),t.is_webui?(l(),n("span",es,"ðŸ“± WebUI")):f("",!0),o("span",ss,d(ce(t.time)),1)]),o("div",ts,[t.images&&t.images.length>0?(l(),n("img",{key:0,src:t.images[0].url||"",class:"message-image",onClick:c=>re(t.images[0].hash||""),loading:"lazy"},null,8,os)):(l(),n("span",as,d(t.content),1))])],2))),128)),W.value.length===0?(l(),n("div",ns,[...e[14]||(e[14]=[o("span",{class:"material-symbols-rounded"},"chat_bubble_outline",-1),o("p",null,"æš‚æ— æ¶ˆæ¯",-1)])])):f("",!0)])):(l(),n("div",je,[...e[11]||(e[11]=[o("span",{class:"material-symbols-rounded"},"forum",-1),o("h3",null,"å³æ—¶é€šè®¯",-1),o("p",null,"é€‰æ‹©ä¸€ä¸ªèŠå¤©æµæŸ¥çœ‹å®žæ—¶æ¶ˆæ¯",-1)])]))],512),a.value?(l(),n("div",ls,[o("div",rs,[o("button",{class:"m3-icon-button",onClick:e[1]||(e[1]=t=>G.value=!0),title:"å‘é€å›¾ç‰‡"},[...e[15]||(e[15]=[o("span",{class:"material-symbols-rounded"},"image",-1)])]),o("button",{class:"m3-icon-button",onClick:e[2]||(e[2]=t=>X.value=!0),title:"å‘é€è¡¨æƒ…"},[...e[16]||(e[16]=[o("span",{class:"material-symbols-rounded"},"mood",-1)])])]),o("div",is,[R(o("textarea",{"onUpdate:modelValue":e[3]||(e[3]=t=>p.value=t),placeholder:"è¾“å…¥æ¶ˆæ¯...",onKeydown:[F(Q(z,["exact"]),["enter"]),e[4]||(e[4]=F(Q(t=>p.value+=`
`,["shift","exact","prevent"]),["enter"]))],rows:"1",ref_key:"inputTextarea",ref:O},null,40,cs),[[j,p.value]])]),o("button",{class:"m3-button filled send-button",onClick:z,disabled:!p.value.trim()||w.value},[...e[17]||(e[17]=[o("span",{class:"material-symbols-rounded"},"send",-1)])],8,us)])):f("",!0)])]))}}),_s=_e(ds,[["__scopeId","data-v-561e0d3d"]]);export{_s as default};
