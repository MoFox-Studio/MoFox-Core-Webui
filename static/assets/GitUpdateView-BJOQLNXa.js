import{a2 as z,a as Z,r,D as H,m as ts,c as t,g as i,l as ls,e as s,t as n,n as x,F as E,h as F,s as ns,M as os,o as a,_ as ss,N as Cs,L as ks,az as Gs,aA as xs,ad as is,aB as Ts,aC as Us,aD as Ds,aE as Ss,aF as Is,aG as Bs,O as as,P as Vs,f as Q,T as gs,w as hs,ac as Ms,S as us}from"./index-K77h00Ct.js";import{s as Y,a as J,b as U}from"./dialog-TJ0-Wewf.js";import{r as Rs}from"./dashboard-g1Bu4ukx.js";import"./ConfirmDialog-CSw6GqdK.js";import"./iconify-BGSZjqZ1.js";function Ls(){return z.get("ui_update/status")}function Ws(){return z.post("ui_update/update")}function Ps(){return z.get("ui_update/backups")}function Ns(I){return z.post("ui_update/rollback",{commit_hash:I})}function Es(I){return z.get(`ui_update/commit/${I}`)}const Fs={class:"ui-update-tab"},zs={key:0,class:"m3-card disabled-card"},As={class:"disabled-content"},Os={class:"disabled-text"},Xs={key:1,class:"m3-card version-card"},js={key:0,class:"version-info"},qs={class:"info-row"},Hs={class:"info-value version"},Js={key:0,class:"info-row"},Ks={class:"info-value"},Qs={key:1,class:"info-row"},Ys={class:"info-value branch"},Zs={key:2,class:"info-row"},se={class:"info-value commit"},ee={key:1,class:"version-info"},ae={key:2,class:"m3-card update-check-card"},te={class:"card-header"},le=["disabled"],ne={key:0,class:"update-result"},oe={key:0,class:"has-update"},ie={class:"update-badge"},ue={key:0,class:"changelog"},de={class:"update-actions"},re=["disabled"],ce={key:1,class:"up-to-date"},ve={key:1,class:"error-message"},me={key:3,class:"m3-card backup-card"},pe={class:"card-header"},_e=["disabled"],fe={key:0,class:"backup-list"},be={class:"backup-info"},ye={class:"backup-header"},ge={class:"backup-commit"},he={key:0,class:"backup-version"},ke={key:1,class:"current-badge"},$e={class:"backup-message"},we={class:"backup-meta"},Ce={class:"backup-actions"},Ge=["onClick","disabled"],xe=["onClick","disabled"],Te={key:1,class:"no-backups"},Ue={class:"detail-dialog"},De={class:"detail-header"},Se={key:0,class:"detail-content"},Ie={class:"detail-section"},Be={class:"detail-row"},Ve={class:"detail-value"},Me={key:0,class:"detail-row"},Re={class:"detail-value version-tag"},Le={class:"detail-row"},We={class:"detail-value"},Pe={key:1,class:"detail-row"},Ne={class:"detail-value"},Ee={key:0,class:"detail-section"},Fe={class:"commit-message"},ze={key:1,class:"detail-section"},Ae={class:"commit-body"},Oe={key:2,class:"detail-section"},Xe={class:"files-list"},je={class:"file-path"},qe={key:0,class:"files-more"},He={key:1,class:"detail-content loading"},Je=Z({__name:"UIUpdateTab",emits:["update-complete"],setup(I,{expose:A,emit:v}){const g=v,c=r(null),h=r([]),_=r(!1),T=r(!1),C=r(!1),$=r(!1),b=r(""),G=r(!1),f=r(!1),p=r(null),D=H(()=>c.value?{version:c.value.current_version||"未安装",build_time:null,branch:c.value.current_branch,commit:c.value.current_commit}:null),R=H(()=>c.value?c.value.update_enabled===!1:!1),O=H(()=>c.value?c.value.message?c.value.message:c.value.update_enabled===!1?`当前分支为 "${c.value.current_branch||"未知"}"，更新功能已禁用。仅 webui-dist 分支支持自动更新。`:"":"");function P(y){if(!y)return"-";try{return new Date(y).toLocaleString("zh-CN")}catch{return y}}async function m(){_.value=!0,b.value="";try{const y=await Ls();y.success&&y.data?(c.value=y.data,y.data.success||(b.value=y.data.error||"获取状态失败")):b.value=y.error||"获取状态失败"}catch(y){b.value=y.message||"获取状态失败"}finally{_.value=!1}}async function o(){await m()}async function u(){var l,q;if(await Y({title:"确认更新",message:"更新 UI 将刷新页面，是否继续？",confirmText:"更新"})){T.value=!0,b.value="";try{const S=await Ws();S.success&&((l=S.data)!=null&&l.success)?(J(`更新成功！已更新到 ${S.data.version||"最新版本"}`),g("update-complete",!0)):U(((q=S.data)==null?void 0:q.error)||S.error||"更新失败")}catch(S){U(S.message||"更新失败")}finally{T.value=!1}}}async function L(){var y;$.value=!0;try{const l=await Ps();l.success&&((y=l.data)!=null&&y.data)&&(h.value=l.data.data)}catch(l){console.error("加载备份列表失败:",l)}finally{$.value=!1}}async function B(y){var S,k;const l=y.substring(0,7);if(await Y({title:"确认回滚",message:`确定要回滚到版本 "${l}" 吗？此操作将重置到该版本。`,confirmText:"回滚"})){C.value=!0;try{const M=await Ns(y);M.success&&((S=M.data)!=null&&S.success)?(J(M.data.message||"回滚成功"),g("update-complete",!0)):U(((k=M.data)==null?void 0:k.error)||M.error||"回滚失败")}catch(M){U(M.message||"回滚失败")}finally{C.value=!1}}}async function X(y){G.value=!0,f.value=!0,p.value=null;try{const l=await Es(y);l.success&&l.data?p.value=l.data:(U(l.error||"获取详情失败"),G.value=!1)}catch(l){U(l.message||"获取详情失败"),G.value=!1}finally{f.value=!1}}function es(y){return{新增:"status-add",修改:"status-modify",删除:"status-delete",重命名:"status-rename"}[y]||""}return ts(()=>{m(),L()}),A({refresh:()=>{m(),L()}}),(y,l)=>{var q,S;return a(),t("div",Fs,[R.value?(a(),t("div",zs,[s("div",As,[l[3]||(l[3]=s("span",{class:"material-symbols-rounded icon-warning"},"info",-1)),s("div",Os,[l[2]||(l[2]=s("h4",null,"更新功能已禁用",-1)),s("p",null,n(O.value),1)])])])):i("",!0),R.value?i("",!0):(a(),t("div",Xs,[l[9]||(l[9]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"web"),s("h3",null,"当前版本")],-1)),D.value?(a(),t("div",js,[s("div",qs,[l[4]||(l[4]=s("span",{class:"info-label"},"版本号:",-1)),s("span",Hs,"v"+n(D.value.version),1)]),D.value.build_time?(a(),t("div",Js,[l[5]||(l[5]=s("span",{class:"info-label"},"构建时间:",-1)),s("span",Ks,n(P(D.value.build_time)),1)])):i("",!0),D.value.branch?(a(),t("div",Qs,[l[6]||(l[6]=s("span",{class:"info-label"},"分支:",-1)),s("span",Ys,n(D.value.branch),1)])):i("",!0),D.value.commit?(a(),t("div",Zs,[l[7]||(l[7]=s("span",{class:"info-label"},"Commit:",-1)),s("code",se,n(D.value.commit.substring(0,8)),1)])):i("",!0)])):(a(),t("div",ee,[...l[8]||(l[8]=[s("p",{class:"no-version"},"未检测到版本信息",-1)])]))])),R.value?i("",!0):(a(),t("div",ae,[s("div",te,[l[10]||(l[10]=s("span",{class:"material-symbols-rounded"},"sync",-1)),l[11]||(l[11]=s("h3",null,"检查更新",-1)),s("button",{class:"m3-button tonal",onClick:o,disabled:_.value||R.value},[s("span",{class:x(["material-symbols-rounded",{spinning:_.value}])},n(_.value?"progress_activity":"refresh"),3),s("span",null,n(_.value?"检查中...":"检查更新"),1)],8,le)]),c.value&&!R.value?(a(),t("div",ne,[c.value.has_update?(a(),t("div",oe,[s("div",ie,[l[12]||(l[12]=s("span",{class:"material-symbols-rounded"},"auto_awesome",-1)),s("span",null,"发现新版本 v"+n(c.value.latest_version),1)]),(q=c.value.changelog)!=null&&q.length?(a(),t("div",ue,[l[13]||(l[13]=s("h4",null,"更新内容:",-1)),s("ul",null,[(a(!0),t(E,null,F(c.value.changelog.slice(0,10),(k,M)=>(a(),t("li",{key:M},n(k),1))),128))])])):i("",!0),s("div",de,[s("button",{class:"m3-button filled",onClick:u,disabled:T.value},[s("span",{class:x(["material-symbols-rounded",{spinning:T.value}])},n(T.value?"progress_activity":"download"),3),s("span",null,n(T.value?"更新中...":"立即更新"),1)],8,re)])])):(a(),t("div",ce,[...l[14]||(l[14]=[s("span",{class:"material-symbols-rounded icon-success"},"check_circle",-1),s("span",null,"已是最新版本",-1)])]))])):i("",!0),b.value?(a(),t("div",ve,[l[15]||(l[15]=s("span",{class:"material-symbols-rounded"},"error",-1)),s("span",null,n(b.value),1)])):i("",!0)])),R.value?i("",!0):(a(),t("div",me,[s("div",pe,[l[16]||(l[16]=s("span",{class:"material-symbols-rounded"},"history",-1)),l[17]||(l[17]=s("h3",null,"历史版本",-1)),s("button",{class:"m3-icon-button",onClick:L,disabled:$.value},[s("span",{class:x(["material-symbols-rounded",{spinning:$.value}])},"refresh",2)],8,_e)]),h.value.length?(a(),t("div",fe,[(a(!0),t(E,null,F(h.value,k=>(a(),t("div",{key:k.commit,class:x(["backup-item",{"is-current":k.is_current}])},[s("div",be,[s("div",ye,[s("code",ge,n(k.commit_short),1),k.version?(a(),t("span",he,"v"+n(k.version),1)):i("",!0),k.is_current?(a(),t("span",ke,"当前")):i("",!0)]),s("span",$e,n(k.message),1),s("span",we,n(P(k.timestamp)),1)]),s("div",Ce,[s("button",{class:"m3-button text",onClick:M=>X(k.commit),disabled:f.value},[...l[18]||(l[18]=[s("span",{class:"material-symbols-rounded"},"info",-1),s("span",null,"详情",-1)])],8,Ge),s("button",{class:"m3-button text",onClick:M=>B(k.commit),disabled:C.value||k.is_current},[...l[19]||(l[19]=[s("span",{class:"material-symbols-rounded"},"restore",-1),s("span",null,"回滚",-1)])],8,xe)])],2))),128))])):(a(),t("div",Te,[...l[20]||(l[20]=[s("span",{class:"material-symbols-rounded"},"history_toggle_off",-1),s("span",null,"暂无历史版本",-1)])]))])),(a(),ls(os,{to:"body"},[G.value?(a(),t("div",{key:0,class:"detail-dialog-overlay",onClick:l[1]||(l[1]=ns(k=>G.value=!1,["self"]))},[s("div",Ue,[s("div",De,[l[22]||(l[22]=s("h3",null,"版本详情",-1)),s("button",{class:"m3-icon-button",onClick:l[0]||(l[0]=k=>G.value=!1)},[...l[21]||(l[21]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),p.value?(a(),t("div",Se,[s("div",Ie,[s("div",Be,[l[23]||(l[23]=s("span",{class:"detail-label"},"Commit:",-1)),s("code",Ve,n(p.value.commit_short),1)]),p.value.version?(a(),t("div",Me,[l[24]||(l[24]=s("span",{class:"detail-label"},"版本:",-1)),s("span",Re,"v"+n(p.value.version),1)])):i("",!0),s("div",Le,[l[25]||(l[25]=s("span",{class:"detail-label"},"时间:",-1)),s("span",We,n(P(p.value.timestamp)),1)]),p.value.author?(a(),t("div",Pe,[l[26]||(l[26]=s("span",{class:"detail-label"},"作者:",-1)),s("span",Ne,n(p.value.author),1)])):i("",!0)]),p.value.message?(a(),t("div",Ee,[l[27]||(l[27]=s("h4",null,"提交消息",-1)),s("p",Fe,n(p.value.message),1)])):i("",!0),p.value.body?(a(),t("div",ze,[l[28]||(l[28]=s("h4",null,"更新内容",-1)),s("pre",Ae,n(p.value.body),1)])):i("",!0),(S=p.value.files_changed)!=null&&S.length?(a(),t("div",Oe,[s("h4",null,"修改文件 ("+n(p.value.files_changed.length)+")",1),s("div",Xe,[(a(!0),t(E,null,F(p.value.files_changed.slice(0,20),(k,M)=>(a(),t("div",{key:M,class:"file-item"},[s("span",{class:x(["file-status",es(k.status)])},n(k.status),3),s("span",je,n(k.path),1)]))),128)),p.value.files_changed.length>20?(a(),t("div",qe," ... 及其他 "+n(p.value.files_changed.length-20)+" 个文件 ",1)):i("",!0)])])):i("",!0)])):f.value?(a(),t("div",He,[...l[29]||(l[29]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):i("",!0)])])):i("",!0)]))])}}}),Ke=ss(Je,[["__scopeId","data-v-da3800a9"]]);function $s(){return z.get("git_env/status")}function Qe(){return z.post("git_env/install")}function Ye(I){return z.post("git_env/set-path",{path:I})}function Ze(){return z.post("git_env/auto-detect")}function sa(){return z.get("git_env/install-guide")}const ea={class:"main-update-tab"},aa={class:"m3-card branch-card"},ta={key:0,class:"loading-placeholder"},la={key:1,class:"card-disabled-hint"},na={key:2,class:"branch-selector"},oa={class:"selected-value"},ia={key:0,class:"m3-select-dropdown m3-card"},ua=["onClick"],da={key:0,class:"material-symbols-rounded check-icon"},ra={key:0,class:"switching-indicator"},ca=["disabled","title"],va={class:"m3-card update-card"},ma={class:"card-header"},pa=["disabled"],_a={key:0,class:"loading-placeholder"},fa={key:1,class:"alert alert-warning"},ba={key:2,class:"alert alert-warning"},ya={key:3,class:"update-result"},ga={key:0,class:"has-update"},ha={class:"update-header"},ka={class:"update-title"},$a={class:"version-compare"},wa={class:"version-box version-current"},Ca={class:"version-box version-latest"},Ga={key:0,class:"changelog"},xa={class:"update-actions"},Ta=["disabled"],Ua={key:1,class:"up-to-date"},Da={class:"up-to-date-info"},Sa={key:0},Ia={key:4,class:"error-message"},Ba={class:"m3-card backup-card"},Va={class:"card-header"},Ma=["disabled"],Ra={key:0,class:"loading-placeholder"},La={key:1,class:"card-disabled-hint"},Wa={key:2,class:"backup-list"},Pa={class:"backup-info"},Na={class:"backup-header"},Ea={class:"backup-commit"},Fa={key:0,class:"current-badge"},za={class:"backup-message"},Aa={class:"backup-meta"},Oa={class:"backup-actions"},Xa=["onClick","disabled"],ja=["onClick","disabled"],qa={key:3,class:"no-backups"},Ha={class:"detail-dialog"},Ja={class:"detail-header"},Ka={key:0,class:"detail-content"},Qa={class:"detail-section"},Ya={class:"detail-row"},Za={class:"detail-value"},st={class:"detail-row"},et={class:"detail-value"},at={key:0,class:"detail-row"},tt={class:"detail-value"},lt={key:0,class:"detail-section"},nt={class:"commit-message"},ot={key:1,class:"detail-section"},it={class:"commit-body"},ut={key:2,class:"detail-section"},dt={class:"files-list"},rt={class:"file-path"},ct={key:0,class:"files-more"},vt={key:1,class:"detail-content loading"},mt=Z({__name:"MainUpdateTab",emits:["update-complete"],setup(I,{expose:A,emit:v}){const g=v,c=r(null),h=r(null),_=r(null),T=r([]),C=r(""),$=r(!1),b=r(!0),G=r(!1),f=r(!1),p=r(!1),D=r(!1),R=r(!1),O=r(!1),P=r(!1),m=r(""),o=r(!1),u=r(null),L=r(null);async function B(){try{const[d,e]=await Promise.all([$s(),Gs()]);d.success&&d.data&&(c.value=d.data),e.success&&e.data&&(h.value=e.data,e.data.current_branch&&(C.value=e.data.current_branch))}catch(d){console.error("加载状态失败:",d)}}function X(){p.value||($.value=!$.value)}async function es(){var d;if(!D.value){D.value=!0;try{const e=await xs();e.success&&e.data?(h.value=e.data,e.data.current_branch&&(C.value=e.data.current_branch),is("分支列表已刷新","success")):is(((d=e.data)==null?void 0:d.error)||e.error||"刷新分支列表失败","error")}catch(e){is(e.message||"刷新分支列表失败（网络可能不可用）","error")}finally{D.value=!1}}}async function y(d){var j,V;if($.value=!1,!(d===C.value||!await Y({title:"切换分支",message:`确定要切换到分支 "${d}" 吗？`,confirmText:"切换"}))){p.value=!0;try{const W=await Ss(d);W.success&&((j=W.data)!=null&&j.success)?(C.value=d,J(W.data.message||"分支切换成功"),g("update-complete",!0)):U(((V=W.data)==null?void 0:V.error)||W.error||"切换分支失败")}catch(W){U(W.message||"切换分支失败")}finally{p.value=!1}}}async function l(){G.value=!0,m.value="",_.value=null;try{const d=await Ts();d.success&&d.data?(_.value=d.data,d.data.success||(m.value=d.data.error||"检查更新失败")):m.value=d.error||"检查更新失败"}catch(d){m.value=d.message||"检查更新失败"}finally{G.value=!1}}async function q(){var e,j;if(await Y({title:"确认更新",message:"更新主程序后需要重启才能生效，是否继续？",confirmText:"更新"})){f.value=!0,m.value="";try{const V=await Us(!0,!0,!0);V.success&&((e=V.data)!=null&&e.success)?(J(V.data.message||"更新成功"),g("update-complete",!0),S()):U(((j=V.data)==null?void 0:j.error)||V.error||"更新失败")}catch(V){U(V.message||"更新失败")}finally{f.value=!1}}}async function S(){var d;O.value=!0;try{const e=await Ds();e.success&&((d=e.data)!=null&&d.data)&&(T.value=e.data.data)}catch(e){console.error("加载历史版本列表失败:",e)}finally{O.value=!1}}async function k(d){var V,W;const e=d.substring(0,7);if(await Y({title:"确认回滚",message:`确定要回滚到版本 "${e}" 吗？此操作将重置到该版本，回滚后需要重启程序。`,confirmText:"回滚"})){R.value=!0;try{const N=await Is(d);N.success&&((V=N.data)!=null&&V.success)?(J(N.data.message||"回滚成功"),g("update-complete",!0),S()):U(((W=N.data)==null?void 0:W.error)||N.error||"回滚失败")}catch(N){U(N.message||"回滚失败")}finally{R.value=!1}}}async function M(d){o.value=!0,P.value=!0,u.value=null;try{const e=await Bs(d);e.success&&e.data?u.value=e.data:(U(e.error||"获取详情失败"),o.value=!1)}catch(e){U(e.message||"获取详情失败"),o.value=!1}finally{P.value=!1}}function ds(d){if(!d)return"-";try{return new Date(d).toLocaleString("zh-CN")}catch{return d}}function ws(d){return{新增:"status-add",修改:"status-modify",删除:"status-delete",重命名:"status-rename"}[d]||""}function rs(d){L.value&&!L.value.contains(d.target)&&($.value=!1)}return ts(async()=>{var d,e;document.addEventListener("click",rs);try{await B(),S(),(d=c.value)!=null&&d.git_available&&((e=h.value)!=null&&e.is_git_repo)&&l()}finally{b.value=!1}}),Cs(()=>{document.removeEventListener("click",rs)}),A({refresh:()=>{B(),S(),_.value=null}}),(d,e)=>{var j,V,W,N,cs,vs,ms,ps,_s,fs,bs,ys;return a(),t("div",ea,[s("div",aa,[e[6]||(e[6]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"fork_right"),s("h3",null,"分支管理")],-1)),b.value?(a(),t("div",ta,[...e[2]||(e[2]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):!((j=c.value)!=null&&j.git_available)||(((W=(V=h.value)==null?void 0:V.available_branches)==null?void 0:W.length)??0)===0?(a(),t("div",la,[e[3]||(e[3]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,n((N=c.value)!=null&&N.git_available?"无可用分支":"Git 环境不可用"),1)])):(a(),t("div",na,[e[5]||(e[5]=s("label",{class:"m3-label"},"当前分支:",-1)),s("div",{class:"select-wrapper",ref_key:"branchSelectWrapper",ref:L},[s("div",{class:x(["m3-select-trigger",{disabled:p.value,active:$.value}]),onClick:X},[s("span",oa,n(C.value),1),s("span",{class:x(["material-symbols-rounded select-arrow",{rotated:$.value}])}," arrow_drop_down ",2)],2),$.value?(a(),t("div",ia,[(a(!0),t(E,null,F(((cs=h.value)==null?void 0:cs.available_branches)??[],w=>(a(),t("div",{key:w,class:x(["m3-select-option",{selected:w===C.value}]),onClick:K=>y(w)},[s("span",null,n(w),1),w===C.value?(a(),t("span",da,"check")):i("",!0)],10,ua))),128))])):i("",!0)],512),p.value?(a(),t("span",ra,[...e[4]||(e[4]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),ks(" 切换中... ",-1)])])):(a(),t("button",{key:1,class:"m3-icon-button",onClick:es,disabled:D.value,title:D.value?"刷新中...":"刷新远程分支列表"},[s("span",{class:x(["material-symbols-rounded",{spinning:D.value}])},"sync",2)],8,ca))]))]),s("div",va,[s("div",ma,[e[7]||(e[7]=s("span",{class:"material-symbols-rounded"},"sync",-1)),e[8]||(e[8]=s("h3",null,"更新检测",-1)),s("button",{class:"m3-button tonal",onClick:l,disabled:b.value||G.value||!((vs=c.value)!=null&&vs.git_available)},[s("span",{class:x(["material-symbols-rounded",{spinning:G.value}])},n(G.value?"progress_activity":"refresh"),3),s("span",null,n(G.value?"检查中...":"检查更新"),1)],8,pa)]),b.value||G.value?(a(),t("div",_a,[e[9]||(e[9]=s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1)),s("span",null,n(b.value?"加载中...":"检查更新中..."),1)])):c.value&&!c.value.git_available?(a(),t("div",fa,[...e[10]||(e[10]=[s("span",{class:"material-symbols-rounded"},"warning",-1),s("span",null,'Git 不可用，请先在"Git 设置"中配置 Git 环境',-1)])])):h.value&&!h.value.is_git_repo?(a(),t("div",ba,[...e[11]||(e[11]=[s("span",{class:"material-symbols-rounded"},"warning",-1),s("span",null,"主程序目录不是 Git 仓库，无法使用自动更新功能",-1)])])):_.value?(a(),t("div",ya,[_.value.has_update?(a(),t("div",ga,[s("div",ha,[e[13]||(e[13]=s("div",{class:"update-icon"},[s("span",{class:"material-symbols-rounded"},"auto_awesome")],-1)),s("div",ka,[e[12]||(e[12]=s("h4",null,"发现新版本",-1)),s("p",null,"有 "+n(_.value.commits_behind)+" 个新提交等待更新",1)])]),s("div",$a,[s("div",wa,[e[14]||(e[14]=s("span",{class:"version-tag"},"当前",-1)),s("code",null,n(_.value.current_commit||"未知"),1)]),e[16]||(e[16]=s("span",{class:"material-symbols-rounded arrow-icon"},"arrow_forward",-1)),s("div",Ca,[e[15]||(e[15]=s("span",{class:"version-tag"},"最新",-1)),s("code",null,n(_.value.remote_commit||"未知"),1)])]),(ms=_.value.update_logs)!=null&&ms.length?(a(),t("div",Ga,[e[17]||(e[17]=s("h4",null,"更新内容:",-1)),s("ul",null,[(a(!0),t(E,null,F(_.value.update_logs.slice(0,5),(w,K)=>(a(),t("li",{key:K},n(w),1))),128))])])):i("",!0),s("div",xa,[s("button",{class:"m3-button filled",onClick:q,disabled:f.value},[s("span",{class:x(["material-symbols-rounded",{spinning:f.value}])},n(f.value?"progress_activity":"download"),3),s("span",null,n(f.value?"更新中...":"立即更新"),1)],8,Ta)])])):(a(),t("div",Ua,[e[19]||(e[19]=s("span",{class:"material-symbols-rounded icon-success"},"check_circle",-1)),s("div",Da,[e[18]||(e[18]=s("span",null,"已是最新版本",-1)),_.value.current_commit?(a(),t("code",Sa,n(_.value.current_commit),1)):i("",!0)])]))])):i("",!0),m.value?(a(),t("div",Ia,[e[20]||(e[20]=s("span",{class:"material-symbols-rounded"},"error",-1)),s("span",null,n(m.value),1)])):i("",!0)]),s("div",Ba,[s("div",Va,[e[21]||(e[21]=s("span",{class:"material-symbols-rounded"},"history",-1)),e[22]||(e[22]=s("h3",null,"历史版本",-1)),s("button",{class:"m3-icon-button",onClick:S,disabled:b.value||O.value||!((ps=c.value)!=null&&ps.git_available)},[s("span",{class:x(["material-symbols-rounded",{spinning:O.value}])},"refresh",2)],8,Ma)]),b.value||O.value?(a(),t("div",Ra,[...e[23]||(e[23]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):!((_s=c.value)!=null&&_s.git_available)||!((fs=h.value)!=null&&fs.is_git_repo)?(a(),t("div",La,[e[24]||(e[24]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,n((bs=c.value)!=null&&bs.git_available?"当前目录非 Git 仓库":"Git 环境不可用"),1)])):T.value.length?(a(),t("div",Wa,[(a(!0),t(E,null,F(T.value,w=>(a(),t("div",{key:w.commit,class:x(["backup-item",{"is-current":w.is_current}])},[s("div",Pa,[s("div",Na,[s("code",Ea,n(w.commit_short),1),w.is_current?(a(),t("span",Fa,"当前")):i("",!0)]),s("span",za,n(w.message),1),s("span",Aa,n(ds(w.timestamp)),1)]),s("div",Oa,[s("button",{class:"m3-button text",onClick:K=>M(w.commit),disabled:P.value},[...e[25]||(e[25]=[s("span",{class:"material-symbols-rounded"},"info",-1),s("span",null,"详情",-1)])],8,Xa),s("button",{class:"m3-button text",onClick:K=>k(w.commit),disabled:R.value||w.is_current},[...e[26]||(e[26]=[s("span",{class:"material-symbols-rounded"},"restore",-1),s("span",null,"回滚",-1)])],8,ja)])],2))),128))])):(a(),t("div",qa,[...e[27]||(e[27]=[s("span",{class:"material-symbols-rounded"},"history_toggle_off",-1),s("span",null,"暂无历史版本",-1)])]))]),(a(),ls(os,{to:"body"},[o.value?(a(),t("div",{key:0,class:"detail-dialog-overlay",onClick:e[1]||(e[1]=ns(w=>o.value=!1,["self"]))},[s("div",Ha,[s("div",Ja,[e[29]||(e[29]=s("h3",null,"版本详情",-1)),s("button",{class:"m3-icon-button",onClick:e[0]||(e[0]=w=>o.value=!1)},[...e[28]||(e[28]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),u.value?(a(),t("div",Ka,[s("div",Qa,[s("div",Ya,[e[30]||(e[30]=s("span",{class:"detail-label"},"Commit:",-1)),s("code",Za,n(u.value.commit_short),1)]),s("div",st,[e[31]||(e[31]=s("span",{class:"detail-label"},"时间:",-1)),s("span",et,n(ds(u.value.timestamp)),1)]),u.value.author?(a(),t("div",at,[e[32]||(e[32]=s("span",{class:"detail-label"},"作者:",-1)),s("span",tt,n(u.value.author),1)])):i("",!0)]),u.value.message?(a(),t("div",lt,[e[33]||(e[33]=s("h4",null,"提交消息",-1)),s("p",nt,n(u.value.message),1)])):i("",!0),u.value.body?(a(),t("div",ot,[e[34]||(e[34]=s("h4",null,"更新内容",-1)),s("pre",it,n(u.value.body),1)])):i("",!0),(ys=u.value.files_changed)!=null&&ys.length?(a(),t("div",ut,[s("h4",null,"修改文件 ("+n(u.value.files_changed.length)+")",1),s("div",dt,[(a(!0),t(E,null,F(u.value.files_changed.slice(0,20),(w,K)=>(a(),t("div",{key:K,class:"file-item"},[s("span",{class:x(["file-status",ws(w.status)])},n(w.status),3),s("span",rt,n(w.path),1)]))),128)),u.value.files_changed.length>20?(a(),t("div",ct," ... 及其他 "+n(u.value.files_changed.length-20)+" 个文件 ",1)):i("",!0)])])):i("",!0)])):P.value?(a(),t("div",vt,[...e[35]||(e[35]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):i("",!0)])])):i("",!0)]))])}}}),pt=ss(mt,[["__scopeId","data-v-b3f12534"]]),_t={class:"git-settings-tab"},ft={class:"m3-card status-card"},bt={class:"card-header"},yt=["disabled"],gt={key:0,class:"status-grid"},ht={class:"status-item"},kt={class:"material-symbols-rounded"},$t={key:0,class:"status-item"},wt={class:"status-value"},Ct={class:"status-item"},Gt={class:"status-value"},xt={class:"status-item"},Tt={class:"status-value"},Ut={key:0,class:"m3-card path-card"},Dt={class:"path-content"},St={class:"path-display"},It={class:"path-value"},Bt={class:"path-actions"},Vt=["disabled"],Mt=["disabled"],Rt={key:0,class:"portable-tip"},Lt={key:2,class:"m3-card guide-card"},Wt={key:0,class:"guide-content"},Pt={key:0,class:"guide-commands"},Nt={class:"command-name"},Et={class:"command-value"},Ft=["href"],zt={class:"modal-content m3-card"},At={class:"modal-header"},Ot={class:"modal-body"},Xt={class:"input-wrapper"},jt={class:"modal-footer"},qt=["disabled"],Ht=Z({__name:"GitSettingsTab",setup(I,{expose:A}){const v=r(null),g=r(null),c=r(!1),h=r(!1),_=r(!1),T=r(!1),C=r(!1),$=r("");function b(m){return{custom:"自定义",portable:"便携版",system:"系统",unknown:"未知"}[m]||m}function G(){var o;switch((o=v.value)==null?void 0:o.system_os){case"Windows":return"下载便携版";case"Linux":return"安装 Git";case"Darwin":return"安装 Git";default:return"安装 Git"}}function f(){var o;switch((o=v.value)==null?void 0:o.system_os){case"Windows":return'未检测到 Git，可以点击上方"下载便携版"按钮安装';case"Linux":return'未检测到 Git，点击"安装 Git"将使用系统包管理器安装';case"Darwin":return'未检测到 Git，点击"安装 Git"将使用 Homebrew 或 Xcode 安装';default:return"未检测到 Git，请手动安装"}}async function p(){c.value=!0;try{const m=await $s();m.success&&m.data&&(v.value=m.data,!m.data.git_available&&m.data.system_os!=="Windows"&&D())}catch(m){console.error("加载 Git 状态失败:",m)}finally{c.value=!1}}async function D(){var m;try{const o=await sa();o.success&&((m=o.data)!=null&&m.data)&&(g.value=o.data.data)}catch(o){console.error("加载安装指南失败:",o)}}async function R(){var m,o;T.value=!0;try{const u=await Ze();u.success&&((m=u.data)!=null&&m.success)?(J(u.data.message||"已检测到 Git"),await p()):U(((o=u.data)==null?void 0:o.error)||u.error||"未检测到 Git")}catch(u){U(u.message||"检测失败")}finally{T.value=!1}}async function O(){var m,o,u,L;if((m=v.value)!=null&&m.git_available){const B=(o=v.value)==null?void 0:o.system_os;let X=`检测到您的电脑已经安装了 Git。

`;if(B==="Windows"?X+="便携版 Git 适用于没有安装 Git 的用户，如果您已经有 Git，通常不需要再下载。":B==="Linux"?X+="系统将尝试使用包管理器重新安装 Git，这可能会覆盖现有版本。":B==="Darwin"&&(X+="系统将尝试使用 Homebrew 或 Xcode 安装 Git，这可能会覆盖现有版本。"),X+=`

确定要继续吗？`,!await Y({title:"确认安装",message:X,type:"warning",confirmText:"继续安装",cancelText:"取消"}))return}h.value=!0;try{const B=await Qe();B.success&&((u=B.data)!=null&&u.success)?(J(B.data.message||"Git 安装成功"),await R()):U(((L=B.data)==null?void 0:L.error)||B.error||"安装失败")}catch(B){U(B.message||"安装失败")}finally{h.value=!1}}async function P(){var m,o;if($.value){_.value=!0;try{const u=await Ye($.value);u.success&&((m=u.data)!=null&&m.success)?(J(u.data.message||"路径设置成功"),C.value=!1,$.value="",await p()):U(((o=u.data)==null?void 0:o.error)||u.error||"设置失败")}catch(u){U(u.message||"设置失败")}finally{_.value=!1}}}return ts(()=>{p()}),A({refresh:p}),(m,o)=>(a(),t("div",_t,[s("div",ft,[s("div",bt,[o[5]||(o[5]=s("span",{class:"material-symbols-rounded"},"terminal",-1)),o[6]||(o[6]=s("h3",null,"Git 环境状态",-1)),s("button",{class:"m3-icon-button",onClick:p,disabled:c.value},[s("span",{class:x(["material-symbols-rounded",{spinning:c.value}])},"refresh",2)],8,yt)]),v.value?(a(),t("div",gt,[s("div",ht,[o[7]||(o[7]=s("span",{class:"status-label"},"状态",-1)),s("span",{class:x(["status-value",v.value.git_available?"success":"error"])},[s("span",kt,n(v.value.git_available?"check_circle":"cancel"),1),ks(" "+n(v.value.git_available?"可用":"不可用"),1)],2)]),v.value.git_version?(a(),t("div",$t,[o[8]||(o[8]=s("span",{class:"status-label"},"版本",-1)),s("span",wt,n(v.value.git_version),1)])):i("",!0),s("div",Ct,[o[9]||(o[9]=s("span",{class:"status-label"},"来源",-1)),s("span",Gt,[s("span",{class:x(["m3-badge",`source-${v.value.git_source}`])},n(b(v.value.git_source)),3)])]),s("div",xt,[o[10]||(o[10]=s("span",{class:"status-label"},"操作系统",-1)),s("span",Tt,n(v.value.system_os),1)])])):i("",!0)]),v.value?(a(),t("div",Ut,[o[14]||(o[14]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"folder"),s("h3",null,"Git 路径")],-1)),s("div",Dt,[s("div",St,[o[11]||(o[11]=s("span",{class:"path-label"},"当前路径:",-1)),s("code",It,n(v.value.git_path||"未检测到"),1)]),s("div",Bt,[s("button",{class:"m3-button tonal",onClick:R,disabled:T.value},[s("span",{class:x(["material-symbols-rounded",{spinning:T.value}])},n(T.value?"progress_activity":"search"),3),s("span",null,n(T.value?"检测中...":"自动寻找"),1)],8,Vt),s("button",{class:"m3-button tonal",onClick:o[0]||(o[0]=u=>C.value=!0)},[...o[12]||(o[12]=[s("span",{class:"material-symbols-rounded"},"edit",-1),s("span",null,"设置路径",-1)])]),s("button",{class:x(["m3-button",v.value.git_available?"tonal":"filled"]),onClick:O,disabled:h.value},[s("span",{class:x(["material-symbols-rounded",{spinning:h.value}])},n(h.value?"progress_activity":"download"),3),s("span",null,n(h.value?"安装中...":G()),1)],10,Mt)]),v.value.git_available?i("",!0):(a(),t("div",Rt,[o[13]||(o[13]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,n(f()),1)]))])])):i("",!0),i("",!0),v.value&&!v.value.git_available&&v.value.system_os!=="Windows"?(a(),t("div",Lt,[o[18]||(o[18]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"help"),s("h3",null,"安装指南")],-1)),g.value?(a(),t("div",Wt,[s("p",null,n(g.value.description),1),g.value.manual_commands?(a(),t("div",Pt,[(a(!0),t(E,null,F(g.value.manual_commands,(u,L)=>(a(),t("div",{key:L,class:"command-item"},[s("span",Nt,n(L)+":",1),s("code",Et,n(u),1)]))),128))])):i("",!0),g.value.manual_url?(a(),t("a",{key:1,href:g.value.manual_url,target:"_blank",class:"m3-button tonal"},[...o[17]||(o[17]=[s("span",{class:"material-symbols-rounded"},"open_in_new",-1),s("span",null,"官方下载",-1)])],8,Ft)):i("",!0)])):i("",!0)])):i("",!0),(a(),ls(os,{to:"body"},[C.value?(a(),t("div",{key:0,class:"modal-overlay",onClick:o[4]||(o[4]=ns(u=>C.value=!1,["self"]))},[s("div",zt,[s("div",At,[o[20]||(o[20]=s("h3",null,"设置 Git 路径",-1)),s("button",{class:"m3-icon-button",onClick:o[1]||(o[1]=u=>C.value=!1)},[...o[19]||(o[19]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),s("div",Ot,[o[21]||(o[21]=s("p",null,"请输入 Git 可执行文件的完整路径",-1)),s("div",Xt,[as(s("input",{type:"text","onUpdate:modelValue":o[2]||(o[2]=u=>$.value=u),placeholder:"例如: C:\\Program Files\\Git\\bin\\git.exe",class:"m3-input"},null,512),[[Vs,$.value]])])]),s("div",jt,[s("button",{class:"m3-button text",onClick:o[3]||(o[3]=u=>C.value=!1)},"取消"),s("button",{class:"m3-button filled",onClick:P,disabled:!$.value||_.value},n(_.value?"设置中...":"确定"),9,qt)])])])):i("",!0)]))]))}}),Jt=ss(Ht,[["__scopeId","data-v-f68aa1d1"]]),Kt={key:0,class:"dialog-content m3-card"},Qt={class:"dialog-header"},Yt={class:"material-symbols-rounded"},Zt={class:"dialog-body"},sl={class:"dialog-message"},el={key:0,class:"changelog-section"},al={class:"changelog-list"},tl={class:"tip-section"},ll=Z({__name:"RestartDialog",props:{modelValue:{type:Boolean},updateType:{default:"main"},changelog:{default:()=>[]}},emits:["update:modelValue","restart","later"],setup(I,{emit:A}){const v=I,g=A,c=H(()=>({main:"type-main",ui:"type-ui",both:"type-both"})[v.updateType]),h=H(()=>({main:"smart_toy",ui:"web",both:"system_update"})[v.updateType]),_=H(()=>({main:"主程序更新完成",ui:"UI 更新完成",both:"全部更新完成"})[v.updateType]),T=H(()=>({main:"主程序已更新成功，需要重启才能生效。",ui:"WebUI 已更新成功，需要刷新页面才能生效。",both:"主程序和 WebUI 都已更新成功，需要重启才能生效。"})[v.updateType]),C=H(()=>v.updateType==="ui"?"刷新页面后将加载新版本的 WebUI":"重启后新功能将生效，当前的连接会暂时中断");function $(){g("restart"),g("update:modelValue",!1)}function b(){g("later"),g("update:modelValue",!1)}return(G,f)=>(a(),ls(os,{to:"body"},[Q(gs,{name:"fade"},{default:hs(()=>[I.modelValue?(a(),t("div",{key:0,class:"dialog-overlay",onClick:ns(b,["self"])},[Q(gs,{name:"scale"},{default:hs(()=>[I.modelValue?(a(),t("div",Kt,[s("div",Qt,[s("div",{class:x(["dialog-icon",c.value])},[s("span",Yt,n(h.value),1)],2),s("h2",null,n(_.value),1)]),s("div",Zt,[s("p",sl,n(T.value),1),I.changelog&&I.changelog.length>0?(a(),t("div",el,[f[0]||(f[0]=s("h4",null,"更新内容:",-1)),s("ul",al,[(a(!0),t(E,null,F(I.changelog.slice(0,5),(p,D)=>(a(),t("li",{key:D},n(p),1))),128))])])):i("",!0),s("div",tl,[f[1]||(f[1]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,n(C.value),1)])]),s("div",{class:"dialog-footer"},[s("button",{class:"m3-button text",onClick:b}," 稍后重启 "),s("button",{class:"m3-button filled",onClick:$},[...f[2]||(f[2]=[s("span",{class:"material-symbols-rounded"},"restart_alt",-1),s("span",null,"立即重启",-1)])])])])):i("",!0)]),_:1})])):i("",!0)]),_:1})]))}}),nl=ss(ll,[["__scopeId","data-v-8bea0f4d"]]),ol={class:"update-view"},il={class:"tabs-nav"},ul=["onClick"],dl={class:"material-symbols-rounded"},rl={class:"tab-label"},cl={class:"tab-content"},vl=Z({__name:"GitUpdateView",setup(I){const A=[{id:"ui",label:"UI 更新",icon:"web"},{id:"main",label:"主程序",icon:"terminal"},{id:"git",label:"Git 设置",icon:"settings"}],v=r("ui"),g=r(!1),c=r("main"),h=r([]);function _(b){b&&(c.value="ui",h.value=[],g.value=!0)}function T(b){b&&(c.value="main",h.value=[],g.value=!0)}async function C(){g.value=!1;try{await Rs()}catch(b){console.error("重启失败:",b)}}function $(){g.value=!1}return ts(()=>{}),(b,G)=>(a(),t("div",ol,[G[1]||(G[1]=Ms('<div class="page-header" data-v-8d4eeec6><div class="header-content" data-v-8d4eeec6><div class="header-icon" data-v-8d4eeec6><span class="material-symbols-rounded" data-v-8d4eeec6>system_update</span></div><div class="header-text" data-v-8d4eeec6><h1 data-v-8d4eeec6>更新管理</h1><p data-v-8d4eeec6>管理 MoFox-Bot 和 WebUI 的更新</p></div></div></div>',1)),s("div",il,[(a(),t(E,null,F(A,f=>s("button",{key:f.id,class:x(["tab-item",{active:v.value===f.id}]),onClick:p=>v.value=f.id},[s("span",dl,n(f.icon),1),s("span",rl,n(f.label),1)],10,ul)),64))]),s("div",cl,[as(Q(Ke,{ref:"uiUpdateTabRef",onUpdateComplete:_},null,512),[[us,v.value==="ui"]]),as(Q(pt,{ref:"mainUpdateTabRef",onUpdateComplete:T},null,512),[[us,v.value==="main"]]),as(Q(Jt,{ref:"gitSettingsTabRef"},null,512),[[us,v.value==="git"]])]),Q(nl,{modelValue:g.value,"onUpdate:modelValue":G[0]||(G[0]=f=>g.value=f),"update-type":c.value,changelog:h.value,onRestart:C,onLater:$},null,8,["modelValue","update-type","changelog"])]))}}),yl=ss(vl,[["__scopeId","data-v-8d4eeec6"]]);export{yl as default};
