import{ab as U,aI as ue,a as de,r as u,G as L,I as R,p as me,P as _e,c as n,e as a,Y as J,Z as K,F as E,h as P,g as f,t as d,n as $,a0 as Y,x as F,L as x,o as r,_ as ve}from"./index-Oog5yepK.js";async function pe(m=100){try{const l=await U.get(`live_chat/streams?limit=${m}`);if(l.success&&l.data){const o=l.data;if(o.success&&o.streams)return o.streams}return[]}catch(l){return console.error("èŽ·å–èŠå¤©æµå¤±è´¥:",l),[]}}async function fe(m,l=24,o=200){try{const _=await U.get(`live_chat/messages/${m}?hours=${l}&limit=${o}`);if(_.success&&_.data){const v=_.data;if(v.success&&v.messages)return v.messages}return[]}catch(_){return console.error("èŽ·å–åŽ†å²æ¶ˆæ¯å¤±è´¥:",_),[]}}async function ye(m){try{const l=await U.post("live_chat/send",{stream_id:m.stream_id,content:m.content,message_type:m.message_type||"text",reply_to_id:m.reply_to_id});if(l.success&&l.data){const o=l.data;return o.success?{success:!0,messageId:o.message_id}:{success:!1,error:o.error||"å‘é€å¤±è´¥"}}return{success:!1,error:l.error||"è¯·æ±‚å¤±è´¥"}}catch(l){return console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",l),{success:!1,error:String(l)}}}async function ge(){const m=await ue(),l=localStorage.getItem("mofox_token")||"";return`ws://${m.host}:${m.port}/plugins/webui_backend/live_chat/realtime?token=${encodeURIComponent(l)}`}function he(m){return m.replace(/token=[^&]+/,"token=***")}const be={class:"live-chat-view"},ke={class:"stream-panel m3-card"},we={class:"search-box"},Se={class:"platform-filter"},Ce=["onClick"],$e={class:"stream-list"},xe=["onClick"],Te={class:"stream-icon"},Me={class:"material-symbols-rounded"},We={class:"stream-info"},Ne={class:"stream-header-row"},Ie={class:"stream-name"},Le={key:0,class:"last-active"},Ee={class:"stream-meta"},Pe={class:"platform-badge"},Ue={key:0,class:"unread-badge"},De={key:0,class:"empty-state"},Oe={class:"chat-panel"},je={class:"chat-header m3-card"},He={key:0,class:"header-content"},Ve={class:"stream-icon large"},ze={class:"material-symbols-rounded"},Be={class:"stream-info"},Ae={class:"stream-id"},Re={key:1,class:"header-placeholder"},Je={class:"header-actions"},Ke={class:"material-symbols-rounded"},Ye={key:0,class:"welcome-state"},Fe={key:1,class:"loading-state"},Ge={key:2,class:"messages-list"},Qe=["onClick"],Xe={class:"reply-text"},Ze={class:"message-header"},qe={class:"user-name"},es={key:0,class:"sender-badge bot"},ss={key:1,class:"sender-badge webui"},ts={class:"message-time"},as={class:"message-content"},os=["src","onClick"],ns=["src"],rs={key:2,class:"text-content"},ls={key:0,class:"empty-messages"},is={key:0,class:"input-area m3-card"},cs={class:"input-toolbar"},us={class:"input-wrapper"},ds=["onKeydown"],ms=["disabled"],G=10,_s=de({__name:"LiveChatView",setup(m){const l=u([]),o=u(null),_=u(""),v=u(""),D=u(!1),g=u(new Map),T=u(!1),h=u({}),p=u(""),w=u(!1),Q=u(!1),X=u(!1),b=u(!1);let i=null,M=null,k=0,S=null;const C=u(null),O=u(null),Z=u(new Map),q=L(()=>{const t=new Set([""]);return l.value.forEach(e=>{e.platform&&t.add(e.platform)}),Array.from(t)}),j=L(()=>l.value.filter(t=>{if(v.value&&t.platform!==v.value)return!1;if(_.value){const e=_.value.toLowerCase(),s=(t.group_name||t.user_nickname||"").toLowerCase(),c=t.stream_id.toLowerCase();if(!s.includes(e)&&!c.includes(e))return!1}return!0})),W=L(()=>o.value?g.value.get(o.value.stream_id)||[]:[]);async function H(){D.value=!0;try{l.value=await pe(100)}catch(t){console.error("èŽ·å–èŠå¤©æµå¤±è´¥:",t)}finally{D.value=!1}}function ee(t){o.value=t,h.value[t.stream_id]=0,N(),te(t.stream_id)}async function N(){if(o.value){T.value=!0;try{const t=o.value.stream_id,e=await fe(t,24,200);console.log(`åŠ è½½èŠå¤©æµ ${t} çš„åŽ†å²æ¶ˆæ¯ï¼Œå…± ${e.length} æ¡`),g.value.set(t,e),await x(),B()}catch(t){console.error("èŽ·å–åŽ†å²æ¶ˆæ¯å¤±è´¥:",t)}finally{T.value=!1}}}async function V(){if(!(!p.value.trim()||!o.value||w.value)){w.value=!0;try{const t=await ye({stream_id:o.value.stream_id,content:p.value.trim(),message_type:"text"});t.success?(p.value="",x(A)):console.error("å‘é€å¤±è´¥:",t.error)}catch(t){console.error("å‘é€æ¶ˆæ¯å¤±è´¥:",t)}finally{w.value=!1}}}async function z(){if((i==null?void 0:i.readyState)!==WebSocket.OPEN)try{const t=await ge();console.log("è¿žæŽ¥ WebSocket:",he(t)),i=new WebSocket(t),i.onopen=()=>{var s;console.log("WebSocket å·²è¿žæŽ¥"),b.value=!0,k=0;const e=S||((s=o.value)==null?void 0:s.stream_id);e&&(i.send(JSON.stringify({type:"subscribe",stream_id:e})),S=null)},i.onmessage=e=>{try{const s=JSON.parse(e.data);se(s)}catch(s){e.data!=="pong"&&console.error("è§£æž WebSocket æ¶ˆæ¯å¤±è´¥:",s)}},i.onclose=()=>{console.log("WebSocket å·²æ–­å¼€"),b.value=!1,ae()},i.onerror=e=>{console.error("WebSocket é”™è¯¯:",e)}}catch(t){console.error("è¿žæŽ¥ WebSocket å¤±è´¥:",t)}}function se(t){var e;if(t.type==="message"){const s=t,c=s.stream_id;if(!c)return;g.value.has(c)||g.value.set(c,[]);const y=g.value.get(c);y.some(I=>I.message_id===s.message_id)||(y.push(s),((e=o.value)==null?void 0:e.stream_id)===c?x(()=>B()):h.value[c]=(h.value[c]||0)+1)}else t.type==="subscribed"&&console.log("å·²è®¢é˜…èŠå¤©æµ:",t.stream_id)}function te(t){(i==null?void 0:i.readyState)===WebSocket.OPEN?(i.send(JSON.stringify({type:"subscribe",stream_id:t})),S=null):(S=t,console.log("å¾…è®¢é˜…èŠå¤©æµ:",t))}function ae(){if(k>=G){console.error("WebSocket é‡è¿žæ¬¡æ•°è¶…è¿‡é™åˆ¶");return}const t=Math.min(1e3*Math.pow(2,k),3e4);k++,console.log(`å°†åœ¨ ${t}ms åŽé‡è¿ž (å°è¯• ${k}/${G})`),M=window.setTimeout(()=>{z()},t)}function oe(){setInterval(()=>{(i==null?void 0:i.readyState)===WebSocket.OPEN&&i.send("ping")},3e4)}function B(){C.value&&(C.value.scrollTop=C.value.scrollHeight)}function ne(t){console.log("æ»šåŠ¨åˆ°æ¶ˆæ¯:",t)}function re(t){var c,y;const e=Z.value.get(t);if(e)return`${e.user_nickname}: ${(c=e.content)==null?void 0:c.slice(0,30)}...`;const s=W.value.find(I=>I.message_id===t);return s?`${s.user_nickname}: ${(y=s.content)==null?void 0:y.slice(0,30)}...`:"æŸ¥çœ‹åŽŸæ¶ˆæ¯"}function le(t){console.log("é¢„è§ˆå›¾ç‰‡:",t)}function ie(t){if(!t)return"";const e=new Date(t*1e3),s=new Date;return e.toDateString()===s.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN",{month:"short",day:"numeric"})}function ce(t){return t?new Date(t*1e3).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"}):""}function A(){const t=O.value;if(!t)return;t.style.height="auto";const e=t.scrollHeight;t.style.height=e+"px",e>150?t.style.overflowY="auto":t.style.overflowY="hidden"}return R(p,()=>{x(A)}),me(()=>{H(),z(),oe()}),_e(()=>{i&&(i.close(),i=null),M&&clearTimeout(M)}),R(o,t=>{t&&N()}),(t,e)=>(r(),n("div",be,[a("aside",ke,[a("div",{class:"panel-header"},[e[6]||(e[6]=a("div",{class:"header-content"},[a("span",{class:"material-symbols-rounded"},"forum"),a("h2",null,"èŠå¤©æµ")],-1)),a("button",{class:"m3-button icon-only",onClick:H,title:"åˆ·æ–°åˆ—è¡¨"},[...e[5]||(e[5]=[a("span",{class:"material-symbols-rounded"},"refresh",-1)])])]),a("div",we,[e[7]||(e[7]=a("span",{class:"material-symbols-rounded"},"search",-1)),J(a("input",{"onUpdate:modelValue":e[0]||(e[0]=s=>_.value=s),type:"text",placeholder:"æœç´¢èŠå¤©æµ..."},null,512),[[K,_.value]])]),a("div",Se,[(r(!0),n(E,null,P(q.value,s=>(r(),n("button",{key:s,class:$(["filter-chip",{active:v.value===s}]),onClick:c=>v.value=v.value===s?"":s},d(s||"å…¨éƒ¨"),11,Ce))),128))]),a("div",$e,[(r(!0),n(E,null,P(j.value,s=>{var c;return r(),n("div",{key:s.stream_id,class:$(["stream-item",{active:((c=o.value)==null?void 0:c.stream_id)===s.stream_id}]),onClick:y=>ee(s)},[a("div",Te,[a("span",Me,d(s.group_id?"group":"person"),1)]),a("div",We,[a("div",Ne,[a("div",Ie,d(s.group_name||s.user_nickname||"æœªçŸ¥"),1),s.last_active_time?(r(),n("span",Le,d(ie(s.last_active_time)),1)):f("",!0)]),a("div",Ee,[a("span",Pe,d(s.platform),1)])]),h.value[s.stream_id]?(r(),n("div",Ue,d(h.value[s.stream_id]),1)):f("",!0)],10,xe)}),128)),j.value.length===0?(r(),n("div",De,[...e[8]||(e[8]=[a("span",{class:"material-symbols-rounded"},"inbox",-1),a("p",null,"æš‚æ— èŠå¤©æµ",-1)])])):f("",!0)])]),a("main",Oe,[a("header",je,[o.value?(r(),n("div",He,[a("div",Ve,[a("span",ze,d(o.value.group_id?"group":"person"),1)]),a("div",Be,[a("h2",null,d(o.value.group_name||o.value.user_nickname||"æœªçŸ¥"),1),a("p",Ae,d(o.value.stream_id),1)])])):(r(),n("div",Re,[...e[9]||(e[9]=[a("span",{class:"material-symbols-rounded"},"chat",-1),a("span",null,"å³æ—¶é€šè®¯",-1)])])),a("div",Je,[a("div",{class:$(["connection-status",{connected:b.value}])},[a("span",Ke,d(b.value?"wifi":"wifi_off"),1),a("span",null,d(b.value?"å·²è¿žæŽ¥":"æœªè¿žæŽ¥"),1)],2),a("button",{class:"m3-button icon-only",onClick:N,title:"åŠ è½½åŽ†å²æ¶ˆæ¯"},[...e[10]||(e[10]=[a("span",{class:"material-symbols-rounded"},"history",-1)])])])]),a("div",{class:"messages-container",ref_key:"messagesContainer",ref:C},[o.value?T.value?(r(),n("div",Fe,[...e[12]||(e[12]=[a("div",{class:"spinner"},null,-1),a("p",null,"åŠ è½½æ¶ˆæ¯ä¸­...",-1)])])):(r(),n("div",Ge,[(r(!0),n(E,null,P(W.value,s=>(r(),n("div",{key:s.message_id,class:$(["message",{"is-incoming":s.direction==="incoming","is-outgoing":s.direction==="outgoing","is-bot":s.sender_type==="bot","is-webui":s.sender_type==="webui"}])},[s.reply_to_id?(r(),n("div",{key:0,class:"reply-preview",onClick:c=>ne(s.reply_to_id)},[e[13]||(e[13]=a("span",{class:"material-symbols-rounded"},"reply",-1)),a("span",Xe,d(re(s.reply_to_id)),1)],8,Qe)):f("",!0),a("div",Ze,[a("span",qe,d(s.user_nickname||"æœªçŸ¥ç”¨æˆ·"),1),s.sender_type==="bot"?(r(),n("span",es,"ðŸ¤– Bot")):f("",!0),s.sender_type==="webui"?(r(),n("span",ss,"ðŸ“± WebUI")):f("",!0),a("span",ts,d(ce(s.timestamp)),1)]),a("div",as,[s.is_picid&&s.image_data?(r(),n("img",{key:0,src:s.image_data,class:"message-image",onClick:c=>le(s.content||""),loading:"lazy"},null,8,os)):s.is_emoji&&s.emoji_data?(r(),n("img",{key:1,src:s.emoji_data,class:"message-emoji"},null,8,ns)):(r(),n("span",rs,d(s.content||s.display_message),1))])],2))),128)),W.value.length===0?(r(),n("div",ls,[...e[14]||(e[14]=[a("span",{class:"material-symbols-rounded"},"chat_bubble_outline",-1),a("p",null,"æš‚æ— æ¶ˆæ¯",-1)])])):f("",!0)])):(r(),n("div",Ye,[...e[11]||(e[11]=[a("span",{class:"material-symbols-rounded"},"forum",-1),a("h3",null,"å³æ—¶é€šè®¯",-1),a("p",null,"é€‰æ‹©ä¸€ä¸ªèŠå¤©æµæŸ¥çœ‹å®žæ—¶æ¶ˆæ¯",-1)])]))],512),o.value?(r(),n("div",is,[a("div",cs,[a("button",{class:"m3-icon-button",onClick:e[1]||(e[1]=s=>Q.value=!0),title:"å‘é€å›¾ç‰‡"},[...e[15]||(e[15]=[a("span",{class:"material-symbols-rounded"},"image",-1)])]),a("button",{class:"m3-icon-button",onClick:e[2]||(e[2]=s=>X.value=!0),title:"å‘é€è¡¨æƒ…"},[...e[16]||(e[16]=[a("span",{class:"material-symbols-rounded"},"mood",-1)])])]),a("div",us,[J(a("textarea",{"onUpdate:modelValue":e[3]||(e[3]=s=>p.value=s),placeholder:"è¾“å…¥æ¶ˆæ¯...",onKeydown:[Y(F(V,["exact"]),["enter"]),e[4]||(e[4]=Y(F(s=>p.value+=`
`,["shift","exact","prevent"]),["enter"]))],rows:"1",ref_key:"inputTextarea",ref:O},null,40,ds),[[K,p.value]])]),a("button",{class:"m3-button filled send-button",onClick:V,disabled:!p.value.trim()||w.value},[...e[17]||(e[17]=[a("span",{class:"material-symbols-rounded"},"send",-1)])],8,ms)])):f("",!0)])]))}}),ps=ve(_s,[["__scopeId","data-v-9141a1e7"]]);export{ps as default};
