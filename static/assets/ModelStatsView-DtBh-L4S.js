import{S as D,a as as,r as b,G as os,m as ls,c as d,e as s,g as E,F as x,h as A,L as S,n as k,t as l,s as is,W as ns,X as ds,J as z,o as r,_ as rs}from"./index-CLTUvmfq.js";import{b as G}from"./dialog-BHZSvFQz.js";import"./index-B-U4Ta6B.js";import{i as $,L as X}from"./install-C00Tj0d-.js";import"./ConfirmDialog-CVrd_dnE.js";import"./iconify-D-PHLALP.js";const N={MODEL_USAGE:"model_stats/model_usage",PROVIDER_STATS:"model_stats/provider_stats",MODULE_STATS:"model_stats/module_stats",CHART_DATA:"model_stats/chart_data"};async function cs(g="24h"){return D.get(`${N.MODEL_USAGE}?time_range=${g}`)}async function vs(g="24h"){return D.get(`${N.PROVIDER_STATS}?time_range=${g}`)}async function us(g="24h"){return D.get(`${N.MODULE_STATS}?time_range=${g}`)}async function _s(g="24h"){return D.get(`${N.CHART_DATA}?time_range=${g}`)}const ms={class:"model-stats-view"},ps={class:"view-header"},bs={class:"header-actions"},fs={class:"time-range-selector"},ys=["onClick"],gs=["disabled"],ks={key:0,class:"overview-section"},hs={class:"overview-grid"},Ts={class:"overview-card"},Cs={class:"card-content"},ws={class:"value primary"},xs={class:"overview-card"},As={class:"card-content"},Ss={class:"value secondary"},Ms={class:"overview-card"},Os={class:"card-content"},Rs={class:"value tertiary"},Es={class:"overview-card"},$s={class:"card-content"},Ds={class:"value error"},Ns={class:"overview-card"},Ps={class:"card-content"},Ls={class:"value"},Bs={key:1,class:"tabs-container"},js={class:"tabs"},Fs={class:"stats-content"},Vs={key:0,class:"loading-state"},Is={key:1,class:"tab-content"},Us={class:"stats-grid"},qs=["onClick"],zs={class:"card-header"},Gs={class:"model-info"},Xs={class:"model-name"},Hs={class:"card-body"},Ks={class:"stat-row"},Js={class:"stat-item"},Ws={class:"value"},Zs={class:"stat-item"},Qs={class:"value"},Ys={class:"stat-row"},st={class:"stat-item"},tt={class:"value"},et={class:"stat-item"},at={class:"value"},ot={class:"stat-row total-row"},lt={class:"stat-item"},it={class:"value highlight"},nt={key:2,class:"tab-content"},dt={class:"provider-grid"},rt={class:"card-header"},ct={class:"provider-info"},vt={class:"provider-name"},ut={class:"card-body"},_t={class:"stat-grid-2col"},mt={class:"stat-item-card"},pt={class:"value"},bt={class:"stat-item-card"},ft={class:"value"},yt={class:"stat-item-card"},gt={class:"value"},kt={class:"stat-item-card"},ht={class:"value"},Tt={key:3,class:"tab-content"},Ct={class:"module-grid"},wt={class:"card-header"},xt={class:"module-info"},At={class:"module-name"},St={class:"card-body"},Mt={class:"stat-grid-2col"},Ot={class:"stat-item-card"},Rt={class:"value"},Et={class:"stat-item-card"},$t={class:"value"},Dt={class:"stat-item-card"},Nt={class:"value"},Pt={class:"stat-item-card"},Lt={class:"value"},Bt={key:4,class:"tab-content"},jt={class:"charts-container"},Ft={class:"chart-card"},Vt={class:"chart-card"},It={class:"chart-card wide"},Ut={class:"chart-card wide"},qt={key:5,class:"empty-state"},zt={class:"dialog-content"},Gt={class:"detail-body-layout"},Xt={class:"stats-section"},Ht={class:"detail-header"},Kt={class:"detail-title"},Jt={class:"detail-name"},Wt={class:"detail-badges"},Zt={class:"detail-badge"},Qt={class:"detail-grid"},Yt={class:"detail-card filled"},se={class:"detail-value"},te={class:"detail-card"},ee={class:"detail-value"},ae={class:"detail-card"},oe={class:"detail-value"},le={class:"detail-card"},ie={class:"detail-value"},ne={key:0,class:"tasks-section"},de={class:"tasks-grid"},re={class:"task-name"},ce=as({__name:"ModelStatsView",setup(g){const w=b(!1),f=b(null),M=b({}),V=b({}),y=b({}),v=b(null),O=b({}),_=b("models"),h=b("24h"),H=[{value:"1h",label:"1小时"},{value:"24h",label:"24小时"},{value:"7d",label:"7天"},{value:"30d",label:"30天"},{value:"all",label:"全部"}],P=b(null),L=b(null),B=b(null),j=b(null),T=b({totalCalls:0,totalTokens:0,totalCost:0,tokenEfficiency:"0.00x",consumeRatio:"0.00",avgTokensPerCall:0}),K=()=>{if(!f.value)return;let e=0,t=0,a=0,o=0,p=0;Object.values(f.value).forEach(n=>{e+=n.total_calls||0,t+=n.total_tokens||0,o+=n.prompt_tokens||0,p+=n.completion_tokens||0}),Object.keys(M.value).length>0&&Object.values(M.value).forEach(n=>{a+=n.total_cost||0});const i=o>0?(p/o).toFixed(3)+"x":"0.000x",u=e>0?(t/e/1e3).toFixed(2):"0.00",c=e>0?Math.round(t/e):0;T.value={totalCalls:e,totalTokens:t,totalCost:a,tokenEfficiency:i,consumeRatio:u,avgTokensPerCall:c}},m=e=>e>=1e6?(e/1e6).toFixed(2)+"M":e>=1e3?(e/1e3).toFixed(2)+"K":e.toString(),I=e=>!e.total_calls||e.total_calls===0?0:Math.round(e.total_tokens/e.total_calls),R=async()=>{var e;w.value=!0;try{const[t,a,o,p,i]=await Promise.all([cs(h.value),ns(),vs(h.value),us(h.value),_s(h.value)]);if(t.success&&t.data?f.value=t.data.stats:G("获取模型数据失败: "+(t.error||"未知错误")),o.success&&o.data&&(M.value=o.data.stats||{}),p.success&&p.data&&(V.value=p.data.stats||{}),i.success&&i.data&&(y.value=i.data.chart_data||{}),K(),a.success&&a.data){const u=a.data.configs.filter(c=>c.path==="mofox_bot_config.yaml"||c.path.includes("model_config"));for(const c of u){const n=await ds(c.path);n.success&&((e=n.data)!=null&&e.content)&&J(n.data.content)}}_.value==="charts"&&(await z(),q())}catch(t){G("网络请求失败: "+t)}finally{w.value=!1}},J=e=>{const t={...O.value},a={};Array.isArray(e.models)&&e.models.forEach(i=>{i.name&&i.model_identifier&&(a[i.name]=i.model_identifier)});const o=(i,u)=>{const c=a[i]||i;t[c]||(t[c]=[]),t[c].includes(u)||t[c].push(u)};if(e.model_task_config&&typeof e.model_task_config=="object"){const i=e.model_task_config,u={replyer:"主回复 (Replyer)",planner:"规划 (Planner)",emotion:"情感分析 (Emotion)",mood:"心情 (Mood)",maizone:"MaiZone",tool_use:"工具调用 (Tool Use)",anti_injection:"反注入 (Anti-Injection)",vlm:"视觉识别 (VLM)",emoji_vlm:"表情包识别 (Emoji VLM)",utils_video:"视频处理",voice:"语音 (Voice)",embedding:"向量 (Embedding)",memory_short_term_builder:"短时记忆构建",memory_short_term_decider:"短时记忆决策",memory_long_term:"长时记忆",summary:"总结 (Summary)",translate:"翻译 (Translate)"};for(const[c,n]of Object.entries(i))if(n&&typeof n=="object"){const C=n.model;if(C&&typeof C=="string"){const es=u[c]||c;o(C,es)}}}const p=(i,u)=>{if(!(typeof i!="object"||i===null)&&!(u.length===0&&i===e.model_task_config)&&!u.includes("model_task_config")&&!(u.length===0&&i===e.models))for(const[c,n]of Object.entries(i))if(c==="model"&&typeof n=="string"){const C=u.length>0?u[u.length-1]:"Unknown";C&&o(n,C)}else typeof n=="object"&&n!==null&&p(n,[...u,c])};p(e,[]),console.log("[ModelStats] Analyzed tasks:",t),O.value=t},W=(e,t)=>{v.value={name:e,stats:t}},U=()=>{v.value=null},F=e=>O.value?O.value[e]||[]:[],Z=e=>{h.value=e,R()},q=()=>{Q(),Y(),ss(),ts()},Q=()=>{if(!P.value||!y.value.pie_chart_cost_by_provider)return;const e=$(P.value),t=y.value.pie_chart_cost_by_provider,a={tooltip:{trigger:"item",formatter:"{b}: ${c} ({d}%)"},legend:{orient:"vertical",left:"left"},series:[{name:"成本分布",type:"pie",radius:"60%",data:t.labels?t.labels.map((o,p)=>({name:o,value:t.data[p]})):[],emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};e.setOption(a)},Y=()=>{if(!L.value||!y.value.pie_chart_req_by_provider)return;const e=$(L.value),t=y.value.pie_chart_req_by_provider,a={tooltip:{trigger:"item",formatter:"{b}: {c} 次 ({d}%)"},legend:{orient:"vertical",left:"left"},series:[{name:"请求分布",type:"pie",radius:["40%","70%"],data:t.labels?t.labels.map((o,p)=>({name:o,value:t.data[p]})):[],emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};e.setOption(a)},ss=()=>{if(!B.value||!y.value.bar_chart_cost_by_model)return;const e=$(B.value),t=y.value.bar_chart_cost_by_model,a={tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:"{b}: ${c}"},grid:{containLabel:!0,left:"3%",right:"4%",bottom:"3%"},xAxis:{type:"value",name:"成本 ($)"},yAxis:{type:"category",data:t.labels||[],axisLabel:{interval:0}},series:[{name:"成本",type:"bar",data:t.data||[],itemStyle:{color:new X(1,0,0,0,[{offset:0,color:"#83bff6"},{offset:.5,color:"#188df0"},{offset:1,color:"#188df0"}])}}]};e.setOption(a)},ts=()=>{if(!j.value||!y.value.bar_chart_avg_response_time)return;const e=$(j.value),t=y.value.bar_chart_avg_response_time,a={tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:"{b}: {c}s"},grid:{containLabel:!0,left:"3%",right:"4%",bottom:"3%"},xAxis:{type:"value",name:"响应时间 (秒)"},yAxis:{type:"category",data:t.labels||[],axisLabel:{interval:0}},series:[{name:"平均响应时间",type:"bar",data:t.data||[],itemStyle:{color:new X(1,0,0,0,[{offset:0,color:"#f093fb"},{offset:.5,color:"#f5576c"},{offset:1,color:"#f5576c"}])}}]};e.setOption(a)};return os(_,async e=>{e==="charts"&&(await z(),q())}),ls(()=>{R()}),(e,t)=>(r(),d("div",ms,[s("div",ps,[t[6]||(t[6]=s("div",{class:"header-content"},[s("h2",null,"模型统计"),s("p",{class:"subtitle"},"查看模型使用情况、成本分析和性能指标")],-1)),s("div",bs,[s("div",fs,[(r(),d(x,null,A(H,a=>s("button",{key:a.value,class:k(["time-range-button",{active:h.value===a.value}]),onClick:o=>Z(a.value)},l(a.label),11,ys)),64))]),s("button",{class:"m3-button filled",onClick:R,disabled:w.value},[s("span",{class:k(["material-symbols-rounded",{spinning:w.value}])},"refresh",2),t[5]||(t[5]=S(" 刷新数据 ",-1))],8,gs)])]),f.value&&Object.keys(f.value).length>0?(r(),d("div",ks,[s("div",hs,[s("div",Ts,[t[9]||(t[9]=s("div",{class:"card-icon",style:{background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)"}},[s("span",{class:"material-symbols-rounded"},"api")],-1)),s("div",Cs,[t[7]||(t[7]=s("div",{class:"label"},"总调用次数",-1)),s("div",ws,l(m(T.value.totalCalls)),1),t[8]||(t[8]=s("div",{class:"description"},"模型接口总调用",-1))])]),s("div",xs,[t[12]||(t[12]=s("div",{class:"card-icon",style:{background:"linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"}},[s("span",{class:"material-symbols-rounded"},"token")],-1)),s("div",As,[t[10]||(t[10]=s("div",{class:"label"},"总Token消耗",-1)),s("div",Ss,l(m(T.value.totalTokens)),1),t[11]||(t[11]=s("div",{class:"description"},"累计处理Token数",-1))])]),s("div",Ms,[t[15]||(t[15]=s("div",{class:"card-icon",style:{background:"linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)"}},[s("span",{class:"material-symbols-rounded"},"insights")],-1)),s("div",Os,[t[13]||(t[13]=s("div",{class:"label"},"Token效率",-1)),s("div",Rs,l(T.value.tokenEfficiency),1),t[14]||(t[14]=s("div",{class:"description"},"输出/输入比率",-1))])]),s("div",Es,[t[18]||(t[18]=s("div",{class:"card-icon",style:{background:"linear-gradient(135deg, #fa709a 0%, #fee140 100%)"}},[s("span",{class:"material-symbols-rounded"},"payments")],-1)),s("div",$s,[t[16]||(t[16]=s("div",{class:"label"},"总成本",-1)),s("div",Ds,"$"+l(T.value.totalCost.toFixed(4)),1),t[17]||(t[17]=s("div",{class:"description"},"累计消费金额",-1))])]),s("div",Ns,[t[21]||(t[21]=s("div",{class:"card-icon",style:{background:"linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)"}},[s("span",{class:"material-symbols-rounded"},"analytics")],-1)),s("div",Ps,[t[19]||(t[19]=s("div",{class:"label"},"平均单次Token",-1)),s("div",Ls,l(T.value.avgTokensPerCall),1),t[20]||(t[20]=s("div",{class:"description"},"每次调用平均消耗",-1))])])])])):E("",!0),f.value&&Object.keys(f.value).length>0?(r(),d("div",Bs,[s("div",js,[s("button",{class:k(["tab",{active:_.value==="models"}]),onClick:t[0]||(t[0]=a=>_.value="models")},[...t[22]||(t[22]=[s("span",{class:"material-symbols-rounded"},"model_training",-1),S(" 模型统计 ",-1)])],2),s("button",{class:k(["tab",{active:_.value==="providers"}]),onClick:t[1]||(t[1]=a=>_.value="providers")},[...t[23]||(t[23]=[s("span",{class:"material-symbols-rounded"},"cloud",-1),S(" 提供商分析 ",-1)])],2),s("button",{class:k(["tab",{active:_.value==="modules"}]),onClick:t[2]||(t[2]=a=>_.value="modules")},[...t[24]||(t[24]=[s("span",{class:"material-symbols-rounded"},"extension",-1),S(" 模块使用 ",-1)])],2),s("button",{class:k(["tab",{active:_.value==="charts"}]),onClick:t[3]||(t[3]=a=>_.value="charts")},[...t[25]||(t[25]=[s("span",{class:"material-symbols-rounded"},"bar_chart",-1),S(" 图表分析 ",-1)])],2)])])):E("",!0),s("div",Fs,[w.value&&!f.value?(r(),d("div",Vs,[...t[26]||(t[26]=[s("span",{class:"material-symbols-rounded spinning",style:{"font-size":"48px"}},"progress_activity",-1),s("p",null,"加载统计数据中...",-1)])])):f.value&&Object.keys(f.value).length>0&&_.value==="models"?(r(),d("div",Is,[s("div",Us,[(r(!0),d(x,null,A(Object.entries(f.value),([a,o])=>(r(),d("div",{key:a,class:"model-card",onClick:p=>W(a,o)},[s("div",zs,[s("div",Gs,[t[27]||(t[27]=s("span",{class:"material-symbols-rounded model-icon"},"smart_toy",-1)),s("h3",Xs,l(a),1)])]),s("div",Hs,[s("div",Ks,[s("div",Js,[t[28]||(t[28]=s("span",{class:"label"},"调用次数",-1)),s("span",Ws,l(o.total_calls?m(o.total_calls):"N/A"),1)]),s("div",Zs,[t[29]||(t[29]=s("span",{class:"label"},"平均Token",-1)),s("span",Qs,l(I(o)),1)])]),t[33]||(t[33]=s("div",{class:"stat-divider"},null,-1)),s("div",Ys,[s("div",st,[t[30]||(t[30]=s("span",{class:"label"},"输入Token",-1)),s("span",tt,l(o.prompt_tokens?m(o.prompt_tokens):"N/A"),1)]),s("div",et,[t[31]||(t[31]=s("span",{class:"label"},"输出Token",-1)),s("span",at,l(o.completion_tokens?m(o.completion_tokens):"N/A"),1)])]),t[34]||(t[34]=s("div",{class:"stat-divider"},null,-1)),s("div",ot,[s("div",lt,[t[32]||(t[32]=s("span",{class:"label"},"总Token",-1)),s("span",it,l(o.total_tokens?m(o.total_tokens):"N/A"),1)])])])],8,qs))),128))])])):_.value==="providers"?(r(),d("div",nt,[s("div",dt,[(r(!0),d(x,null,A(Object.entries(M.value),([a,o])=>(r(),d("div",{key:a,class:"provider-card"},[s("div",rt,[s("div",ct,[t[35]||(t[35]=s("span",{class:"material-symbols-rounded provider-icon"},"cloud_circle",-1)),s("h3",vt,l(a),1)])]),s("div",ut,[s("div",_t,[s("div",mt,[t[36]||(t[36]=s("span",{class:"label"},"总调用",-1)),s("span",pt,l(o.total_calls?m(o.total_calls):"N/A"),1)]),s("div",bt,[t[37]||(t[37]=s("span",{class:"label"},"总Token",-1)),s("span",ft,l(o.total_tokens?m(o.total_tokens):"N/A"),1)]),s("div",yt,[t[38]||(t[38]=s("span",{class:"label"},"总成本",-1)),s("span",gt,"$"+l(o.total_cost.toFixed(4)),1)]),s("div",kt,[t[39]||(t[39]=s("span",{class:"label"},"平均响应",-1)),s("span",ht,l(o.avg_time.toFixed(2))+"s",1)])])])]))),128))])])):_.value==="modules"?(r(),d("div",Tt,[s("div",Ct,[(r(!0),d(x,null,A(Object.entries(V.value),([a,o])=>(r(),d("div",{key:a,class:"module-card"},[s("div",wt,[s("div",xt,[t[40]||(t[40]=s("span",{class:"material-symbols-rounded module-icon"},"widgets",-1)),s("h3",At,l(a),1)])]),s("div",St,[s("div",Mt,[s("div",Ot,[t[41]||(t[41]=s("span",{class:"label"},"调用次数",-1)),s("span",Rt,l(m(o.total_calls)),1)]),s("div",Et,[t[42]||(t[42]=s("span",{class:"label"},"Token消耗",-1)),s("span",$t,l(m(o.total_tokens)),1)]),s("div",Dt,[t[43]||(t[43]=s("span",{class:"label"},"总成本",-1)),s("span",Nt,"$"+l(o.total_cost.toFixed(4)),1)]),s("div",Pt,[t[44]||(t[44]=s("span",{class:"label"},"平均时间",-1)),s("span",Lt,l(o.avg_time.toFixed(2))+"s",1)])])])]))),128))])])):_.value==="charts"?(r(),d("div",Bt,[s("div",jt,[s("div",Ft,[t[45]||(t[45]=s("div",{class:"chart-header"},[s("h3",null,"成本分布 (按提供商)"),s("span",{class:"chart-subtitle"},"Pie Chart")],-1)),s("div",{class:"chart-body",ref_key:"costByProviderChart",ref:P},null,512)]),s("div",Vt,[t[46]||(t[46]=s("div",{class:"chart-header"},[s("h3",null,"请求分布 (按提供商)"),s("span",{class:"chart-subtitle"},"Doughnut Chart")],-1)),s("div",{class:"chart-body",ref_key:"reqByProviderChart",ref:L},null,512)]),s("div",It,[t[47]||(t[47]=s("div",{class:"chart-header"},[s("h3",null,"模型成本对比"),s("span",{class:"chart-subtitle"},"Bar Chart")],-1)),s("div",{class:"chart-body",ref_key:"costByModelChart",ref:B},null,512)]),s("div",Ut,[t[48]||(t[48]=s("div",{class:"chart-header"},[s("h3",null,"平均响应时间"),s("span",{class:"chart-subtitle"},"Bar Chart")],-1)),s("div",{class:"chart-body",ref_key:"avgResponseTimeChart",ref:j},null,512)])])])):(r(),d("div",qt,[t[49]||(t[49]=s("span",{class:"material-symbols-rounded empty-icon"},"inbox",-1)),t[50]||(t[50]=s("p",null,"暂无统计数据",-1)),s("button",{class:"m3-button filled",onClick:R},"立即获取")]))]),v.value?(r(),d("div",{key:2,class:"m3-dialog-overlay",onClick:U},[s("div",{class:k(["m3-dialog",{"has-tasks":F(v.value.name).length>0}]),onClick:t[4]||(t[4]=is(()=>{},["stop"]))},[s("div",{class:"dialog-header"},[t[52]||(t[52]=s("h3",null,"模型详情",-1)),s("button",{class:"m3-icon-button",onClick:U},[...t[51]||(t[51]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),s("div",zt,[s("div",Gt,[s("div",Xt,[s("div",Ht,[t[53]||(t[53]=s("span",{class:"material-symbols-rounded detail-icon"},"smart_toy",-1)),s("div",Kt,[s("div",Jt,l(v.value.name),1),s("div",Wt,[s("span",Zt,l(v.value.stats.total_calls?m(v.value.stats.total_calls):"N/A")+" 次调用",1)])])]),t[58]||(t[58]=s("div",{class:"section-title"},"统计数据",-1)),s("div",Qt,[s("div",Yt,[t[54]||(t[54]=s("span",{class:"detail-label"},"总Token消耗",-1)),s("span",se,l(v.value.stats.total_tokens?m(v.value.stats.total_tokens):"N/A"),1)]),s("div",te,[t[55]||(t[55]=s("span",{class:"detail-label"},"输入Token",-1)),s("span",ee,l(v.value.stats.prompt_tokens?m(v.value.stats.prompt_tokens):"N/A"),1)]),s("div",ae,[t[56]||(t[56]=s("span",{class:"detail-label"},"输出Token",-1)),s("span",oe,l(v.value.stats.completion_tokens?m(v.value.stats.completion_tokens):"N/A"),1)]),s("div",le,[t[57]||(t[57]=s("span",{class:"detail-label"},"平均Token",-1)),s("span",ie,l(I(v.value.stats)),1)])])]),F(v.value.name).length>0?(r(),d("div",ne,[t[60]||(t[60]=s("div",{class:"section-title"},"使用场景",-1)),s("div",de,[(r(!0),d(x,null,A(F(v.value.name),a=>(r(),d("div",{class:"task-card",key:a},[t[59]||(t[59]=s("span",{class:"material-symbols-rounded task-icon"},"check_circle",-1)),s("span",re,l(a),1)]))),128))])])):E("",!0)])])],2)])):E("",!0)]))}}),fe=rs(ce,[["__scopeId","data-v-548a3549"]]);export{fe as default};
