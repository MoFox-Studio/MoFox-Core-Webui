import{a as es,r as u,D as K,m as ls,c as l,g as i,l as ns,e as s,t as o,n as w,F as A,h as O,s as os,M as is,az as Gs,aA as xs,aB as Us,o as a,aC as Ts,aD as Ss,_ as as,a2 as ts,N as Ds,L as ks,aE as Is,aF as Bs,ad as Y,aG as Vs,aH as Ms,aI as Rs,aJ as Ls,aK as Ws,aL as Es,O as ss,Z as Ns,P as Ps,aM as Fs,aN as zs,f as q,T as ys,w as hs,ac as As,S as ds}from"./index-BGALCsy3.js";import{s as Q,a as Z,b as D}from"./dialog-BNPXTtdW.js";import{r as Os}from"./dashboard-CLw_6f88.js";import"./ConfirmDialog-BSvTE5LB.js";import"./iconify-C5Kmvzy4.js";const Xs={class:"ui-update-tab"},Hs={key:0,class:"m3-card disabled-card"},Js={class:"disabled-content"},Ks={class:"disabled-text"},Zs={key:1,class:"m3-card version-card"},js={key:0,class:"version-info"},qs={class:"info-row"},Qs={class:"info-value version"},Ys={key:0,class:"info-row"},se={class:"info-value"},ee={key:1,class:"info-row"},ae={class:"info-value branch"},te={key:2,class:"info-row"},le={class:"info-value commit"},ne={key:1,class:"version-info"},oe={key:2,class:"m3-card update-check-card"},ie={class:"card-header"},de=["disabled"],ue={key:0,class:"update-result"},re={key:0,class:"has-update"},ce={class:"update-badge"},ve={key:0,class:"changelog"},me={class:"update-actions"},pe=["disabled"],_e={key:1,class:"up-to-date"},fe={key:1,class:"error-message"},be={key:3,class:"m3-card backup-card"},ge={class:"card-header"},ye=["disabled"],he={key:0,class:"backup-list"},ke={class:"backup-info"},$e={class:"backup-header"},we={class:"backup-commit"},Ce={key:0,class:"backup-version"},Ge={key:1,class:"current-badge"},xe={class:"backup-message"},Ue={class:"backup-meta"},Te={class:"backup-actions"},Se=["onClick","disabled"],De=["onClick","disabled"],Ie={key:1,class:"no-backups"},Be={class:"detail-dialog"},Ve={class:"detail-header"},Me={key:0,class:"detail-content"},Re={class:"detail-section"},Le={class:"detail-row"},We={class:"detail-value"},Ee={key:0,class:"detail-row"},Ne={class:"detail-value version-tag"},Pe={class:"detail-row"},Fe={class:"detail-value"},ze={key:1,class:"detail-row"},Ae={class:"detail-value"},Oe={key:0,class:"detail-section"},Xe={class:"commit-message"},He={key:1,class:"detail-section"},Je={class:"commit-body"},Ke={key:2,class:"detail-section"},Ze={class:"files-list"},je={class:"file-path"},qe={key:0,class:"files-more"},Qe={key:1,class:"detail-content loading"},Ye=es({__name:"UIUpdateTab",emits:["update-complete"],setup(R,{expose:X,emit:v}){const h=v,c=u(null),k=u([]),b=u(!1),T=u(!1),x=u(!1),C=u(!1),_=u(""),U=u(!1),f=u(!1),g=u(null),G=K(()=>c.value?{version:c.value.current_version||"未安装",build_time:null,branch:c.value.current_branch,commit:c.value.current_commit}:null),L=K(()=>c.value?c.value.update_enabled===!1:!1),N=K(()=>c.value?c.value.message?c.value.message:c.value.update_enabled===!1?`当前分支为 "${c.value.current_branch||"未知"}"，更新功能已禁用。仅 webui-dist 分支支持自动更新。`:"":"");function P(p){if(!p)return"-";try{return new Date(p).toLocaleString("zh-CN")}catch{return p}}async function M(){b.value=!0,_.value="";try{const p=await Gs();p.success&&p.data?(c.value=p.data,p.data.success||(_.value=p.data.error||"获取状态失败")):_.value=p.error||"获取状态失败"}catch(p){_.value=p.message||"获取状态失败"}finally{b.value=!1}}async function F(){await M()}async function r(){var n,H;if(await Q({title:"确认更新",message:"更新 UI 将刷新页面，是否继续？",confirmText:"更新"})){T.value=!0,_.value="";try{const B=await xs();B.success&&((n=B.data)!=null&&n.success)?(Z(`更新成功！已更新到 ${B.data.version||"最新版本"}`),h("update-complete",!0)):D(((H=B.data)==null?void 0:H.error)||B.error||"更新失败")}catch(B){D(B.message||"更新失败")}finally{T.value=!1}}}async function t(){var p;C.value=!0;try{const n=await Us();n.success&&((p=n.data)!=null&&p.data)&&(k.value=n.data.data)}catch(n){console.error("加载备份列表失败:",n)}finally{C.value=!1}}async function m(p){var B,y;const n=p.substring(0,7);if(await Q({title:"确认回滚",message:`确定要回滚到版本 "${n}" 吗？此操作将重置到该版本。`,confirmText:"回滚"})){x.value=!0;try{const V=await Ts(p);V.success&&((B=V.data)!=null&&B.success)?(Z(V.data.message||"回滚成功"),h("update-complete",!0)):D(((y=V.data)==null?void 0:y.error)||V.error||"回滚失败")}catch(V){D(V.message||"回滚失败")}finally{x.value=!1}}}async function W(p){U.value=!0,f.value=!0,g.value=null;try{const n=await Ss(p);n.success&&n.data?g.value=n.data:(D(n.error||"获取详情失败"),U.value=!1)}catch(n){D(n.message||"获取详情失败"),U.value=!1}finally{f.value=!1}}function I(p){return{新增:"status-add",修改:"status-modify",删除:"status-delete",重命名:"status-rename"}[p]||""}return ls(()=>{M(),t()}),X({refresh:()=>{M(),t()}}),(p,n)=>{var H,B;return a(),l("div",Xs,[L.value?(a(),l("div",Hs,[s("div",Js,[n[3]||(n[3]=s("span",{class:"material-symbols-rounded icon-warning"},"info",-1)),s("div",Ks,[n[2]||(n[2]=s("h4",null,"更新功能已禁用",-1)),s("p",null,o(N.value),1)])])])):i("",!0),L.value?i("",!0):(a(),l("div",Zs,[n[9]||(n[9]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"web"),s("h3",null,"当前版本")],-1)),G.value?(a(),l("div",js,[s("div",qs,[n[4]||(n[4]=s("span",{class:"info-label"},"版本号:",-1)),s("span",Qs,"v"+o(G.value.version),1)]),G.value.build_time?(a(),l("div",Ys,[n[5]||(n[5]=s("span",{class:"info-label"},"构建时间:",-1)),s("span",se,o(P(G.value.build_time)),1)])):i("",!0),G.value.branch?(a(),l("div",ee,[n[6]||(n[6]=s("span",{class:"info-label"},"分支:",-1)),s("span",ae,o(G.value.branch),1)])):i("",!0),G.value.commit?(a(),l("div",te,[n[7]||(n[7]=s("span",{class:"info-label"},"Commit:",-1)),s("code",le,o(G.value.commit.substring(0,8)),1)])):i("",!0)])):(a(),l("div",ne,[...n[8]||(n[8]=[s("p",{class:"no-version"},"未检测到版本信息",-1)])]))])),L.value?i("",!0):(a(),l("div",oe,[s("div",ie,[n[10]||(n[10]=s("span",{class:"material-symbols-rounded"},"sync",-1)),n[11]||(n[11]=s("h3",null,"检查更新",-1)),s("button",{class:"m3-button tonal",onClick:F,disabled:b.value||L.value},[s("span",{class:w(["material-symbols-rounded",{spinning:b.value}])},o(b.value?"progress_activity":"refresh"),3),s("span",null,o(b.value?"检查中...":"检查更新"),1)],8,de)]),c.value&&!L.value?(a(),l("div",ue,[c.value.has_update?(a(),l("div",re,[s("div",ce,[n[12]||(n[12]=s("span",{class:"material-symbols-rounded"},"auto_awesome",-1)),s("span",null,"发现新版本 v"+o(c.value.latest_version),1)]),(H=c.value.changelog)!=null&&H.length?(a(),l("div",ve,[n[13]||(n[13]=s("h4",null,"更新内容:",-1)),s("ul",null,[(a(!0),l(A,null,O(c.value.changelog.slice(0,10),(y,V)=>(a(),l("li",{key:V},o(y),1))),128))])])):i("",!0),s("div",me,[s("button",{class:"m3-button filled",onClick:r,disabled:T.value},[s("span",{class:w(["material-symbols-rounded",{spinning:T.value}])},o(T.value?"progress_activity":"download"),3),s("span",null,o(T.value?"更新中...":"立即更新"),1)],8,pe)])])):(a(),l("div",_e,[...n[14]||(n[14]=[s("span",{class:"material-symbols-rounded icon-success"},"check_circle",-1),s("span",null,"已是最新版本",-1)])]))])):i("",!0),_.value?(a(),l("div",fe,[n[15]||(n[15]=s("span",{class:"material-symbols-rounded"},"error",-1)),s("span",null,o(_.value),1)])):i("",!0)])),L.value?i("",!0):(a(),l("div",be,[s("div",ge,[n[16]||(n[16]=s("span",{class:"material-symbols-rounded"},"history",-1)),n[17]||(n[17]=s("h3",null,"历史版本",-1)),s("button",{class:"m3-icon-button",onClick:t,disabled:C.value},[s("span",{class:w(["material-symbols-rounded",{spinning:C.value}])},"refresh",2)],8,ye)]),k.value.length?(a(),l("div",he,[(a(!0),l(A,null,O(k.value,y=>(a(),l("div",{key:y.commit,class:w(["backup-item",{"is-current":y.is_current}])},[s("div",ke,[s("div",$e,[s("code",we,o(y.commit_short),1),y.version?(a(),l("span",Ce,"v"+o(y.version),1)):i("",!0),y.is_current?(a(),l("span",Ge,"当前")):i("",!0)]),s("span",xe,o(y.message),1),s("span",Ue,o(P(y.timestamp)),1)]),s("div",Te,[s("button",{class:"m3-button text",onClick:V=>W(y.commit),disabled:f.value},[...n[18]||(n[18]=[s("span",{class:"material-symbols-rounded"},"info",-1),s("span",null,"详情",-1)])],8,Se),s("button",{class:"m3-button text",onClick:V=>m(y.commit),disabled:x.value||y.is_current},[...n[19]||(n[19]=[s("span",{class:"material-symbols-rounded"},"restore",-1),s("span",null,"回滚",-1)])],8,De)])],2))),128))])):(a(),l("div",Ie,[...n[20]||(n[20]=[s("span",{class:"material-symbols-rounded"},"history_toggle_off",-1),s("span",null,"暂无历史版本",-1)])]))])),(a(),ns(is,{to:"body"},[U.value?(a(),l("div",{key:0,class:"detail-dialog-overlay",onClick:n[1]||(n[1]=os(y=>U.value=!1,["self"]))},[s("div",Be,[s("div",Ve,[n[22]||(n[22]=s("h3",null,"版本详情",-1)),s("button",{class:"m3-icon-button",onClick:n[0]||(n[0]=y=>U.value=!1)},[...n[21]||(n[21]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),g.value?(a(),l("div",Me,[s("div",Re,[s("div",Le,[n[23]||(n[23]=s("span",{class:"detail-label"},"Commit:",-1)),s("code",We,o(g.value.commit_short),1)]),g.value.version?(a(),l("div",Ee,[n[24]||(n[24]=s("span",{class:"detail-label"},"版本:",-1)),s("span",Ne,"v"+o(g.value.version),1)])):i("",!0),s("div",Pe,[n[25]||(n[25]=s("span",{class:"detail-label"},"时间:",-1)),s("span",Fe,o(P(g.value.timestamp)),1)]),g.value.author?(a(),l("div",ze,[n[26]||(n[26]=s("span",{class:"detail-label"},"作者:",-1)),s("span",Ae,o(g.value.author),1)])):i("",!0)]),g.value.message?(a(),l("div",Oe,[n[27]||(n[27]=s("h4",null,"提交消息",-1)),s("p",Xe,o(g.value.message),1)])):i("",!0),g.value.body?(a(),l("div",He,[n[28]||(n[28]=s("h4",null,"更新内容",-1)),s("pre",Je,o(g.value.body),1)])):i("",!0),(B=g.value.files_changed)!=null&&B.length?(a(),l("div",Ke,[s("h4",null,"修改文件 ("+o(g.value.files_changed.length)+")",1),s("div",Ze,[(a(!0),l(A,null,O(g.value.files_changed.slice(0,20),(y,V)=>(a(),l("div",{key:V,class:"file-item"},[s("span",{class:w(["file-status",I(y.status)])},o(y.status),3),s("span",je,o(y.path),1)]))),128)),g.value.files_changed.length>20?(a(),l("div",qe," ... 及其他 "+o(g.value.files_changed.length-20)+" 个文件 ",1)):i("",!0)])])):i("",!0)])):f.value?(a(),l("div",Qe,[...n[29]||(n[29]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):i("",!0)])])):i("",!0)]))])}}}),sa=as(Ye,[["__scopeId","data-v-da3800a9"]]);function $s(){return ts.get("git_env/status")}function ea(){return ts.post("git_env/install")}function aa(R){return ts.post("git_env/set-path",{path:R})}function ta(){return ts.post("git_env/auto-detect")}function la(){return ts.get("git_env/install-guide")}const na={class:"main-update-tab"},oa={class:"m3-card branch-card"},ia={key:0,class:"loading-placeholder"},da={key:1,class:"card-disabled-hint"},ua={key:2,class:"branch-selector"},ra={class:"selected-value"},ca={key:0,class:"m3-select-dropdown m3-card"},va=["onClick"],ma={key:0,class:"material-symbols-rounded check-icon"},pa={key:0,class:"switching-indicator"},_a=["disabled","title"],fa={class:"m3-card update-card"},ba={class:"card-header"},ga=["disabled"],ya={key:0,class:"loading-placeholder"},ha={key:1,class:"alert alert-warning"},ka={key:2,class:"alert alert-warning"},$a={key:3,class:"update-result"},wa={key:0,class:"has-update"},Ca={class:"update-header"},Ga={class:"update-title"},xa={class:"version-compare"},Ua={class:"version-box version-current"},Ta={class:"version-box version-latest"},Sa={key:0,class:"changelog"},Da={class:"update-actions"},Ia={key:0,class:"material-symbols-rounded check-icon"},Ba=["disabled"],Va={key:1,class:"up-to-date"},Ma={class:"up-to-date-info"},Ra={key:0},La={key:4,class:"error-message"},Wa={class:"m3-card backup-card"},Ea={class:"card-header"},Na=["disabled"],Pa={key:0,class:"loading-placeholder"},Fa={key:1,class:"card-disabled-hint"},za={key:2,class:"backup-list"},Aa={class:"backup-info"},Oa={class:"backup-header"},Xa={class:"backup-commit"},Ha={key:0,class:"current-badge"},Ja={class:"backup-message"},Ka={class:"backup-meta"},Za={class:"backup-actions"},ja=["onClick","disabled"],qa=["onClick","disabled"],Qa={key:3,class:"no-backups"},Ya={class:"detail-dialog"},st={class:"detail-header"},et={key:0,class:"detail-content"},at={class:"detail-section"},tt={class:"detail-row"},lt={class:"detail-value"},nt={class:"detail-row"},ot={class:"detail-value"},it={key:0,class:"detail-row"},dt={class:"detail-value"},ut={key:0,class:"detail-section"},rt={class:"commit-message"},ct={key:1,class:"detail-section"},vt={class:"commit-body"},mt={key:2,class:"detail-section"},pt={class:"files-list"},_t={class:"file-path"},ft={key:0,class:"files-more"},bt={key:1,class:"detail-content loading"},gt=es({__name:"MainUpdateTab",emits:["update-complete"],setup(R,{expose:X,emit:v}){const h=v,c=u(null),k=u(null),b=u(null),T=u([]),x=u(""),C=u(!1),_=u(!0),U=u(!1),f=u(!1),g=u(!1),G=u(!1),L=u(!1),N=u(!1),P=u(!1),M=u(""),F=u(!1),r=u(!1),t=u(null),m=u(null);async function W(){try{const[d,e]=await Promise.all([$s(),Is()]);d.success&&d.data&&(c.value=d.data),e.success&&e.data&&(k.value=e.data,e.data.current_branch&&(x.value=e.data.current_branch))}catch(d){console.error("加载状态失败:",d)}}function I(){g.value||(C.value=!C.value)}async function p(){var d;if(!G.value){G.value=!0;try{const e=await Bs();e.success&&e.data?(k.value=e.data,e.data.current_branch&&(x.value=e.data.current_branch),Y("分支列表已刷新","success")):Y(((d=e.data)==null?void 0:d.error)||e.error||"刷新分支列表失败","error")}catch(e){Y(e.message||"刷新分支列表失败（网络可能不可用）","error")}finally{G.value=!1}}}async function n(d){var J,E;if(C.value=!1,!(d===x.value||!await Q({title:"切换分支",message:`确定要切换到分支 "${d}" 吗？`,confirmText:"切换"}))){g.value=!0;try{const S=await Ls(d);S.success&&((J=S.data)!=null&&J.success)?(x.value=d,Z(S.data.message||"分支切换成功"),h("update-complete",!0)):D(((E=S.data)==null?void 0:E.error)||S.error||"切换分支失败")}catch(S){D(S.message||"切换分支失败")}finally{g.value=!1}}}async function H(){U.value=!0,M.value="",b.value=null;try{const d=await Vs();d.success&&d.data?(b.value=d.data,d.data.success||(M.value=d.data.error||"检查更新失败")):M.value=d.error||"检查更新失败"}catch(d){M.value=d.message||"检查更新失败"}finally{U.value=!1}}async function B(){var J,E;const d=F.value?"强制更新将覆盖所有本地修改，更新后需要重启才能生效，是否继续？":"更新主程序后需要重启才能生效，是否继续？";if(await Q({title:"确认更新",message:d,confirmText:"更新"})){f.value=!0,M.value="";try{const S=await Ms(F.value,!0);S.success&&((J=S.data)!=null&&J.success)?(Z(S.data.message||"更新成功"),b.value=null,await W(),h("update-complete",!0),y()):D(((E=S.data)==null?void 0:E.error)||S.error||"更新失败")}catch(S){D(S.message||"更新失败")}finally{f.value=!1}}}async function y(){var d;N.value=!0;try{const e=await Rs();e.success&&((d=e.data)!=null&&d.data)&&(T.value=e.data.data)}catch(e){console.error("加载历史版本列表失败:",e)}finally{N.value=!1}}async function V(d){var E,S;const e=d.substring(0,7);if(await Q({title:"确认回滚",message:`确定要回滚到版本 "${e}" 吗？此操作将重置到该版本，回滚后需要重启程序。`,confirmText:"回滚"})){L.value=!0;try{const z=await Ws(d);z.success&&((E=z.data)!=null&&E.success)?(Z(z.data.message||"回滚成功"),h("update-complete",!0),y()):D(((S=z.data)==null?void 0:S.error)||z.error||"回滚失败")}catch(z){D(z.message||"回滚失败")}finally{L.value=!1}}}async function ws(d){r.value=!0,P.value=!0,t.value=null;try{const e=await Es(d);e.success&&e.data?t.value=e.data:(D(e.error||"获取详情失败"),r.value=!1)}catch(e){D(e.message||"获取详情失败"),r.value=!1}finally{P.value=!1}}function us(d){if(!d)return"-";try{return new Date(d).toLocaleString("zh-CN")}catch{return d}}function Cs(d){return{新增:"status-add",修改:"status-modify",删除:"status-delete",重命名:"status-rename"}[d]||""}function rs(d){m.value&&!m.value.contains(d.target)&&(C.value=!1)}return ls(async()=>{var d,e;document.addEventListener("click",rs);try{await W(),y(),(d=c.value)!=null&&d.git_available&&((e=k.value)!=null&&e.is_git_repo)&&H()}finally{_.value=!1}}),Ds(()=>{document.removeEventListener("click",rs)}),X({refresh:()=>{W(),y(),b.value=null}}),(d,e)=>{var J,E,S,z,cs,vs,ms,ps,_s,fs,bs,gs;return a(),l("div",na,[s("div",oa,[e[7]||(e[7]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"fork_right"),s("h3",null,"分支管理")],-1)),_.value?(a(),l("div",ia,[...e[3]||(e[3]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):!((J=c.value)!=null&&J.git_available)||(((S=(E=k.value)==null?void 0:E.available_branches)==null?void 0:S.length)??0)===0?(a(),l("div",da,[e[4]||(e[4]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,o((z=c.value)!=null&&z.git_available?"无可用分支":"Git 环境不可用"),1)])):(a(),l("div",ua,[e[6]||(e[6]=s("label",{class:"m3-label"},"当前分支:",-1)),s("div",{class:"select-wrapper",ref_key:"branchSelectWrapper",ref:m},[s("div",{class:w(["m3-select-trigger",{disabled:g.value,active:C.value}]),onClick:I},[s("span",ra,o(x.value),1),s("span",{class:w(["material-symbols-rounded select-arrow",{rotated:C.value}])}," arrow_drop_down ",2)],2),C.value?(a(),l("div",ca,[(a(!0),l(A,null,O(((cs=k.value)==null?void 0:cs.available_branches)??[],$=>(a(),l("div",{key:$,class:w(["m3-select-option",{selected:$===x.value}]),onClick:j=>n($)},[s("span",null,o($),1),$===x.value?(a(),l("span",ma,"check")):i("",!0)],10,va))),128))])):i("",!0)],512),g.value?(a(),l("span",pa,[...e[5]||(e[5]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),ks(" 切换中... ",-1)])])):(a(),l("button",{key:1,class:"m3-icon-button",onClick:p,disabled:G.value,title:G.value?"刷新中...":"刷新远程分支列表"},[s("span",{class:w(["material-symbols-rounded",{spinning:G.value}])},"sync",2)],8,_a))]))]),s("div",fa,[s("div",ba,[e[8]||(e[8]=s("span",{class:"material-symbols-rounded"},"sync",-1)),e[9]||(e[9]=s("h3",null,"更新检测",-1)),s("button",{class:"m3-button tonal",onClick:H,disabled:_.value||U.value||!((vs=c.value)!=null&&vs.git_available)},[s("span",{class:w(["material-symbols-rounded",{spinning:U.value}])},o(U.value?"progress_activity":"refresh"),3),s("span",null,o(U.value?"检查中...":"检查更新"),1)],8,ga)]),_.value||U.value?(a(),l("div",ya,[e[10]||(e[10]=s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1)),s("span",null,o(_.value?"加载中...":"检查更新中..."),1)])):c.value&&!c.value.git_available?(a(),l("div",ha,[...e[11]||(e[11]=[s("span",{class:"material-symbols-rounded"},"warning",-1),s("span",null,'Git 不可用，请先在"Git 设置"中配置 Git 环境',-1)])])):k.value&&!k.value.is_git_repo?(a(),l("div",ka,[...e[12]||(e[12]=[s("span",{class:"material-symbols-rounded"},"warning",-1),s("span",null,"主程序目录不是 Git 仓库，无法使用自动更新功能",-1)])])):b.value?(a(),l("div",$a,[b.value.has_update?(a(),l("div",wa,[s("div",Ca,[e[14]||(e[14]=s("div",{class:"update-icon"},[s("span",{class:"material-symbols-rounded"},"auto_awesome")],-1)),s("div",Ga,[e[13]||(e[13]=s("h4",null,"发现新版本",-1)),s("p",null,"有 "+o(b.value.commits_behind)+" 个新提交等待更新",1)])]),s("div",xa,[s("div",Ua,[e[15]||(e[15]=s("span",{class:"version-tag"},"当前",-1)),s("code",null,o(b.value.current_commit||"未知"),1)]),e[17]||(e[17]=s("span",{class:"material-symbols-rounded arrow-icon"},"arrow_forward",-1)),s("div",Ta,[e[16]||(e[16]=s("span",{class:"version-tag"},"最新",-1)),s("code",null,o(b.value.remote_commit||"未知"),1)])]),(ms=b.value.update_logs)!=null&&ms.length?(a(),l("div",Sa,[e[18]||(e[18]=s("h4",null,"更新内容:",-1)),s("ul",null,[(a(!0),l(A,null,O(b.value.update_logs.slice(0,5),($,j)=>(a(),l("li",{key:j},o($),1))),128))])])):i("",!0),s("div",Da,[s("label",{class:w(["force-update-checkbox",{disabled:f.value}]),onClick:e[0]||(e[0]=$=>!f.value&&(F.value=!F.value))},[s("div",{class:w(["custom-checkbox",{checked:F.value}])},[F.value?(a(),l("span",Ia,"check")):i("",!0)],2),e[19]||(e[19]=s("span",{class:"checkbox-label"},"强制更新（覆盖本地修改）",-1))],2),s("button",{class:"m3-button filled",onClick:B,disabled:f.value},[s("span",{class:w(["material-symbols-rounded",{spinning:f.value}])},o(f.value?"progress_activity":"download"),3),s("span",null,o(f.value?"更新中...":"立即更新"),1)],8,Ba)])])):(a(),l("div",Va,[e[21]||(e[21]=s("span",{class:"material-symbols-rounded icon-success"},"check_circle",-1)),s("div",Ma,[e[20]||(e[20]=s("span",null,"已是最新版本",-1)),b.value.current_commit?(a(),l("code",Ra,o(b.value.current_commit),1)):i("",!0)])]))])):i("",!0),M.value?(a(),l("div",La,[e[22]||(e[22]=s("span",{class:"material-symbols-rounded"},"error",-1)),s("span",null,o(M.value),1)])):i("",!0)]),s("div",Wa,[s("div",Ea,[e[23]||(e[23]=s("span",{class:"material-symbols-rounded"},"history",-1)),e[24]||(e[24]=s("h3",null,"历史版本",-1)),s("button",{class:"m3-icon-button",onClick:y,disabled:_.value||N.value||!((ps=c.value)!=null&&ps.git_available)},[s("span",{class:w(["material-symbols-rounded",{spinning:N.value}])},"refresh",2)],8,Na)]),_.value||N.value?(a(),l("div",Pa,[...e[25]||(e[25]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):!((_s=c.value)!=null&&_s.git_available)||!((fs=k.value)!=null&&fs.is_git_repo)?(a(),l("div",Fa,[e[26]||(e[26]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,o((bs=c.value)!=null&&bs.git_available?"当前目录非 Git 仓库":"Git 环境不可用"),1)])):T.value.length?(a(),l("div",za,[(a(!0),l(A,null,O(T.value,$=>(a(),l("div",{key:$.commit,class:w(["backup-item",{"is-current":$.is_current}])},[s("div",Aa,[s("div",Oa,[s("code",Xa,o($.commit_short),1),$.is_current?(a(),l("span",Ha,"当前")):i("",!0)]),s("span",Ja,o($.message),1),s("span",Ka,o(us($.timestamp)),1)]),s("div",Za,[s("button",{class:"m3-button text",onClick:j=>ws($.commit),disabled:P.value},[...e[27]||(e[27]=[s("span",{class:"material-symbols-rounded"},"info",-1),s("span",null,"详情",-1)])],8,ja),s("button",{class:"m3-button text",onClick:j=>V($.commit),disabled:L.value||$.is_current},[...e[28]||(e[28]=[s("span",{class:"material-symbols-rounded"},"restore",-1),s("span",null,"回滚",-1)])],8,qa)])],2))),128))])):(a(),l("div",Qa,[...e[29]||(e[29]=[s("span",{class:"material-symbols-rounded"},"history_toggle_off",-1),s("span",null,"暂无历史版本",-1)])]))]),(a(),ns(is,{to:"body"},[r.value?(a(),l("div",{key:0,class:"detail-dialog-overlay",onClick:e[2]||(e[2]=os($=>r.value=!1,["self"]))},[s("div",Ya,[s("div",st,[e[31]||(e[31]=s("h3",null,"版本详情",-1)),s("button",{class:"m3-icon-button",onClick:e[1]||(e[1]=$=>r.value=!1)},[...e[30]||(e[30]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),t.value?(a(),l("div",et,[s("div",at,[s("div",tt,[e[32]||(e[32]=s("span",{class:"detail-label"},"Commit:",-1)),s("code",lt,o(t.value.commit_short),1)]),s("div",nt,[e[33]||(e[33]=s("span",{class:"detail-label"},"时间:",-1)),s("span",ot,o(us(t.value.timestamp)),1)]),t.value.author?(a(),l("div",it,[e[34]||(e[34]=s("span",{class:"detail-label"},"作者:",-1)),s("span",dt,o(t.value.author),1)])):i("",!0)]),t.value.message?(a(),l("div",ut,[e[35]||(e[35]=s("h4",null,"提交消息",-1)),s("p",rt,o(t.value.message),1)])):i("",!0),t.value.body?(a(),l("div",ct,[e[36]||(e[36]=s("h4",null,"更新内容",-1)),s("pre",vt,o(t.value.body),1)])):i("",!0),(gs=t.value.files_changed)!=null&&gs.length?(a(),l("div",mt,[s("h4",null,"修改文件 ("+o(t.value.files_changed.length)+")",1),s("div",pt,[(a(!0),l(A,null,O(t.value.files_changed.slice(0,20),($,j)=>(a(),l("div",{key:j,class:"file-item"},[s("span",{class:w(["file-status",Cs($.status)])},o($.status),3),s("span",_t,o($.path),1)]))),128)),t.value.files_changed.length>20?(a(),l("div",ft," ... 及其他 "+o(t.value.files_changed.length-20)+" 个文件 ",1)):i("",!0)])])):i("",!0)])):P.value?(a(),l("div",bt,[...e[37]||(e[37]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):i("",!0)])])):i("",!0)]))])}}}),yt=as(gt,[["__scopeId","data-v-8849b0d3"]]),ht={class:"git-settings-tab"},kt={class:"m3-card status-card"},$t={class:"card-header"},wt=["disabled"],Ct={key:0,class:"status-grid"},Gt={class:"status-item"},xt={class:"material-symbols-rounded"},Ut={key:0,class:"status-item"},Tt={class:"status-value"},St={class:"status-item"},Dt={class:"status-value"},It={class:"status-item"},Bt={class:"status-value"},Vt={key:0,class:"m3-card path-card"},Mt={class:"path-content"},Rt={class:"path-display"},Lt={class:"path-value"},Wt={class:"path-actions"},Et=["disabled"],Nt=["disabled"],Pt={key:0,class:"portable-tip"},Ft={class:"m3-card update-config-card"},zt={class:"config-content"},At={class:"config-item"},Ot={class:"m3-switch"},Xt={key:0,class:"config-tip"},Ht={key:2,class:"m3-card guide-card"},Jt={key:0,class:"guide-content"},Kt={key:0,class:"guide-commands"},Zt={class:"command-name"},jt={class:"command-value"},qt=["href"],Qt={class:"modal-content m3-card"},Yt={class:"modal-header"},sl={class:"modal-body"},el={class:"input-wrapper"},al={class:"modal-footer"},tl=["disabled"],ll=es({__name:"GitSettingsTab",setup(R,{expose:X}){const v=u(null),h=u(null),c=u(!1),k=u(!1),b=u(!1),T=u(!1),x=u(!1),C=u(""),_=u(!0);function U(r){return{custom:"自定义",portable:"便携版",system:"系统",unknown:"未知"}[r]||r}function f(){var t;switch((t=v.value)==null?void 0:t.system_os){case"Windows":return"下载便携版";case"Linux":return"安装 Git";case"Darwin":return"安装 Git";default:return"安装 Git"}}function g(){var t;switch((t=v.value)==null?void 0:t.system_os){case"Windows":return'未检测到 Git，可以点击上方"下载便携版"按钮安装';case"Linux":return'未检测到 Git，点击"安装 Git"将使用系统包管理器安装';case"Darwin":return'未检测到 Git，点击"安装 Git"将使用 Homebrew 或 Xcode 安装';default:return"未检测到 Git，请手动安装"}}async function G(){c.value=!0;try{const r=await $s();r.success&&r.data&&(v.value=r.data,!r.data.git_available&&r.data.system_os!=="Windows"&&L())}catch(r){console.error("加载 Git 状态失败:",r)}finally{c.value=!1}}async function L(){var r;try{const t=await la();t.success&&((r=t.data)!=null&&r.data)&&(h.value=t.data.data)}catch(t){console.error("加载安装指南失败:",t)}}async function N(){var r,t;T.value=!0;try{const m=await ta();m.success&&((r=m.data)!=null&&r.success)?(Z(m.data.message||"已检测到 Git"),await G()):D(((t=m.data)==null?void 0:t.error)||m.error||"未检测到 Git")}catch(m){D(m.message||"检测失败")}finally{T.value=!1}}async function P(){var r,t,m,W;if((r=v.value)!=null&&r.git_available){const I=(t=v.value)==null?void 0:t.system_os;let p=`检测到您的电脑已经安装了 Git。

`;if(I==="Windows"?p+="便携版 Git 适用于没有安装 Git 的用户，如果您已经有 Git，通常不需要再下载。":I==="Linux"?p+="系统将尝试使用包管理器重新安装 Git，这可能会覆盖现有版本。":I==="Darwin"&&(p+="系统将尝试使用 Homebrew 或 Xcode 安装 Git，这可能会覆盖现有版本。"),p+=`

确定要继续吗？`,!await Q({title:"确认安装",message:p,type:"warning",confirmText:"继续安装",cancelText:"取消"}))return}k.value=!0;try{const I=await ea();I.success&&((m=I.data)!=null&&m.success)?(Z(I.data.message||"Git 安装成功"),await N()):D(((W=I.data)==null?void 0:W.error)||I.error||"安装失败")}catch(I){D(I.message||"安装失败")}finally{k.value=!1}}function M(){const r=_.value;localStorage.setItem("autoUpdateEnabled",r.toString()),r?(Fs(),Y("已启用自动更新检查")):(zs(),Y("已关闭自动更新检查"))}async function F(){var r,t;if(C.value){b.value=!0;try{const m=await aa(C.value);m.success&&((r=m.data)!=null&&r.success)?(Z(m.data.message||"路径设置成功"),x.value=!1,C.value="",await G()):D(((t=m.data)==null?void 0:t.error)||m.error||"设置失败")}catch(m){D(m.message||"设置失败")}finally{b.value=!1}}}return ls(()=>{G();const r=localStorage.getItem("autoUpdateEnabled");r!==null&&(_.value=r==="true")}),X({refresh:G}),(r,t)=>(a(),l("div",ht,[s("div",kt,[s("div",$t,[t[6]||(t[6]=s("span",{class:"material-symbols-rounded"},"terminal",-1)),t[7]||(t[7]=s("h3",null,"Git 环境状态",-1)),s("button",{class:"m3-icon-button",onClick:G,disabled:c.value},[s("span",{class:w(["material-symbols-rounded",{spinning:c.value}])},"refresh",2)],8,wt)]),v.value?(a(),l("div",Ct,[s("div",Gt,[t[8]||(t[8]=s("span",{class:"status-label"},"状态",-1)),s("span",{class:w(["status-value",v.value.git_available?"success":"error"])},[s("span",xt,o(v.value.git_available?"check_circle":"cancel"),1),ks(" "+o(v.value.git_available?"可用":"不可用"),1)],2)]),v.value.git_version?(a(),l("div",Ut,[t[9]||(t[9]=s("span",{class:"status-label"},"版本",-1)),s("span",Tt,o(v.value.git_version),1)])):i("",!0),s("div",St,[t[10]||(t[10]=s("span",{class:"status-label"},"来源",-1)),s("span",Dt,[s("span",{class:w(["m3-badge",`source-${v.value.git_source}`])},o(U(v.value.git_source)),3)])]),s("div",It,[t[11]||(t[11]=s("span",{class:"status-label"},"操作系统",-1)),s("span",Bt,o(v.value.system_os),1)])])):i("",!0)]),v.value?(a(),l("div",Vt,[t[15]||(t[15]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"folder"),s("h3",null,"Git 路径")],-1)),s("div",Mt,[s("div",Rt,[t[12]||(t[12]=s("span",{class:"path-label"},"当前路径:",-1)),s("code",Lt,o(v.value.git_path||"未检测到"),1)]),s("div",Wt,[s("button",{class:"m3-button tonal",onClick:N,disabled:T.value},[s("span",{class:w(["material-symbols-rounded",{spinning:T.value}])},o(T.value?"progress_activity":"search"),3),s("span",null,o(T.value?"检测中...":"自动寻找"),1)],8,Et),s("button",{class:"m3-button tonal",onClick:t[0]||(t[0]=m=>x.value=!0)},[...t[13]||(t[13]=[s("span",{class:"material-symbols-rounded"},"edit",-1),s("span",null,"设置路径",-1)])]),s("button",{class:w(["m3-button",v.value.git_available?"tonal":"filled"]),onClick:P,disabled:k.value},[s("span",{class:w(["material-symbols-rounded",{spinning:k.value}])},o(k.value?"progress_activity":"download"),3),s("span",null,o(k.value?"安装中...":f()),1)],10,Nt)]),v.value.git_available?i("",!0):(a(),l("div",Pt,[t[14]||(t[14]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,o(g()),1)]))])])):i("",!0),s("div",Ft,[t[19]||(t[19]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"update"),s("h3",null,"自动更新检查")],-1)),s("div",zt,[s("div",At,[t[17]||(t[17]=s("div",{class:"config-info"},[s("span",{class:"config-label"},"启用自动更新检查"),s("span",{class:"config-desc"},"定期检查是否有新版本可用（每5分钟）")],-1)),s("label",Ot,[ss(s("input",{type:"checkbox","onUpdate:modelValue":t[1]||(t[1]=m=>_.value=m),onChange:M},null,544),[[Ns,_.value]]),t[16]||(t[16]=s("span",{class:"slider"},null,-1))])]),_.value?i("",!0):(a(),l("div",Xt,[...t[18]||(t[18]=[s("span",{class:"material-symbols-rounded"},"info",-1),s("span",null,"关闭后将不会自动检查更新，您可以在更新页面手动检查",-1)])]))])]),i("",!0),v.value&&!v.value.git_available&&v.value.system_os!=="Windows"?(a(),l("div",Ht,[t[23]||(t[23]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"help"),s("h3",null,"安装指南")],-1)),h.value?(a(),l("div",Jt,[s("p",null,o(h.value.description),1),h.value.manual_commands?(a(),l("div",Kt,[(a(!0),l(A,null,O(h.value.manual_commands,(m,W)=>(a(),l("div",{key:W,class:"command-item"},[s("span",Zt,o(W)+":",1),s("code",jt,o(m),1)]))),128))])):i("",!0),h.value.manual_url?(a(),l("a",{key:1,href:h.value.manual_url,target:"_blank",class:"m3-button tonal"},[...t[22]||(t[22]=[s("span",{class:"material-symbols-rounded"},"open_in_new",-1),s("span",null,"官方下载",-1)])],8,qt)):i("",!0)])):i("",!0)])):i("",!0),(a(),ns(is,{to:"body"},[x.value?(a(),l("div",{key:0,class:"modal-overlay",onClick:t[5]||(t[5]=os(m=>x.value=!1,["self"]))},[s("div",Qt,[s("div",Yt,[t[25]||(t[25]=s("h3",null,"设置 Git 路径",-1)),s("button",{class:"m3-icon-button",onClick:t[2]||(t[2]=m=>x.value=!1)},[...t[24]||(t[24]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),s("div",sl,[t[26]||(t[26]=s("p",null,"请输入 Git 可执行文件的完整路径",-1)),s("div",el,[ss(s("input",{type:"text","onUpdate:modelValue":t[3]||(t[3]=m=>C.value=m),placeholder:"例如: C:\\Program Files\\Git\\bin\\git.exe",class:"m3-input"},null,512),[[Ps,C.value]])])]),s("div",al,[s("button",{class:"m3-button text",onClick:t[4]||(t[4]=m=>x.value=!1)},"取消"),s("button",{class:"m3-button filled",onClick:F,disabled:!C.value||b.value},o(b.value?"设置中...":"确定"),9,tl)])])])):i("",!0)]))]))}}),nl=as(ll,[["__scopeId","data-v-feef3f74"]]),ol={key:0,class:"dialog-content m3-card"},il={class:"dialog-header"},dl={class:"material-symbols-rounded"},ul={class:"dialog-body"},rl={class:"dialog-message"},cl={key:0,class:"changelog-section"},vl={class:"changelog-list"},ml={class:"tip-section"},pl=es({__name:"RestartDialog",props:{modelValue:{type:Boolean},updateType:{default:"main"},changelog:{default:()=>[]}},emits:["update:modelValue","restart","later"],setup(R,{emit:X}){const v=R,h=X,c=K(()=>({main:"type-main",ui:"type-ui",both:"type-both"})[v.updateType]),k=K(()=>({main:"smart_toy",ui:"web",both:"system_update"})[v.updateType]),b=K(()=>({main:"主程序更新完成",ui:"UI 更新完成",both:"全部更新完成"})[v.updateType]),T=K(()=>({main:"主程序已更新成功，需要重启才能生效。",ui:"WebUI 已更新成功，需要刷新页面才能生效。",both:"主程序和 WebUI 都已更新成功，需要重启才能生效。"})[v.updateType]),x=K(()=>v.updateType==="ui"?"刷新页面后将加载新版本的 WebUI":"重启后新功能将生效，当前的连接会暂时中断");function C(){h("restart"),h("update:modelValue",!1)}function _(){h("later"),h("update:modelValue",!1)}return(U,f)=>(a(),ns(is,{to:"body"},[q(ys,{name:"fade"},{default:hs(()=>[R.modelValue?(a(),l("div",{key:0,class:"dialog-overlay",onClick:os(_,["self"])},[q(ys,{name:"scale"},{default:hs(()=>[R.modelValue?(a(),l("div",ol,[s("div",il,[s("div",{class:w(["dialog-icon",c.value])},[s("span",dl,o(k.value),1)],2),s("h2",null,o(b.value),1)]),s("div",ul,[s("p",rl,o(T.value),1),R.changelog&&R.changelog.length>0?(a(),l("div",cl,[f[0]||(f[0]=s("h4",null,"更新内容:",-1)),s("ul",vl,[(a(!0),l(A,null,O(R.changelog.slice(0,5),(g,G)=>(a(),l("li",{key:G},o(g),1))),128))])])):i("",!0),s("div",ml,[f[1]||(f[1]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,o(x.value),1)])]),s("div",{class:"dialog-footer"},[s("button",{class:"m3-button text",onClick:_}," 稍后重启 "),s("button",{class:"m3-button filled",onClick:C},[...f[2]||(f[2]=[s("span",{class:"material-symbols-rounded"},"restart_alt",-1),s("span",null,"立即重启",-1)])])])])):i("",!0)]),_:1})])):i("",!0)]),_:1})]))}}),_l=as(pl,[["__scopeId","data-v-8bea0f4d"]]),fl={class:"update-view"},bl={class:"tabs-nav"},gl=["onClick"],yl={class:"material-symbols-rounded"},hl={class:"tab-label"},kl={class:"tab-content"},$l=es({__name:"GitUpdateView",setup(R){const X=[{id:"ui",label:"UI 更新",icon:"web"},{id:"main",label:"主程序",icon:"terminal"},{id:"git",label:"Git 设置",icon:"settings"}],v=u("ui"),h=u(!1),c=u("main"),k=u([]);function b(_){_&&(c.value="ui",k.value=[],h.value=!0)}function T(_){_&&(c.value="main",k.value=[],h.value=!0)}async function x(){h.value=!1;try{await Os()}catch(_){console.error("重启失败:",_)}}function C(){h.value=!1}return ls(()=>{}),(_,U)=>(a(),l("div",fl,[U[1]||(U[1]=As('<div class="page-header" data-v-8d4eeec6><div class="header-content" data-v-8d4eeec6><div class="header-icon" data-v-8d4eeec6><span class="material-symbols-rounded" data-v-8d4eeec6>system_update</span></div><div class="header-text" data-v-8d4eeec6><h1 data-v-8d4eeec6>更新管理</h1><p data-v-8d4eeec6>管理 MoFox-Bot 和 WebUI 的更新</p></div></div></div>',1)),s("div",bl,[(a(),l(A,null,O(X,f=>s("button",{key:f.id,class:w(["tab-item",{active:v.value===f.id}]),onClick:g=>v.value=f.id},[s("span",yl,o(f.icon),1),s("span",hl,o(f.label),1)],10,gl)),64))]),s("div",kl,[ss(q(sa,{ref:"uiUpdateTabRef",onUpdateComplete:b},null,512),[[ds,v.value==="ui"]]),ss(q(yt,{ref:"mainUpdateTabRef",onUpdateComplete:T},null,512),[[ds,v.value==="main"]]),ss(q(nl,{ref:"gitSettingsTabRef"},null,512),[[ds,v.value==="git"]])]),q(_l,{modelValue:h.value,"onUpdate:modelValue":U[0]||(U[0]=f=>h.value=f),"update-type":c.value,changelog:k.value,onRestart:x,onLater:C},null,8,["modelValue","update-type","changelog"])]))}}),Tl=as($l,[["__scopeId","data-v-8d4eeec6"]]);export{Tl as default};
