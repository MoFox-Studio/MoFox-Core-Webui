import{a as Z,r as b,D as J,G as ee,m as se,N as le,c as u,e as l,n as C,t as d,O as E,U as H,g as W,F,h as M,Q as te,J as z,o as f,q as oe,_ as ae}from"./index-CLTUvmfq.js";const ne={class:"live-log-view"},ie={class:"page-header"},re={class:"header-content"},ce={class:"title-group"},ue={class:"status-text"},de={class:"content-wrapper"},fe={class:"log-container"},ve={class:"toolbar"},pe={class:"toolbar-left"},me=["disabled"],ge={class:"material-symbols-rounded"},be=["disabled"],_e={class:"m3-switch-container"},he={class:"m3-switch"},ye={class:"toolbar-right"},we={class:"filter-group"},ke={class:"level-filter-dropdown"},Ce={class:"material-symbols-rounded"},Le={key:0,class:"filter-dropdown-menu m3-card"},xe=["value"],Se={class:"search-box"},Ie={class:"stats-bar"},Ne={class:"stat-item"},Re={class:"stat-value"},$e={key:0,class:"stat-item"},Te={class:"stat-value"},Oe={class:"stat-label"},Ee={key:0,class:"loading-state"},We={key:1,class:"empty-state"},Fe={key:2,class:"empty-state"},Me={key:3,class:"log-entries terminal-style"},Ue={class:"terminal-time"},Ae=["title"],Be=["innerHTML"],De=Z({__name:"LiveLogView",setup(Ve){const m=b(!1),g=b(!1),v=b([]),S=b(!0),_=b(null),I=b(null),U=["DEBUG","INFO","WARNING","ERROR","CRITICAL"],y=b(["INFO","WARNING","ERROR","CRITICAL"]),w=b(!1),N=b(""),j=()=>{w.value=!w.value},A=t=>{t.target.closest(".level-filter-dropdown")||(w.value=!1)},R=J(()=>{let t=v.value;if(y.value.length>0&&y.value.length<U.length&&(t=t.filter(e=>y.value.includes(e.level))),N.value){const e=N.value.toLowerCase();t=t.filter(s=>s.event.toLowerCase().includes(e)||s.logger_name&&s.logger_name.toLowerCase().includes(e)||s.alias&&s.alias.toLowerCase().includes(e))}return t}),q=J(()=>{const t={DEBUG:0,INFO:0,WARNING:0,ERROR:0,CRITICAL:0};return v.value.forEach(e=>{const s=e.level;s&&t[s]!==void 0&&t[s]++}),t}),K=t=>t?t.replace("T"," ").substring(0,19):"",P=t=>{let e=!1,s="",n=!1,o="";for(let r=0;r<t.length;r++){const a=t[r];if(e)n?(a===s?s==="'"?o+=a:o+="\\"+a:a==="\\"?o+="\\\\":a==="n"?o+="\\n":a==="r"?o+="\\r":a==="t"?o+="\\t":a==='"'?o+='\\"':o+="\\"+a,n=!1):a==="\\"?n=!0:a===s?(e=!1,s="",o+='"'):a==='"'?o+='\\"':o+=a;else if((a==="'"||a==='"')&&!n)e=!0,s=a,o+='"';else if(a===":"&&t.substring(r+1).match(/^\s*(True|False|None)\b/)){const p=t.substring(r+1).match(/^\s*(True|False|None)\b/);p&&(p[1]==="True"?o+=": true":p[1]==="False"?o+=": false":p[1]==="None"&&(o+=": null"),r+=p[0].length)}else o+=a}return o},B=t=>{var G;if(!t)return"";const e=t.trim();if(e.startsWith("{")&&e.endsWith("}"))try{let i=null;try{i=JSON.parse(e)}catch{const O=P(e);i=JSON.parse(O)}if(i&&typeof i=="object"&&i.event)return B(i.event)}catch(i){console.warn("解析 Python 字典格式失败，将作为普通文本处理:",i)}let s=t;if(s=s.replace(/\[#([0-9A-Fa-f]{6})\]([\s\S]*?)\[\/#\1\]/g,'<span style="color: #$1;">$2</span>'),s=s.replace(/\[b\]([\s\S]*?)\[\/b\]/g,"<strong>$1</strong>"),s=s.replace(/\[i\]([\s\S]*?)\[\/i\]/g,"<em>$1</em>"),s=s.replace(/\[u\]([\s\S]*?)\[\/u\]/g,"<u>$1</u>"),s!==t)return s=s.replace(/\n/g,"<br>"),s;const n=/[\x1b\x9b]\[([0-9;]+)m/g,o={30:"#000000",31:"#e74c3c",32:"#2ecc71",33:"#f39c12",34:"#3498db",35:"#9b59b6",36:"#1abc9c",37:"#ecf0f1",90:"#7f8c8d",91:"#ff6b6b",92:"#51cf66",93:"#ffd43b",94:"#74c0fc",95:"#da77f2",96:"#3bc9db",97:"#ffffff",40:"#000000",41:"#e74c3c",42:"#2ecc71",43:"#f39c12",44:"#3498db",45:"#9b59b6",46:"#1abc9c",47:"#ecf0f1",100:"#7f8c8d",101:"#ff6b6b",102:"#51cf66",103:"#ffd43b",104:"#74c0fc",105:"#da77f2",106:"#3bc9db",107:"#ffffff"};let r="",a=0,p="",k="",x=!1,$;for(;($=n.exec(t))!==null;){const i=t.substring(a,$.index);if(i){let c="";p&&(c+=`color: ${p};`),k&&(c+=` background-color: ${k};`),x&&(c+=" font-weight: bold;"),c?r+=`<span style="${c}">${L(i)}</span>`:r+=L(i)}const O=((G=$[1])==null?void 0:G.split(";"))||[];for(const c of O)if(c==="0"||c==="")p="",k="",x=!1;else if(c==="1")x=!0;else if(c==="22")x=!1;else if(o[c]){const h=parseInt(c);h>=30&&h<=37||h>=90&&h<=97?p=o[c]:(h>=40&&h<=47||h>=100&&h<=107)&&(k=o[c])}a=n.lastIndex}const T=t.substring(a);if(T){let i="";p&&(i+=`color: ${p};`),k&&(i+=` background-color: ${k};`),x&&(i+=" font-weight: bold;"),i?r+=`<span style="${i}">${L(T)}</span>`:r+=L(T)}return r||L(t)},L=t=>{const e=document.createElement("div");return e.textContent=t,e.innerHTML},Q=()=>{m.value?D():X()},X=async()=>{if(!(g.value||m.value)){g.value=!0;try{const t=localStorage.getItem("mofox_token");if(!t){console.error("未找到 API Key，请先登录"),g.value=!1;return}const s=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/webui/api/realtime_log/realtime?api_key=${encodeURIComponent(t)}`;console.log("正在连接WebSocket:",s.replace(t,"****")),_.value=new WebSocket(s),_.value.onopen=()=>{console.log("WebSocket已连接"),m.value=!0,g.value=!1},_.value.onmessage=n=>{try{let o=JSON.parse(n.data);if(typeof o=="string")try{o=JSON.parse(o)}catch{o={timestamp:new Date().toISOString(),level:"INFO",logger_name:"unknown",event:String(o),line_number:0,file_name:"realtime"}}o.line_number=v.value.length+1,o.file_name="realtime",v.value.push(o),v.value.length>1e3&&(v.value.shift(),v.value.forEach((r,a)=>{r.line_number=a+1})),S.value&&z(()=>{V()})}catch(o){console.error("解析日志消息失败:",o,n.data)}},_.value.onerror=n=>{console.error("WebSocket错误:",n),g.value=!1},_.value.onclose=()=>{console.log("WebSocket已断开"),m.value=!1,g.value=!1}}catch(t){console.error("连接WebSocket失败:",t),g.value=!1}}},D=()=>{_.value&&(_.value.close(),_.value=null),m.value=!1,g.value=!1},Y=()=>{v.value=[]},V=()=>{I.value&&(I.value.scrollTop=I.value.scrollHeight)};return ee(S,t=>{t&&z(()=>{V()})}),se(()=>{document.addEventListener("click",A)}),le(()=>{D(),document.removeEventListener("click",A)}),(t,e)=>(f(),u("div",ne,[l("div",ie,[l("div",re,[l("div",ce,[e[4]||(e[4]=l("span",{class:"material-symbols-rounded title-icon"},"sensors",-1)),e[5]||(e[5]=l("h1",{class:"page-title"},"实时日志",-1)),l("div",{class:C(["status-badge",{connected:m.value}])},[e[3]||(e[3]=l("span",{class:"status-dot"},null,-1)),l("span",ue,d(m.value?"已连接":"未连接"),1)],2)]),e[6]||(e[6]=l("p",{class:"page-description"},"实时查看系统日志输出",-1))])]),l("div",de,[l("div",fe,[l("div",ve,[l("div",pe,[l("button",{class:"m3-button filled",onClick:Q,disabled:g.value},[l("span",ge,d(m.value?"pause":"play_arrow"),1),l("span",null,d(m.value?"断开连接":"开始监听"),1)],8,me),l("button",{class:"m3-button text error",onClick:Y,disabled:!m.value&&v.value.length===0},[...e[7]||(e[7]=[l("span",{class:"material-symbols-rounded"},"delete",-1),l("span",null,"清空日志",-1)])],8,be),e[10]||(e[10]=l("div",{class:"separator-line"},null,-1)),l("div",_e,[l("label",he,[E(l("input",{type:"checkbox","onUpdate:modelValue":e[0]||(e[0]=s=>S.value=s)},null,512),[[H,S.value]]),e[8]||(e[8]=l("span",{class:"slider"},null,-1))]),e[9]||(e[9]=l("span",{class:"switch-label"},"自动滚动",-1))])]),l("div",ye,[l("div",we,[l("div",ke,[l("button",{class:C(["m3-filter-chip",{active:w.value}]),onClick:j},[e[11]||(e[11]=l("span",{class:"material-symbols-rounded"},"filter_list",-1)),l("span",null,"日志级别 ("+d(y.value.length)+")",1),l("span",Ce,d(w.value?"expand_less":"expand_more"),1)],2),w.value?(f(),u("div",Le,[(f(),u(F,null,M(U,s=>l("label",{key:s,class:"filter-option"},[E(l("input",{type:"checkbox",value:s,"onUpdate:modelValue":e[1]||(e[1]=n=>y.value=n)},null,8,xe),[[H,y.value]]),l("span",{class:C(["level-badge","level-"+s.toLowerCase()])},d(s),3)])),64))])):W("",!0)]),l("div",Se,[e[12]||(e[12]=l("span",{class:"material-symbols-rounded search-icon"},"search",-1)),E(l("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>N.value=s),type:"text",class:"m3-input",placeholder:"搜索日志内容..."},null,512),[[te,N.value]])])])])]),l("div",Ie,[l("div",Ne,[e[13]||(e[13]=l("span",{class:"stat-label"},"总数:",-1)),l("span",Re,d(v.value.length),1)]),v.value.length!==R.value.length?(f(),u("div",$e,[e[14]||(e[14]=l("span",{class:"stat-label"},"已筛选:",-1)),l("span",Te,d(R.value.length),1)])):W("",!0),(f(!0),u(F,null,M(q.value,(s,n)=>(f(),u("div",{class:"stat-item",key:n},[l("span",Oe,d(n)+":",1),l("span",{class:C(["stat-value","level-"+n.toLowerCase()])},d(s),3)]))),128))]),l("div",{class:"log-content",ref_key:"logContentContainer",ref:I},[g.value?(f(),u("div",Ee,[...e[15]||(e[15]=[l("span",{class:"material-symbols-rounded spinning loading-icon"},"progress_activity",-1),l("p",null,"正在连接...",-1)])])):!m.value&&v.value.length===0?(f(),u("div",We,[...e[16]||(e[16]=[l("span",{class:"material-symbols-rounded empty-icon"},"sensors",-1),l("p",null,'点击"开始监听"按钮开始接收实时日志',-1)])])):R.value.length===0?(f(),u("div",Fe,[...e[17]||(e[17]=[l("span",{class:"material-symbols-rounded empty-icon"},"filter_list_off",-1),l("p",null,"没有匹配的日志",-1),l("p",{style:{"font-size":"12px","margin-top":"8px"}},"尝试调整筛选条件或搜索关键词",-1)])])):(f(),u("div",Me,[(f(!0),u(F,null,M(R.value,s=>(f(),u("div",{key:s.line_number,class:C(["log-entry terminal-line",`level-${s.level.toLowerCase()}`])},[l("span",Ue,d(K(s.timestamp)),1),l("span",{class:C(["terminal-level",`level-${s.level.toLowerCase()}`])}," ["+d(s.level)+"] ",3),s.alias||s.logger_name?(f(),u("span",{key:0,class:"terminal-logger",style:oe(s.logger_color?{color:s.logger_color}:{}),title:s.alias?s.logger_name:""}," ["+d(s.alias||s.logger_name)+"] ",13,Ae)):W("",!0),l("span",{class:"terminal-message",innerHTML:B(s.event)},null,8,Be)],2))),128))]))],512)])])]))}}),Je=ae(De,[["__scopeId","data-v-fd18e167"]]);export{Je as default};
