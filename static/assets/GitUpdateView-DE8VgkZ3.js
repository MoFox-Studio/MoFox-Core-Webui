import{a2 as A,a as Z,r as d,D as H,m as ts,c as t,g as i,l as ls,e as s,t as n,n as C,F,h as z,s as ns,M as os,o as a,_ as ss,N as Gs,L as ks,az as xs,aA as Ts,ad as is,aB as Us,aC as Ds,aD as Ss,aE as Is,aF as Bs,aG as Vs,O as as,P as Ms,f as Q,T as gs,w as hs,ac as Rs,S as us}from"./index-B2Qv5MjU.js";import{s as Y,a as J,b as S}from"./dialog-BBcEjphh.js";import{r as Ls}from"./dashboard-BKPbRz_L.js";import"./ConfirmDialog-BYekJRPR.js";import"./iconify-CenZVvVe.js";function Ws(){return A.get("ui_update/status")}function Ps(){return A.post("ui_update/update")}function Ns(){return A.get("ui_update/backups")}function Es(V){return A.post("ui_update/rollback",{commit_hash:V})}function Fs(V){return A.get(`ui_update/commit/${V}`)}const zs={class:"ui-update-tab"},As={key:0,class:"m3-card disabled-card"},Os={class:"disabled-content"},Xs={class:"disabled-text"},js={key:1,class:"m3-card version-card"},qs={key:0,class:"version-info"},Hs={class:"info-row"},Js={class:"info-value version"},Ks={key:0,class:"info-row"},Qs={class:"info-value"},Ys={key:1,class:"info-row"},Zs={class:"info-value branch"},se={key:2,class:"info-row"},ee={class:"info-value commit"},ae={key:1,class:"version-info"},te={key:2,class:"m3-card update-check-card"},le={class:"card-header"},ne=["disabled"],oe={key:0,class:"update-result"},ie={key:0,class:"has-update"},ue={class:"update-badge"},de={key:0,class:"changelog"},re={class:"update-actions"},ce=["disabled"],ve={key:1,class:"up-to-date"},me={key:1,class:"error-message"},pe={key:3,class:"m3-card backup-card"},_e={class:"card-header"},fe=["disabled"],be={key:0,class:"backup-list"},ye={class:"backup-info"},ge={class:"backup-header"},he={class:"backup-commit"},ke={key:0,class:"backup-version"},$e={key:1,class:"current-badge"},we={class:"backup-message"},Ce={class:"backup-meta"},Ge={class:"backup-actions"},xe=["onClick","disabled"],Te=["onClick","disabled"],Ue={key:1,class:"no-backups"},De={class:"detail-dialog"},Se={class:"detail-header"},Ie={key:0,class:"detail-content"},Be={class:"detail-section"},Ve={class:"detail-row"},Me={class:"detail-value"},Re={key:0,class:"detail-row"},Le={class:"detail-value version-tag"},We={class:"detail-row"},Pe={class:"detail-value"},Ne={key:1,class:"detail-row"},Ee={class:"detail-value"},Fe={key:0,class:"detail-section"},ze={class:"commit-message"},Ae={key:1,class:"detail-section"},Oe={class:"commit-body"},Xe={key:2,class:"detail-section"},je={class:"files-list"},qe={class:"file-path"},He={key:0,class:"files-more"},Je={key:1,class:"detail-content loading"},Ke=Z({__name:"UIUpdateTab",emits:["update-complete"],setup(V,{expose:O,emit:c}){const h=c,r=d(null),$=d([]),f=d(!1),U=d(!1),x=d(!1),G=d(!1),y=d(""),T=d(!1),_=d(!1),p=d(null),I=H(()=>r.value?{version:r.value.current_version||"未安装",build_time:null,branch:r.value.current_branch,commit:r.value.current_commit}:null),L=H(()=>r.value?r.value.update_enabled===!1:!1),X=H(()=>r.value?r.value.message?r.value.message:r.value.update_enabled===!1?`当前分支为 "${r.value.current_branch||"未知"}"，更新功能已禁用。仅 webui-dist 分支支持自动更新。`:"":"");function N(g){if(!g)return"-";try{return new Date(g).toLocaleString("zh-CN")}catch{return g}}async function v(){f.value=!0,y.value="";try{const g=await Ws();g.success&&g.data?(r.value=g.data,g.data.success||(y.value=g.data.error||"获取状态失败")):y.value=g.error||"获取状态失败"}catch(g){y.value=g.message||"获取状态失败"}finally{f.value=!1}}async function o(){await v()}async function m(){var l,j;if(await Y({title:"确认更新",message:"更新 UI 将刷新页面，是否继续？",confirmText:"更新"})){U.value=!0,y.value="";try{const M=await Ps();M.success&&((l=M.data)!=null&&l.success)?(J(`更新成功！已更新到 ${M.data.version||"最新版本"}`),h("update-complete",!0)):S(((j=M.data)==null?void 0:j.error)||M.error||"更新失败")}catch(M){S(M.message||"更新失败")}finally{U.value=!1}}}async function k(){var g;G.value=!0;try{const l=await Ns();l.success&&((g=l.data)!=null&&g.data)&&($.value=l.data.data)}catch(l){console.error("加载备份列表失败:",l)}finally{G.value=!1}}async function B(g){var M,b;const l=g.substring(0,7);if(await Y({title:"确认回滚",message:`确定要回滚到版本 "${l}" 吗？此操作将重置到该版本。`,confirmText:"回滚"})){x.value=!0;try{const R=await Es(g);R.success&&((M=R.data)!=null&&M.success)?(J(R.data.message||"回滚成功"),h("update-complete",!0)):S(((b=R.data)==null?void 0:b.error)||R.error||"回滚失败")}catch(R){S(R.message||"回滚失败")}finally{x.value=!1}}}async function W(g){T.value=!0,_.value=!0,p.value=null;try{const l=await Fs(g);l.success&&l.data?p.value=l.data:(S(l.error||"获取详情失败"),T.value=!1)}catch(l){S(l.message||"获取详情失败"),T.value=!1}finally{_.value=!1}}function es(g){return{新增:"status-add",修改:"status-modify",删除:"status-delete",重命名:"status-rename"}[g]||""}return ts(()=>{v(),k()}),O({refresh:()=>{v(),k()}}),(g,l)=>{var j,M;return a(),t("div",zs,[L.value?(a(),t("div",As,[s("div",Os,[l[3]||(l[3]=s("span",{class:"material-symbols-rounded icon-warning"},"info",-1)),s("div",Xs,[l[2]||(l[2]=s("h4",null,"更新功能已禁用",-1)),s("p",null,n(X.value),1)])])])):i("",!0),L.value?i("",!0):(a(),t("div",js,[l[9]||(l[9]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"web"),s("h3",null,"当前版本")],-1)),I.value?(a(),t("div",qs,[s("div",Hs,[l[4]||(l[4]=s("span",{class:"info-label"},"版本号:",-1)),s("span",Js,"v"+n(I.value.version),1)]),I.value.build_time?(a(),t("div",Ks,[l[5]||(l[5]=s("span",{class:"info-label"},"构建时间:",-1)),s("span",Qs,n(N(I.value.build_time)),1)])):i("",!0),I.value.branch?(a(),t("div",Ys,[l[6]||(l[6]=s("span",{class:"info-label"},"分支:",-1)),s("span",Zs,n(I.value.branch),1)])):i("",!0),I.value.commit?(a(),t("div",se,[l[7]||(l[7]=s("span",{class:"info-label"},"Commit:",-1)),s("code",ee,n(I.value.commit.substring(0,8)),1)])):i("",!0)])):(a(),t("div",ae,[...l[8]||(l[8]=[s("p",{class:"no-version"},"未检测到版本信息",-1)])]))])),L.value?i("",!0):(a(),t("div",te,[s("div",le,[l[10]||(l[10]=s("span",{class:"material-symbols-rounded"},"sync",-1)),l[11]||(l[11]=s("h3",null,"检查更新",-1)),s("button",{class:"m3-button tonal",onClick:o,disabled:f.value||L.value},[s("span",{class:C(["material-symbols-rounded",{spinning:f.value}])},n(f.value?"progress_activity":"refresh"),3),s("span",null,n(f.value?"检查中...":"检查更新"),1)],8,ne)]),r.value&&!L.value?(a(),t("div",oe,[r.value.has_update?(a(),t("div",ie,[s("div",ue,[l[12]||(l[12]=s("span",{class:"material-symbols-rounded"},"auto_awesome",-1)),s("span",null,"发现新版本 v"+n(r.value.latest_version),1)]),(j=r.value.changelog)!=null&&j.length?(a(),t("div",de,[l[13]||(l[13]=s("h4",null,"更新内容:",-1)),s("ul",null,[(a(!0),t(F,null,z(r.value.changelog.slice(0,10),(b,R)=>(a(),t("li",{key:R},n(b),1))),128))])])):i("",!0),s("div",re,[s("button",{class:"m3-button filled",onClick:m,disabled:U.value},[s("span",{class:C(["material-symbols-rounded",{spinning:U.value}])},n(U.value?"progress_activity":"download"),3),s("span",null,n(U.value?"更新中...":"立即更新"),1)],8,ce)])])):(a(),t("div",ve,[...l[14]||(l[14]=[s("span",{class:"material-symbols-rounded icon-success"},"check_circle",-1),s("span",null,"已是最新版本",-1)])]))])):i("",!0),y.value?(a(),t("div",me,[l[15]||(l[15]=s("span",{class:"material-symbols-rounded"},"error",-1)),s("span",null,n(y.value),1)])):i("",!0)])),L.value?i("",!0):(a(),t("div",pe,[s("div",_e,[l[16]||(l[16]=s("span",{class:"material-symbols-rounded"},"history",-1)),l[17]||(l[17]=s("h3",null,"历史版本",-1)),s("button",{class:"m3-icon-button",onClick:k,disabled:G.value},[s("span",{class:C(["material-symbols-rounded",{spinning:G.value}])},"refresh",2)],8,fe)]),$.value.length?(a(),t("div",be,[(a(!0),t(F,null,z($.value,b=>(a(),t("div",{key:b.commit,class:C(["backup-item",{"is-current":b.is_current}])},[s("div",ye,[s("div",ge,[s("code",he,n(b.commit_short),1),b.version?(a(),t("span",ke,"v"+n(b.version),1)):i("",!0),b.is_current?(a(),t("span",$e,"当前")):i("",!0)]),s("span",we,n(b.message),1),s("span",Ce,n(N(b.timestamp)),1)]),s("div",Ge,[s("button",{class:"m3-button text",onClick:R=>W(b.commit),disabled:_.value},[...l[18]||(l[18]=[s("span",{class:"material-symbols-rounded"},"info",-1),s("span",null,"详情",-1)])],8,xe),s("button",{class:"m3-button text",onClick:R=>B(b.commit),disabled:x.value||b.is_current},[...l[19]||(l[19]=[s("span",{class:"material-symbols-rounded"},"restore",-1),s("span",null,"回滚",-1)])],8,Te)])],2))),128))])):(a(),t("div",Ue,[...l[20]||(l[20]=[s("span",{class:"material-symbols-rounded"},"history_toggle_off",-1),s("span",null,"暂无历史版本",-1)])]))])),(a(),ls(os,{to:"body"},[T.value?(a(),t("div",{key:0,class:"detail-dialog-overlay",onClick:l[1]||(l[1]=ns(b=>T.value=!1,["self"]))},[s("div",De,[s("div",Se,[l[22]||(l[22]=s("h3",null,"版本详情",-1)),s("button",{class:"m3-icon-button",onClick:l[0]||(l[0]=b=>T.value=!1)},[...l[21]||(l[21]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),p.value?(a(),t("div",Ie,[s("div",Be,[s("div",Ve,[l[23]||(l[23]=s("span",{class:"detail-label"},"Commit:",-1)),s("code",Me,n(p.value.commit_short),1)]),p.value.version?(a(),t("div",Re,[l[24]||(l[24]=s("span",{class:"detail-label"},"版本:",-1)),s("span",Le,"v"+n(p.value.version),1)])):i("",!0),s("div",We,[l[25]||(l[25]=s("span",{class:"detail-label"},"时间:",-1)),s("span",Pe,n(N(p.value.timestamp)),1)]),p.value.author?(a(),t("div",Ne,[l[26]||(l[26]=s("span",{class:"detail-label"},"作者:",-1)),s("span",Ee,n(p.value.author),1)])):i("",!0)]),p.value.message?(a(),t("div",Fe,[l[27]||(l[27]=s("h4",null,"提交消息",-1)),s("p",ze,n(p.value.message),1)])):i("",!0),p.value.body?(a(),t("div",Ae,[l[28]||(l[28]=s("h4",null,"更新内容",-1)),s("pre",Oe,n(p.value.body),1)])):i("",!0),(M=p.value.files_changed)!=null&&M.length?(a(),t("div",Xe,[s("h4",null,"修改文件 ("+n(p.value.files_changed.length)+")",1),s("div",je,[(a(!0),t(F,null,z(p.value.files_changed.slice(0,20),(b,R)=>(a(),t("div",{key:R,class:"file-item"},[s("span",{class:C(["file-status",es(b.status)])},n(b.status),3),s("span",qe,n(b.path),1)]))),128)),p.value.files_changed.length>20?(a(),t("div",He," ... 及其他 "+n(p.value.files_changed.length-20)+" 个文件 ",1)):i("",!0)])])):i("",!0)])):_.value?(a(),t("div",Je,[...l[29]||(l[29]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):i("",!0)])])):i("",!0)]))])}}}),Qe=ss(Ke,[["__scopeId","data-v-da3800a9"]]);function $s(){return A.get("git_env/status")}function Ye(){return A.post("git_env/install")}function Ze(V){return A.post("git_env/set-path",{path:V})}function sa(){return A.post("git_env/auto-detect")}function ea(){return A.get("git_env/install-guide")}const aa={class:"main-update-tab"},ta={class:"m3-card branch-card"},la={key:0,class:"loading-placeholder"},na={key:1,class:"card-disabled-hint"},oa={key:2,class:"branch-selector"},ia={class:"selected-value"},ua={key:0,class:"m3-select-dropdown m3-card"},da=["onClick"],ra={key:0,class:"material-symbols-rounded check-icon"},ca={key:0,class:"switching-indicator"},va=["disabled","title"],ma={class:"m3-card update-card"},pa={class:"card-header"},_a=["disabled"],fa={key:0,class:"loading-placeholder"},ba={key:1,class:"alert alert-warning"},ya={key:2,class:"alert alert-warning"},ga={key:3,class:"update-result"},ha={key:0,class:"has-update"},ka={class:"update-header"},$a={class:"update-title"},wa={class:"version-compare"},Ca={class:"version-box version-current"},Ga={class:"version-box version-latest"},xa={key:0,class:"changelog"},Ta={class:"update-actions"},Ua={key:0,class:"material-symbols-rounded check-icon"},Da=["disabled"],Sa={key:1,class:"up-to-date"},Ia={class:"up-to-date-info"},Ba={key:0},Va={key:4,class:"error-message"},Ma={class:"m3-card backup-card"},Ra={class:"card-header"},La=["disabled"],Wa={key:0,class:"loading-placeholder"},Pa={key:1,class:"card-disabled-hint"},Na={key:2,class:"backup-list"},Ea={class:"backup-info"},Fa={class:"backup-header"},za={class:"backup-commit"},Aa={key:0,class:"current-badge"},Oa={class:"backup-message"},Xa={class:"backup-meta"},ja={class:"backup-actions"},qa=["onClick","disabled"],Ha=["onClick","disabled"],Ja={key:3,class:"no-backups"},Ka={class:"detail-dialog"},Qa={class:"detail-header"},Ya={key:0,class:"detail-content"},Za={class:"detail-section"},st={class:"detail-row"},et={class:"detail-value"},at={class:"detail-row"},tt={class:"detail-value"},lt={key:0,class:"detail-row"},nt={class:"detail-value"},ot={key:0,class:"detail-section"},it={class:"commit-message"},ut={key:1,class:"detail-section"},dt={class:"commit-body"},rt={key:2,class:"detail-section"},ct={class:"files-list"},vt={class:"file-path"},mt={key:0,class:"files-more"},pt={key:1,class:"detail-content loading"},_t=Z({__name:"MainUpdateTab",emits:["update-complete"],setup(V,{expose:O,emit:c}){const h=c,r=d(null),$=d(null),f=d(null),U=d([]),x=d(""),G=d(!1),y=d(!0),T=d(!1),_=d(!1),p=d(!1),I=d(!1),L=d(!1),X=d(!1),N=d(!1),v=d(""),o=d(!1),m=d(!1),k=d(null),B=d(null);async function W(){try{const[u,e]=await Promise.all([$s(),xs()]);u.success&&u.data&&(r.value=u.data),e.success&&e.data&&($.value=e.data,e.data.current_branch&&(x.value=e.data.current_branch))}catch(u){console.error("加载状态失败:",u)}}function es(){p.value||(G.value=!G.value)}async function g(){var u;if(!I.value){I.value=!0;try{const e=await Ts();e.success&&e.data?($.value=e.data,e.data.current_branch&&(x.value=e.data.current_branch),is("分支列表已刷新","success")):is(((u=e.data)==null?void 0:u.error)||e.error||"刷新分支列表失败","error")}catch(e){is(e.message||"刷新分支列表失败（网络可能不可用）","error")}finally{I.value=!1}}}async function l(u){var q,P;if(G.value=!1,!(u===x.value||!await Y({title:"切换分支",message:`确定要切换到分支 "${u}" 吗？`,confirmText:"切换"}))){p.value=!0;try{const D=await Is(u);D.success&&((q=D.data)!=null&&q.success)?(x.value=u,J(D.data.message||"分支切换成功"),h("update-complete",!0)):S(((P=D.data)==null?void 0:P.error)||D.error||"切换分支失败")}catch(D){S(D.message||"切换分支失败")}finally{p.value=!1}}}async function j(){T.value=!0,v.value="",f.value=null;try{const u=await Us();u.success&&u.data?(f.value=u.data,u.data.success||(v.value=u.data.error||"检查更新失败")):v.value=u.error||"检查更新失败"}catch(u){v.value=u.message||"检查更新失败"}finally{T.value=!1}}async function M(){var q,P;const u=o.value?"强制更新将覆盖所有本地修改，更新后需要重启才能生效，是否继续？":"更新主程序后需要重启才能生效，是否继续？";if(await Y({title:"确认更新",message:u,confirmText:"更新"})){_.value=!0,v.value="";try{const D=await Ds(o.value,!0);D.success&&((q=D.data)!=null&&q.success)?(J(D.data.message||"更新成功"),f.value=null,await W(),h("update-complete",!0),b()):S(((P=D.data)==null?void 0:P.error)||D.error||"更新失败")}catch(D){S(D.message||"更新失败")}finally{_.value=!1}}}async function b(){var u;X.value=!0;try{const e=await Ss();e.success&&((u=e.data)!=null&&u.data)&&(U.value=e.data.data)}catch(e){console.error("加载历史版本列表失败:",e)}finally{X.value=!1}}async function R(u){var P,D;const e=u.substring(0,7);if(await Y({title:"确认回滚",message:`确定要回滚到版本 "${e}" 吗？此操作将重置到该版本，回滚后需要重启程序。`,confirmText:"回滚"})){L.value=!0;try{const E=await Bs(u);E.success&&((P=E.data)!=null&&P.success)?(J(E.data.message||"回滚成功"),h("update-complete",!0),b()):S(((D=E.data)==null?void 0:D.error)||E.error||"回滚失败")}catch(E){S(E.message||"回滚失败")}finally{L.value=!1}}}async function ws(u){m.value=!0,N.value=!0,k.value=null;try{const e=await Vs(u);e.success&&e.data?k.value=e.data:(S(e.error||"获取详情失败"),m.value=!1)}catch(e){S(e.message||"获取详情失败"),m.value=!1}finally{N.value=!1}}function ds(u){if(!u)return"-";try{return new Date(u).toLocaleString("zh-CN")}catch{return u}}function Cs(u){return{新增:"status-add",修改:"status-modify",删除:"status-delete",重命名:"status-rename"}[u]||""}function rs(u){B.value&&!B.value.contains(u.target)&&(G.value=!1)}return ts(async()=>{var u,e;document.addEventListener("click",rs);try{await W(),b(),(u=r.value)!=null&&u.git_available&&((e=$.value)!=null&&e.is_git_repo)&&j()}finally{y.value=!1}}),Gs(()=>{document.removeEventListener("click",rs)}),O({refresh:()=>{W(),b(),f.value=null}}),(u,e)=>{var q,P,D,E,cs,vs,ms,ps,_s,fs,bs,ys;return a(),t("div",aa,[s("div",ta,[e[7]||(e[7]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"fork_right"),s("h3",null,"分支管理")],-1)),y.value?(a(),t("div",la,[...e[3]||(e[3]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):!((q=r.value)!=null&&q.git_available)||(((D=(P=$.value)==null?void 0:P.available_branches)==null?void 0:D.length)??0)===0?(a(),t("div",na,[e[4]||(e[4]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,n((E=r.value)!=null&&E.git_available?"无可用分支":"Git 环境不可用"),1)])):(a(),t("div",oa,[e[6]||(e[6]=s("label",{class:"m3-label"},"当前分支:",-1)),s("div",{class:"select-wrapper",ref_key:"branchSelectWrapper",ref:B},[s("div",{class:C(["m3-select-trigger",{disabled:p.value,active:G.value}]),onClick:es},[s("span",ia,n(x.value),1),s("span",{class:C(["material-symbols-rounded select-arrow",{rotated:G.value}])}," arrow_drop_down ",2)],2),G.value?(a(),t("div",ua,[(a(!0),t(F,null,z(((cs=$.value)==null?void 0:cs.available_branches)??[],w=>(a(),t("div",{key:w,class:C(["m3-select-option",{selected:w===x.value}]),onClick:K=>l(w)},[s("span",null,n(w),1),w===x.value?(a(),t("span",ra,"check")):i("",!0)],10,da))),128))])):i("",!0)],512),p.value?(a(),t("span",ca,[...e[5]||(e[5]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),ks(" 切换中... ",-1)])])):(a(),t("button",{key:1,class:"m3-icon-button",onClick:g,disabled:I.value,title:I.value?"刷新中...":"刷新远程分支列表"},[s("span",{class:C(["material-symbols-rounded",{spinning:I.value}])},"sync",2)],8,va))]))]),s("div",ma,[s("div",pa,[e[8]||(e[8]=s("span",{class:"material-symbols-rounded"},"sync",-1)),e[9]||(e[9]=s("h3",null,"更新检测",-1)),s("button",{class:"m3-button tonal",onClick:j,disabled:y.value||T.value||!((vs=r.value)!=null&&vs.git_available)},[s("span",{class:C(["material-symbols-rounded",{spinning:T.value}])},n(T.value?"progress_activity":"refresh"),3),s("span",null,n(T.value?"检查中...":"检查更新"),1)],8,_a)]),y.value||T.value?(a(),t("div",fa,[e[10]||(e[10]=s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1)),s("span",null,n(y.value?"加载中...":"检查更新中..."),1)])):r.value&&!r.value.git_available?(a(),t("div",ba,[...e[11]||(e[11]=[s("span",{class:"material-symbols-rounded"},"warning",-1),s("span",null,'Git 不可用，请先在"Git 设置"中配置 Git 环境',-1)])])):$.value&&!$.value.is_git_repo?(a(),t("div",ya,[...e[12]||(e[12]=[s("span",{class:"material-symbols-rounded"},"warning",-1),s("span",null,"主程序目录不是 Git 仓库，无法使用自动更新功能",-1)])])):f.value?(a(),t("div",ga,[f.value.has_update?(a(),t("div",ha,[s("div",ka,[e[14]||(e[14]=s("div",{class:"update-icon"},[s("span",{class:"material-symbols-rounded"},"auto_awesome")],-1)),s("div",$a,[e[13]||(e[13]=s("h4",null,"发现新版本",-1)),s("p",null,"有 "+n(f.value.commits_behind)+" 个新提交等待更新",1)])]),s("div",wa,[s("div",Ca,[e[15]||(e[15]=s("span",{class:"version-tag"},"当前",-1)),s("code",null,n(f.value.current_commit||"未知"),1)]),e[17]||(e[17]=s("span",{class:"material-symbols-rounded arrow-icon"},"arrow_forward",-1)),s("div",Ga,[e[16]||(e[16]=s("span",{class:"version-tag"},"最新",-1)),s("code",null,n(f.value.remote_commit||"未知"),1)])]),(ms=f.value.update_logs)!=null&&ms.length?(a(),t("div",xa,[e[18]||(e[18]=s("h4",null,"更新内容:",-1)),s("ul",null,[(a(!0),t(F,null,z(f.value.update_logs.slice(0,5),(w,K)=>(a(),t("li",{key:K},n(w),1))),128))])])):i("",!0),s("div",Ta,[s("label",{class:C(["force-update-checkbox",{disabled:_.value}]),onClick:e[0]||(e[0]=w=>!_.value&&(o.value=!o.value))},[s("div",{class:C(["custom-checkbox",{checked:o.value}])},[o.value?(a(),t("span",Ua,"check")):i("",!0)],2),e[19]||(e[19]=s("span",{class:"checkbox-label"},"强制更新（覆盖本地修改）",-1))],2),s("button",{class:"m3-button filled",onClick:M,disabled:_.value},[s("span",{class:C(["material-symbols-rounded",{spinning:_.value}])},n(_.value?"progress_activity":"download"),3),s("span",null,n(_.value?"更新中...":"立即更新"),1)],8,Da)])])):(a(),t("div",Sa,[e[21]||(e[21]=s("span",{class:"material-symbols-rounded icon-success"},"check_circle",-1)),s("div",Ia,[e[20]||(e[20]=s("span",null,"已是最新版本",-1)),f.value.current_commit?(a(),t("code",Ba,n(f.value.current_commit),1)):i("",!0)])]))])):i("",!0),v.value?(a(),t("div",Va,[e[22]||(e[22]=s("span",{class:"material-symbols-rounded"},"error",-1)),s("span",null,n(v.value),1)])):i("",!0)]),s("div",Ma,[s("div",Ra,[e[23]||(e[23]=s("span",{class:"material-symbols-rounded"},"history",-1)),e[24]||(e[24]=s("h3",null,"历史版本",-1)),s("button",{class:"m3-icon-button",onClick:b,disabled:y.value||X.value||!((ps=r.value)!=null&&ps.git_available)},[s("span",{class:C(["material-symbols-rounded",{spinning:X.value}])},"refresh",2)],8,La)]),y.value||X.value?(a(),t("div",Wa,[...e[25]||(e[25]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):!((_s=r.value)!=null&&_s.git_available)||!((fs=$.value)!=null&&fs.is_git_repo)?(a(),t("div",Pa,[e[26]||(e[26]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,n((bs=r.value)!=null&&bs.git_available?"当前目录非 Git 仓库":"Git 环境不可用"),1)])):U.value.length?(a(),t("div",Na,[(a(!0),t(F,null,z(U.value,w=>(a(),t("div",{key:w.commit,class:C(["backup-item",{"is-current":w.is_current}])},[s("div",Ea,[s("div",Fa,[s("code",za,n(w.commit_short),1),w.is_current?(a(),t("span",Aa,"当前")):i("",!0)]),s("span",Oa,n(w.message),1),s("span",Xa,n(ds(w.timestamp)),1)]),s("div",ja,[s("button",{class:"m3-button text",onClick:K=>ws(w.commit),disabled:N.value},[...e[27]||(e[27]=[s("span",{class:"material-symbols-rounded"},"info",-1),s("span",null,"详情",-1)])],8,qa),s("button",{class:"m3-button text",onClick:K=>R(w.commit),disabled:L.value||w.is_current},[...e[28]||(e[28]=[s("span",{class:"material-symbols-rounded"},"restore",-1),s("span",null,"回滚",-1)])],8,Ha)])],2))),128))])):(a(),t("div",Ja,[...e[29]||(e[29]=[s("span",{class:"material-symbols-rounded"},"history_toggle_off",-1),s("span",null,"暂无历史版本",-1)])]))]),(a(),ls(os,{to:"body"},[m.value?(a(),t("div",{key:0,class:"detail-dialog-overlay",onClick:e[2]||(e[2]=ns(w=>m.value=!1,["self"]))},[s("div",Ka,[s("div",Qa,[e[31]||(e[31]=s("h3",null,"版本详情",-1)),s("button",{class:"m3-icon-button",onClick:e[1]||(e[1]=w=>m.value=!1)},[...e[30]||(e[30]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),k.value?(a(),t("div",Ya,[s("div",Za,[s("div",st,[e[32]||(e[32]=s("span",{class:"detail-label"},"Commit:",-1)),s("code",et,n(k.value.commit_short),1)]),s("div",at,[e[33]||(e[33]=s("span",{class:"detail-label"},"时间:",-1)),s("span",tt,n(ds(k.value.timestamp)),1)]),k.value.author?(a(),t("div",lt,[e[34]||(e[34]=s("span",{class:"detail-label"},"作者:",-1)),s("span",nt,n(k.value.author),1)])):i("",!0)]),k.value.message?(a(),t("div",ot,[e[35]||(e[35]=s("h4",null,"提交消息",-1)),s("p",it,n(k.value.message),1)])):i("",!0),k.value.body?(a(),t("div",ut,[e[36]||(e[36]=s("h4",null,"更新内容",-1)),s("pre",dt,n(k.value.body),1)])):i("",!0),(ys=k.value.files_changed)!=null&&ys.length?(a(),t("div",rt,[s("h4",null,"修改文件 ("+n(k.value.files_changed.length)+")",1),s("div",ct,[(a(!0),t(F,null,z(k.value.files_changed.slice(0,20),(w,K)=>(a(),t("div",{key:K,class:"file-item"},[s("span",{class:C(["file-status",Cs(w.status)])},n(w.status),3),s("span",vt,n(w.path),1)]))),128)),k.value.files_changed.length>20?(a(),t("div",mt," ... 及其他 "+n(k.value.files_changed.length-20)+" 个文件 ",1)):i("",!0)])])):i("",!0)])):N.value?(a(),t("div",pt,[...e[37]||(e[37]=[s("span",{class:"material-symbols-rounded spinning"},"progress_activity",-1),s("span",null,"加载中...",-1)])])):i("",!0)])])):i("",!0)]))])}}}),ft=ss(_t,[["__scopeId","data-v-8849b0d3"]]),bt={class:"git-settings-tab"},yt={class:"m3-card status-card"},gt={class:"card-header"},ht=["disabled"],kt={key:0,class:"status-grid"},$t={class:"status-item"},wt={class:"material-symbols-rounded"},Ct={key:0,class:"status-item"},Gt={class:"status-value"},xt={class:"status-item"},Tt={class:"status-value"},Ut={class:"status-item"},Dt={class:"status-value"},St={key:0,class:"m3-card path-card"},It={class:"path-content"},Bt={class:"path-display"},Vt={class:"path-value"},Mt={class:"path-actions"},Rt=["disabled"],Lt=["disabled"],Wt={key:0,class:"portable-tip"},Pt={key:2,class:"m3-card guide-card"},Nt={key:0,class:"guide-content"},Et={key:0,class:"guide-commands"},Ft={class:"command-name"},zt={class:"command-value"},At=["href"],Ot={class:"modal-content m3-card"},Xt={class:"modal-header"},jt={class:"modal-body"},qt={class:"input-wrapper"},Ht={class:"modal-footer"},Jt=["disabled"],Kt=Z({__name:"GitSettingsTab",setup(V,{expose:O}){const c=d(null),h=d(null),r=d(!1),$=d(!1),f=d(!1),U=d(!1),x=d(!1),G=d("");function y(v){return{custom:"自定义",portable:"便携版",system:"系统",unknown:"未知"}[v]||v}function T(){var o;switch((o=c.value)==null?void 0:o.system_os){case"Windows":return"下载便携版";case"Linux":return"安装 Git";case"Darwin":return"安装 Git";default:return"安装 Git"}}function _(){var o;switch((o=c.value)==null?void 0:o.system_os){case"Windows":return'未检测到 Git，可以点击上方"下载便携版"按钮安装';case"Linux":return'未检测到 Git，点击"安装 Git"将使用系统包管理器安装';case"Darwin":return'未检测到 Git，点击"安装 Git"将使用 Homebrew 或 Xcode 安装';default:return"未检测到 Git，请手动安装"}}async function p(){r.value=!0;try{const v=await $s();v.success&&v.data&&(c.value=v.data,!v.data.git_available&&v.data.system_os!=="Windows"&&I())}catch(v){console.error("加载 Git 状态失败:",v)}finally{r.value=!1}}async function I(){var v;try{const o=await ea();o.success&&((v=o.data)!=null&&v.data)&&(h.value=o.data.data)}catch(o){console.error("加载安装指南失败:",o)}}async function L(){var v,o;U.value=!0;try{const m=await sa();m.success&&((v=m.data)!=null&&v.success)?(J(m.data.message||"已检测到 Git"),await p()):S(((o=m.data)==null?void 0:o.error)||m.error||"未检测到 Git")}catch(m){S(m.message||"检测失败")}finally{U.value=!1}}async function X(){var v,o,m,k;if((v=c.value)!=null&&v.git_available){const B=(o=c.value)==null?void 0:o.system_os;let W=`检测到您的电脑已经安装了 Git。

`;if(B==="Windows"?W+="便携版 Git 适用于没有安装 Git 的用户，如果您已经有 Git，通常不需要再下载。":B==="Linux"?W+="系统将尝试使用包管理器重新安装 Git，这可能会覆盖现有版本。":B==="Darwin"&&(W+="系统将尝试使用 Homebrew 或 Xcode 安装 Git，这可能会覆盖现有版本。"),W+=`

确定要继续吗？`,!await Y({title:"确认安装",message:W,type:"warning",confirmText:"继续安装",cancelText:"取消"}))return}$.value=!0;try{const B=await Ye();B.success&&((m=B.data)!=null&&m.success)?(J(B.data.message||"Git 安装成功"),await L()):S(((k=B.data)==null?void 0:k.error)||B.error||"安装失败")}catch(B){S(B.message||"安装失败")}finally{$.value=!1}}async function N(){var v,o;if(G.value){f.value=!0;try{const m=await Ze(G.value);m.success&&((v=m.data)!=null&&v.success)?(J(m.data.message||"路径设置成功"),x.value=!1,G.value="",await p()):S(((o=m.data)==null?void 0:o.error)||m.error||"设置失败")}catch(m){S(m.message||"设置失败")}finally{f.value=!1}}}return ts(()=>{p()}),O({refresh:p}),(v,o)=>(a(),t("div",bt,[s("div",yt,[s("div",gt,[o[5]||(o[5]=s("span",{class:"material-symbols-rounded"},"terminal",-1)),o[6]||(o[6]=s("h3",null,"Git 环境状态",-1)),s("button",{class:"m3-icon-button",onClick:p,disabled:r.value},[s("span",{class:C(["material-symbols-rounded",{spinning:r.value}])},"refresh",2)],8,ht)]),c.value?(a(),t("div",kt,[s("div",$t,[o[7]||(o[7]=s("span",{class:"status-label"},"状态",-1)),s("span",{class:C(["status-value",c.value.git_available?"success":"error"])},[s("span",wt,n(c.value.git_available?"check_circle":"cancel"),1),ks(" "+n(c.value.git_available?"可用":"不可用"),1)],2)]),c.value.git_version?(a(),t("div",Ct,[o[8]||(o[8]=s("span",{class:"status-label"},"版本",-1)),s("span",Gt,n(c.value.git_version),1)])):i("",!0),s("div",xt,[o[9]||(o[9]=s("span",{class:"status-label"},"来源",-1)),s("span",Tt,[s("span",{class:C(["m3-badge",`source-${c.value.git_source}`])},n(y(c.value.git_source)),3)])]),s("div",Ut,[o[10]||(o[10]=s("span",{class:"status-label"},"操作系统",-1)),s("span",Dt,n(c.value.system_os),1)])])):i("",!0)]),c.value?(a(),t("div",St,[o[14]||(o[14]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"folder"),s("h3",null,"Git 路径")],-1)),s("div",It,[s("div",Bt,[o[11]||(o[11]=s("span",{class:"path-label"},"当前路径:",-1)),s("code",Vt,n(c.value.git_path||"未检测到"),1)]),s("div",Mt,[s("button",{class:"m3-button tonal",onClick:L,disabled:U.value},[s("span",{class:C(["material-symbols-rounded",{spinning:U.value}])},n(U.value?"progress_activity":"search"),3),s("span",null,n(U.value?"检测中...":"自动寻找"),1)],8,Rt),s("button",{class:"m3-button tonal",onClick:o[0]||(o[0]=m=>x.value=!0)},[...o[12]||(o[12]=[s("span",{class:"material-symbols-rounded"},"edit",-1),s("span",null,"设置路径",-1)])]),s("button",{class:C(["m3-button",c.value.git_available?"tonal":"filled"]),onClick:X,disabled:$.value},[s("span",{class:C(["material-symbols-rounded",{spinning:$.value}])},n($.value?"progress_activity":"download"),3),s("span",null,n($.value?"安装中...":T()),1)],10,Lt)]),c.value.git_available?i("",!0):(a(),t("div",Wt,[o[13]||(o[13]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,n(_()),1)]))])])):i("",!0),i("",!0),c.value&&!c.value.git_available&&c.value.system_os!=="Windows"?(a(),t("div",Pt,[o[18]||(o[18]=s("div",{class:"card-header"},[s("span",{class:"material-symbols-rounded"},"help"),s("h3",null,"安装指南")],-1)),h.value?(a(),t("div",Nt,[s("p",null,n(h.value.description),1),h.value.manual_commands?(a(),t("div",Et,[(a(!0),t(F,null,z(h.value.manual_commands,(m,k)=>(a(),t("div",{key:k,class:"command-item"},[s("span",Ft,n(k)+":",1),s("code",zt,n(m),1)]))),128))])):i("",!0),h.value.manual_url?(a(),t("a",{key:1,href:h.value.manual_url,target:"_blank",class:"m3-button tonal"},[...o[17]||(o[17]=[s("span",{class:"material-symbols-rounded"},"open_in_new",-1),s("span",null,"官方下载",-1)])],8,At)):i("",!0)])):i("",!0)])):i("",!0),(a(),ls(os,{to:"body"},[x.value?(a(),t("div",{key:0,class:"modal-overlay",onClick:o[4]||(o[4]=ns(m=>x.value=!1,["self"]))},[s("div",Ot,[s("div",Xt,[o[20]||(o[20]=s("h3",null,"设置 Git 路径",-1)),s("button",{class:"m3-icon-button",onClick:o[1]||(o[1]=m=>x.value=!1)},[...o[19]||(o[19]=[s("span",{class:"material-symbols-rounded"},"close",-1)])])]),s("div",jt,[o[21]||(o[21]=s("p",null,"请输入 Git 可执行文件的完整路径",-1)),s("div",qt,[as(s("input",{type:"text","onUpdate:modelValue":o[2]||(o[2]=m=>G.value=m),placeholder:"例如: C:\\Program Files\\Git\\bin\\git.exe",class:"m3-input"},null,512),[[Ms,G.value]])])]),s("div",Ht,[s("button",{class:"m3-button text",onClick:o[3]||(o[3]=m=>x.value=!1)},"取消"),s("button",{class:"m3-button filled",onClick:N,disabled:!G.value||f.value},n(f.value?"设置中...":"确定"),9,Jt)])])])):i("",!0)]))]))}}),Qt=ss(Kt,[["__scopeId","data-v-f68aa1d1"]]),Yt={key:0,class:"dialog-content m3-card"},Zt={class:"dialog-header"},sl={class:"material-symbols-rounded"},el={class:"dialog-body"},al={class:"dialog-message"},tl={key:0,class:"changelog-section"},ll={class:"changelog-list"},nl={class:"tip-section"},ol=Z({__name:"RestartDialog",props:{modelValue:{type:Boolean},updateType:{default:"main"},changelog:{default:()=>[]}},emits:["update:modelValue","restart","later"],setup(V,{emit:O}){const c=V,h=O,r=H(()=>({main:"type-main",ui:"type-ui",both:"type-both"})[c.updateType]),$=H(()=>({main:"smart_toy",ui:"web",both:"system_update"})[c.updateType]),f=H(()=>({main:"主程序更新完成",ui:"UI 更新完成",both:"全部更新完成"})[c.updateType]),U=H(()=>({main:"主程序已更新成功，需要重启才能生效。",ui:"WebUI 已更新成功，需要刷新页面才能生效。",both:"主程序和 WebUI 都已更新成功，需要重启才能生效。"})[c.updateType]),x=H(()=>c.updateType==="ui"?"刷新页面后将加载新版本的 WebUI":"重启后新功能将生效，当前的连接会暂时中断");function G(){h("restart"),h("update:modelValue",!1)}function y(){h("later"),h("update:modelValue",!1)}return(T,_)=>(a(),ls(os,{to:"body"},[Q(gs,{name:"fade"},{default:hs(()=>[V.modelValue?(a(),t("div",{key:0,class:"dialog-overlay",onClick:ns(y,["self"])},[Q(gs,{name:"scale"},{default:hs(()=>[V.modelValue?(a(),t("div",Yt,[s("div",Zt,[s("div",{class:C(["dialog-icon",r.value])},[s("span",sl,n($.value),1)],2),s("h2",null,n(f.value),1)]),s("div",el,[s("p",al,n(U.value),1),V.changelog&&V.changelog.length>0?(a(),t("div",tl,[_[0]||(_[0]=s("h4",null,"更新内容:",-1)),s("ul",ll,[(a(!0),t(F,null,z(V.changelog.slice(0,5),(p,I)=>(a(),t("li",{key:I},n(p),1))),128))])])):i("",!0),s("div",nl,[_[1]||(_[1]=s("span",{class:"material-symbols-rounded"},"info",-1)),s("span",null,n(x.value),1)])]),s("div",{class:"dialog-footer"},[s("button",{class:"m3-button text",onClick:y}," 稍后重启 "),s("button",{class:"m3-button filled",onClick:G},[..._[2]||(_[2]=[s("span",{class:"material-symbols-rounded"},"restart_alt",-1),s("span",null,"立即重启",-1)])])])])):i("",!0)]),_:1})])):i("",!0)]),_:1})]))}}),il=ss(ol,[["__scopeId","data-v-8bea0f4d"]]),ul={class:"update-view"},dl={class:"tabs-nav"},rl=["onClick"],cl={class:"material-symbols-rounded"},vl={class:"tab-label"},ml={class:"tab-content"},pl=Z({__name:"GitUpdateView",setup(V){const O=[{id:"ui",label:"UI 更新",icon:"web"},{id:"main",label:"主程序",icon:"terminal"},{id:"git",label:"Git 设置",icon:"settings"}],c=d("ui"),h=d(!1),r=d("main"),$=d([]);function f(y){y&&(r.value="ui",$.value=[],h.value=!0)}function U(y){y&&(r.value="main",$.value=[],h.value=!0)}async function x(){h.value=!1;try{await Ls()}catch(y){console.error("重启失败:",y)}}function G(){h.value=!1}return ts(()=>{}),(y,T)=>(a(),t("div",ul,[T[1]||(T[1]=Rs('<div class="page-header" data-v-8d4eeec6><div class="header-content" data-v-8d4eeec6><div class="header-icon" data-v-8d4eeec6><span class="material-symbols-rounded" data-v-8d4eeec6>system_update</span></div><div class="header-text" data-v-8d4eeec6><h1 data-v-8d4eeec6>更新管理</h1><p data-v-8d4eeec6>管理 MoFox-Bot 和 WebUI 的更新</p></div></div></div>',1)),s("div",dl,[(a(),t(F,null,z(O,_=>s("button",{key:_.id,class:C(["tab-item",{active:c.value===_.id}]),onClick:p=>c.value=_.id},[s("span",cl,n(_.icon),1),s("span",vl,n(_.label),1)],10,rl)),64))]),s("div",ml,[as(Q(Qe,{ref:"uiUpdateTabRef",onUpdateComplete:f},null,512),[[us,c.value==="ui"]]),as(Q(ft,{ref:"mainUpdateTabRef",onUpdateComplete:U},null,512),[[us,c.value==="main"]]),as(Q(Qt,{ref:"gitSettingsTabRef"},null,512),[[us,c.value==="git"]])]),Q(il,{modelValue:h.value,"onUpdate:modelValue":T[0]||(T[0]=_=>h.value=_),"update-type":r.value,changelog:$.value,onRestart:x,onLater:G},null,8,["modelValue","update-type","changelog"])]))}}),hl=ss(pl,[["__scopeId","data-v-8d4eeec6"]]);export{hl as default};
